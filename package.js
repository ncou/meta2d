"use strict";!function(scope){scope.module={exports:{}},scope.modules={},scope.modulesCached={},scope.modulesPath={},scope.process?scope.process.env={NODE_ENV:"dev"}:scope.process={env:{NODE_ENV:"dev"}},scope._inherits=function(a,b){var protoA=a.prototype,proto=Object.create(b.prototype);for(var key in protoA){var param=Object.getOwnPropertyDescriptor(protoA,key);param.get||param.set?Object.defineProperty(proto,key,param):proto[key]=protoA[key]}a.prototype=proto,a.prototype.constructor=a,a.__parent=b,void 0===b.__inherit&&(b.__inherit={}),b.__inherit[a.name]=a;for(var parent=b.__parent;parent;)parent.__inherit[a.name]=a,parent=parent.__parent}}(window||global),window.meta={version:"0.83 dev",importUrl:"http://meta2d.com/store/",device:null,resources:null,renderer:null,camera:null,input:null,physics:null,steering:null,channels:[],modules:{},loading:null,preloading:null,flags:{webGL:!0,audioAPI:!0,culling:!0},time:{delta:0,deltaF:0,maxDelta:250,scale:1,curr:0,fps:0,current:0,update:0,accumulator:0,frameIndex:0,updateFreq:100},cache:{width:0,height:0,metaTagsAdded:!1,timerIndex:0,createFuncs:[],initFuncs:[],preloadFuncs:[],loadFuncs:[],readyFuncs:[],view:null,views:{},scripts:null,pendingScripts:null,numScriptsToLoad:0,resolutions:null,currResolution:null,imageSmoothing:!0,infoView:null},set onCreate(func){this.cache.createFuncs.push(func),this.engine&&this.engine.inited&&func()},set onInit(func){this.cache.initFuncs.push(func),this.engine&&this.engine.inited&&func()},set onPreload(func){this.cache.preloadFuncs.push(func),this.engine&&this.engine.preloaded&&func()},set onLoad(func){this.cache.loadFuncs.push(func),this.engine&&this.engine.loaded&&func()},set onReady(func){this.cache.readyFuncs.push(func),this.engine&&this.engine.ready&&func()},set onUpdate(func){this.engine.updateFuncs.push(func)},set onRender(func){this.engine.renderFuncs.push(func)},set debug(value){this.cache.debug!==value&&(this.cache.debug=value,value?(meta.emit(meta.Event.DEBUG,value,meta.Event.DEBUG),meta.debugger.load()):(meta.emit(meta.Event.DEBUG,value,meta.Event.DEBUG),meta.debugger.unload()))},get debug(){return this.cache.debug},loadCfg:function(cfg){console.log(cfg)}},function(){function Extend(clsName,extend,prop,cb){for(var prevScope=null,scope=window,scopeBuffer=clsName.split("."),num=scopeBuffer.length-1,name=scopeBuffer[num],n=0;n<num;n++)prevScope=scope,(scope=scope[scopeBuffer[n]])||(scope={},prevScope[scopeBuffer[n]]=scope);var extendHolder=holders[clsName],prevCls=scope[name],cls=function(a,b,c,d,e,f){initializing||this.init&&this.init(a,b,c,d,e,f)},proto=null,extendProto=null;extend?(initializing=!0,proto=new extend,extendProto=proto.__proto__,initializing=!1):(initializing=!0,proto=new meta.class,initializing=!1);for(var key in prop){var p=Object.getOwnPropertyDescriptor(prop,key);p.get||p.set?Object.defineProperty(proto,key,p):extend&&"function"==typeof prop[key]&&"function"==typeof extendProto[key]&&fnTest.test(prop[key])?proto[key]=function(key,fn){return function(a,b,c,d,e,f){var tmp=this._super;this._super=extendProto[key],this._fn=fn;var ret=this._fn(a,b,c,d,e,f);return this._super=tmp,ret}}(key,prop[key]):proto[key]=prop[key]}if(cls.prototype=proto,cls.prototype.__name__=clsName,cls.prototype.__lastName__=name,cls.prototype.constructor=proto.init||null,scope[name]=cls,prevCls)for(var key in prevCls)cls[key]=prevCls[key];if(extendHolder){var extendItem=null,classes=extendHolder.classes;for(num=classes.length,n=0;n<num;n++)Extend((extendItem=classes[n]).name,cls,extendItem.prop,extendItem.cb);delete holders[clsName]}cb&&cb(cls,clsName)}function ExtendHolder(){this.classes=[]}function ExtendItem(name,prop,cb){this.name=name,this.prop=prop,this.cb=cb}var initializing=!1,fnTest=/\b_super\b/,holders={};meta.class=function(clsName,extendName,prop,cb){initializing||meta.class._construct(clsName,extendName,prop,cb)},meta.class._construct=function(clsName,extendName,prop,cb){if(clsName){prop||(prop=extendName,extendName=null),prop||(prop={});var extend=null;if(extendName){for(var prevScope=null,extendScope=window,extendScopeBuffer=extendName.split("."),num=extendScopeBuffer.length-1,n=0;n<num;n++)prevScope=extendScope,(extendScope=extendScope[extendScopeBuffer[n]])||(extendScope={},prevScope[extendScopeBuffer[n]]=extendScope);if(!(extend=extendScope[extendScopeBuffer[num]])){var holder=holders[extendName];return holder||(holder=new ExtendHolder,holders[extendName]=holder),void holder.classes.push(new ExtendItem(clsName,prop,cb))}}Extend(clsName,extend,prop,cb)}else console.error("(meta.class) Invalid class name")},meta.classLoaded=function(){var i=0,holder=null,classes=null,numClasses=0;for(var key in holders)for(holder=holders[key],console.error("Undefined class: "+key),numClasses=(classes=holder.classes).length,i=0;i<numClasses;i++)console.error("Undefined class: "+classes[i].name);holder={}}}(),function(){meta.engine={create:function(){this.onCreate(),this.parseFlags(),this._createRenderer(),this._printInfo(),this.autoMetaTags&&this._addMetaTags();var self=this;this.cb={resize:function(event){self.updateResolution()},focus:function(event){self.handleFocus(!0)},blur:function(event){self.handleFocus(!1)}},window.addEventListener("resize",this.cb.resize,!1),window.addEventListener("orientationchange",this.cb.resize,!1),meta.device.hidden&&(this.cb.visibilityChange=function(){self.handleVisibilityChange()},document.addEventListener(meta.device.visibilityChange,this.cb.visibilityChange)),window.addEventListener("focus",this.cb.focus),window.addEventListener("blur",this.cb.blur),meta.device.support.fullScreen&&(this.cb.fullscreen=function(){self.onFullScreenChangeCB()},document.addEventListener(meta.device.fullScreenOnChange,this.cb.fullscreen)),meta.camera=new meta.Camera,meta.world=new meta.World(0,0),meta.resources=new Resource.Manager,meta.input=new Input.Manager,meta.physics=new Physics.Manager,meta.steering=new Steering.Manager;var resources=meta.resources;resources.onLoadingStart.add(this.onLoadingStart,this),resources.onLoadingEnd.add(this.onLoadingEnd,this),this._initAll()},onCreate:function(){this.onUpdate=meta.createChannel(meta.Event.UPDATE),this.onResize=meta.createChannel(meta.Event.RESIZE),this.onAdapt=meta.createChannel(meta.Event.ADAPT),this.onBlur=meta.createChannel(meta.Event.BLUR),this.onFocus=meta.createChannel(meta.Event.FOCUS),this.onFullscreen=meta.createChannel(meta.Event.FULLSCREEN),this.onDebug=meta.createChannel(meta.Event.DEBUG);for(var createFuncs=meta.cache.createFuncs,num=createFuncs.length,n=0;n<num;n++)createFuncs[n]();meta.cache.createFuncs=null,this._container||(this._container=document.body),this._container.style.cssText=this.elementStyle},parseFlags:function(){for(var flag,flagName,flagValue,flagSepIndex,flags=window.location.hash.substr(1).split(","),num=flags.length,n=0;n<num;n++)flag=flags[n],(flagSepIndex=flag.indexOf("="))>0&&(flagName=flag.substr(0,flagSepIndex).replace(/ /g,""),flagValue=eval(flag.substr(flagSepIndex+1).replace(/ /g,"")),meta.flags[flagName]=flagValue)},_initAll:function(){this.time.current=Date.now();var cache=meta.cache,masterView=new meta.View("master");cache.views.master=masterView,cache.view=masterView;for(var ctrlInfo,ctrlsToCreate=cache.ctrlsToCreate,num=ctrlsToCreate.length,n=0;n<num;n++)(ctrlInfo=ctrlsToCreate[n]).scope[ctrlInfo.cls.prototype.name]=new ctrlInfo.cls;for(cache.ctrlsToCreate=null,num=cache.initFuncs.length,n=0;n<num;n++)cache.initFuncs[n]();cache.initFuncs=null,console.log(" "),this.flags|=this.Flag.INITED,this._loadAll()},_loadAll:function(){meta._loadAllScripts()||this._handlePreload()},_handlePreload:function(){this.meta.renderer.load(),this.meta.input.onDown.add(this.handleKeyDown,this);for(var cache=meta.cache,numFuncs=cache.preloadFuncs.length,i=0;i<numFuncs;i++)cache.preloadFuncs[i]();var masterView=meta.cache.view;masterView.flags|=masterView.Flag.ACTIVE,masterView._activate(),this._startMainLoop(),meta.resources.loading||this._handleLoad()},_handleLoad:function(){this.flags|=this.Flag.PRELOADED;for(var cache=meta.cache,numFuncs=cache.loadFuncs.length,i=0;i<numFuncs;i++)cache.loadFuncs[i]();this.loadPlugins(),meta.resources.loading||this._handleReady()},_handleReady:function(){if(!(this.flags&this.Flag.READY)){this.flags|=this.Flag.LOADED,this.readyPlugins();for(var numFuncs=meta.cache.readyFuncs.length,i=0;i<numFuncs;i++)meta.cache.readyFuncs[i]();this.flags|=this.Flag.READY,meta.renderer.needRender=!0}},loadPlugins:function(){for(var num=this.plugins.length,n=0;n<num;n++)this.plugins[n].load()},readyPlugins:function(){for(var num=this.plugins.length,n=0;n<num;n++)this.plugins[n].ready()},_startMainLoop:function(){var self=this;this._renderLoop=function(){self.render()},this.render()},update:function(tDelta){var n,num;if(this._updateTimers(meta.time.delta),this.flags&this.Flag.READY&&(num=this.controllersReady.length)>0&&!this.meta.resources.loading){var controller;for(n=0;n<this.controllersReady.length;n++)(controller=this.controllersReady[n]).flags&controller.Flag.LOADED&&controller.ready();this.controllersReady.length=0}if(this.flags&this.Flag.LOADED){for(num=this.updateFuncs.length,n=0;n<num;n++)this.updateFuncs[n](tDelta);for(num=this.controllersUpdate.length,n=0;n<num;n++)this.controllersUpdate[n].onUpdate(tDelta);this.onUpdate.emit(tDelta)}this.meta.renderer.update(tDelta),this.meta.camera.update(tDelta)},render:function(){this.time.frameIndex++;var tNow=Date.now();this.time.pause?(this.time.delta=0,this.time.deltaF=0):(this.time.delta=tNow-this.time.current,this.time.delta>this.time.maxDelta&&(this.time.delta=this.time.maxDelta),this.time.delta*=this.time.scale,this.time.deltaF=this.time.delta/1e3,this.time.accumulator+=this.time.delta),tNow-this.time.fps>=1e3&&(this.time.fps=tNow,this.fps=this._fpsCounter,this._fpsCounter=0),this.update(this.time.deltaF),meta.renderer.render(this.time.deltaF);for(var num=this.renderFuncs.length,n=0;n<num;n++)this.renderFuncs[n](this.time.tDeltaF);this._fpsCounter++,this.time.current=tNow,requestAnimationFrame(this._renderLoop)},_updateTimers:function(tDelta){var timer,numTimers=this.timers.length,numRemove=this.timersRemove.length;if(numRemove>0){var itemsLeft=numTimers-numRemove;if(itemsLeft>0)for(var index,n=0;n<numRemove;n++)(index=this.timers.indexOf(this.timersRemove[n]))<itemsLeft?this.timers.splice(index,1):this.timers.pop();else this.timers.length=0;numTimers=itemsLeft,this.timersRemove.length=0}for(n=0;n<numTimers;n++)if(!(timer=this.timers[n]).paused)for(timer.tAccumulator+=tDelta;timer.tAccumulator>=timer.tDelta;)if(timer.tAccumulator-=timer.tDelta,0!==timer.numTimes&&timer.func.call(timer.owner,timer),timer.tStart+=timer.tDelta,-1!==timer.numTimes&&(timer.numTimes--,timer.numTimes<=0)){this.timersRemove.push(timer),timer.__index=-1;break}},sortAdaptions:function(){var scope=meta,resolutions=scope.cache.resolutions;if(resolutions){var numResolutions=resolutions.length;if(!(numResolutions<=1)){resolutions.sort(function(a,b){return scope.math.length2(a.width,a.height)-scope.math.length2(b.width,b.height)});for(var reso,prevReso,lowestResolution=resolutions[0],i=1;i<numResolutions;i++)prevReso=resolutions[i-1],(reso=resolutions[i]).unitSize=reso.height/lowestResolution.height,reso.zoomThreshold=prevReso.unitSize+(reso.unitSize-prevReso.unitSize)/100*33;meta.maxUnitSize=resolutions[numResolutions-1].unitSize,meta.maxUnitRatio=1/meta.maxUnitSize,scope.camera.bounds(lowestResolution.width,lowestResolution.height)}}},adaptResolution:function(){var scope=meta,resolutions=scope.cache.resolutions;if(!resolutions)return!1;var numResolutions=resolutions.length;if(numResolutions<1)return!1;for(var resolution,newResolution=resolutions[0],zoom=scope.camera.zoom,i=numResolutions-1;i>=0;i--)if(resolution=resolutions[i],zoom>=resolution.zoomThreshold){newResolution=resolution;break}return newResolution===scope.cache.currResolution||(scope.cache.currResolution=newResolution,scope.unitSize=newResolution.unitSize,scope.unitRatio=1/scope.unitSize,this.onAdapt.emit(newResolution,meta.Event.ADAPT),!0)},handleKeyDown:function(data,event){switch(data.keyCode){case Input.Key.TILDE:meta.debug=!meta.cache.debug,meta.renderer.needRender=!0}},onLoadingStart:function(data,event){this.flags|=this.Flag.LOADING;var state;this.preloaded?(state="Loading",meta.loading.load()):(state="Preloading",meta.preloading.load()),meta.device.support.consoleCSS?console.log("%c("+state+" started)","background: #eee; font-weight: bold;"):console.log("("+state+" started)")},onLoadingEnd:function(data,event){this.flags&=~this.Flag.LOADING;var state;this.preloaded?(state="Loading",meta.loading.unload()):(state="Preloading",meta.preloading.unload()),meta.device.support.consoleCSS?console.log("%c("+state+" ended)","background: #eee; font-weight: bold;"):console.log("("+state+" ended)"),this.preloaded?this._handleReady():this._handleLoad(),meta.renderer.needRender=!0},onScriptLoadingEnd:function(){this._handlePreload()},updateLoading:function(){this.loading||this.scriptLoading||this._ready()},updateResolution:function(){this._resize(this.meta.cache.width,this.meta.cache.height)},resize:function(width,height){var cache=this.meta.cache;cache.width=width||0,cache.height=height||0,this._resize(cache.width,cache.height)},_resize:function(){var width=this.meta.cache.width,height=this.meta.cache.height,containerWidth=0,containerHeight=0;if(this._container===document.body?(containerWidth=window.innerWidth,containerHeight=window.innerHeight):(containerWidth=this._container.clientWidth,containerHeight=this._container.clientHeight),0===width&&(width=containerWidth),0===height&&(height=containerHeight),this._adapt){this.zoom=1;var diffX=containerWidth-width,diffY=containerHeight-height;this.zoom=diffX<diffY?containerWidth/width:containerHeight/height,width*=this.zoom,height*=this.zoom}if(width=Math.round(width),height=Math.round(height),this.canvas){var ratio=(window.devicePixelRatio||1)/(this.ctx.webkitBackingStorePixelRatio||this.ctx.mozBackingStorePixelRatio||this.ctx.msBackingStorePixelRatio||this.ctx.oBackingStorePixelRatio||this.ctx.backingStorePixelRatio||1);this.width=Math.ceil(width*ratio),this.height=Math.ceil(height*ratio),this.canvas.width=this.width,this.canvas.height=this.height,this.canvas.style.width=width*this.scaleX+"px",this.canvas.style.height=height*this.scaleY+"px",this._center&&(this.canvas.style.left=Math.floor(.5*(window.innerWidth-width*this.scaleX))+"px",this.canvas.style.top=Math.floor(.5*(window.innerHeight-height*this.scaleY))+"px"),this.updateImageSmoothing(),this._updateOffset(),this.onResize.emit(this,meta.Event.RESIZE),meta.renderer.needRender=!0}},scale:function(scaleX,scaleY){this.scaleX=scaleX||1,this.scaleY=scaleY||this.scaleX,this._resize(this.meta.cache.width,this.meta.cache.height)},handleFocus:function(value){this.focus!==value&&(this.focus=value,this.enablePauseOnBlur&&(this.pause=!value),value?this.onFocus.emit(value,meta.Event.FOCUS):this.onBlur.emit(value,meta.Event.BLUR))},handleVisibilityChange:function(){document[meta.device.hidden]?this.handleFocus(!1):this.handleFocus(!0)},onFullScreenChangeCB:function(){var fullscreen=document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement;meta.device.fullscreen=!!fullscreen,this.onFullscreen.emit(meta.device.fullscreen,meta.Event.FULLSCREEN)},onCtxLost:function(){console.log("(Context lost)")},onCtxRestored:function(){console.log("(Context restored)")},_addMetaTags:function(){if(!this.metaTagsAdded){var contentType=document.createElement("meta");contentType.setAttribute("http-equiv","Content-Type"),contentType.setAttribute("content","text/html; charset=utf-8"),document.head.appendChild(contentType);var encoding=document.createElement("meta");encoding.setAttribute("http-equiv","encoding"),encoding.setAttribute("content","utf-8"),document.head.appendChild(encoding);var viewport=document.createElement("meta");viewport.setAttribute("name","viewport"),viewport.setAttribute("content","user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height"),document.head.appendChild(viewport);var appleMobileCapable=document.createElement("meta");appleMobileCapable.setAttribute("name","apple-mobile-web-app-capable"),appleMobileCapable.setAttribute("content","yes"),document.head.appendChild(appleMobileCapable);var appleStatusBar=document.createElement("meta");appleStatusBar.setAttribute("name","apple-mobile-web-app-status-bar-style"),appleStatusBar.setAttribute("content","black-translucent"),document.head.appendChild(appleStatusBar),this.metaTagsAdded=!0}},_createRenderer:function(){this.canvas=document.createElement("canvas"),this.canvas.setAttribute("id","meta-canvas"),this.canvas.style.cssText=this.canvasStyle,meta.renderer=new meta.CanvasRenderer,this.updateResolution(),this._container?this._container.appendChild(this.canvas):document.body.appendChild(this.canvas)},_updateOffset:function(){this.offsetLeft=0,this.offsetTop=0;var element=this._container;if(element.offsetParent)do{this.offsetLeft+=element.offsetLeft,this.offsetTop+=element.offsetTop}while(element=element.offsetParent);var rect=this._container.getBoundingClientRect();this.offsetLeft+=rect.left,this.offsetTop+=rect.top,rect=this.canvas.getBoundingClientRect(),this.offsetLeft+=rect.left,this.offsetTop+=rect.top},_printInfo:function(){meta.device.support.consoleCSS?(console.log("%c META2D v"+meta.version+" ","background: #000; color: white; font-size: 12px; padding: 2px 0 1px 0;","http://meta2d.com"),console.log("%cBrowser: %c"+meta.device.name+" "+meta.device.version+"\t","font-weight: bold; padding: 2px 0 1px 0;","padding: 2px 0 1px 0;"),console.log("%cRenderer: %cCanvas ","font-weight: bold; padding: 2px 0 2px 0;","padding: 2px 0 2px 0;")):(console.log("META2D v"+meta.version+" http://meta2d.com "),console.log("Browser: "+meta.device.name+" "+meta.device.version+"\t"),console.log("Renderer: Canvas "))},fullscreen:function(value){var device=meta.device;if(device.fullscreen!==value)if(value){if(!device.support.fullScreen)return void console.warn("(meta.engine.fullscreen): Device does not support fullscreen mode");console.log(device.fullScreenRequest),document.documentElement[device.fullScreenRequest](Element.ALLOW_KEYBOARD_INPUT)}else console.log("exit"),document[meta.device.fullScreenExit]()},toggleFullscreen:function(){this.fullscreen(!meta.device.fullscreen)},set container(element){this._container!==element&&(this._container&&this._container.removeChild(this.canvas),this._container=element||document.body,this.canvas&&(this._container.appendChild(this.canvas),this.updateResolution()))},get container(){return this._container},updateImageSmoothing:function(){this.ctx.imageSmoothingEnabled?this.ctx.imageSmoothingEnabled=meta.cache.imageSmoothing:this.ctx[meta.device.vendor+"ImageSmoothingEnabled"]=meta.cache.imageSmoothing},set imageSmoothing(value){meta.cache.imageSmoothing=value,this.inited&&this.updateImageSmoothing()},get imageSmoothing(){return meta.cache.imageSmoothing},set cursor(value){this._container.style.cursor=value},get cursor(){return this._container.style.cursor},set center(value){this._center=value,this.updateResolution()},get center(){return this._center},set adapt(value){this._adapt=value,this.updateResolution()},get adapt(){return this._adapt},get inited(){return(this.flags&this.Flag.INITED)===this.Flag.INITED},get loading(){return(this.flags&this.Flag.LOADING)===this.Flag.LOADING},get preloaded(){return(this.flags&this.Flag.PRELOADED)===this.Flag.PRELOADED},get loaded(){return(this.flags&this.Flag.LOADED)===this.Flag.LOADED},get ready(){return(this.flags&this.Flag.READY)===this.Flag.READY},Flag:{LOADING:1,INITED:2,PRELOADED:4,LOADED:8,READY:16},onUpdate:null,onResize:null,onBlur:null,onFocus:null,onFullscreen:null,onDebug:null,elementStyle:"padding:0; margin:0;",canvasStyle:"position:absolute; overflow:hidden; translateZ(0); -webkit-backface-visibility:hidden; -webkit-perspective: 1000; -webkit-touch-callout: none; -webkit-user-select: none; zoom: 1;",meta:meta,time:meta.time,_container:null,width:0,height:0,offsetLeft:0,offsetTop:0,scaleX:1,scaleY:1,zoom:1,ratio:1,canvas:null,ctx:null,cb:null,autoInit:!0,autoMetaTags:!0,flags:0,focus:!1,pause:!1,webgl:!1,_center:!1,_adapt:!1,_updateLoop:null,_renderLoop:null,updateFuncs:[],renderFuncs:[],plugins:[],controllersReady:[],controllersUpdate:[],timers:[],timersRemove:[],fps:0,_fpsCounter:0,enablePauseOnBlur:!0,enableAdaptive:!0,unitSize:1,unitRatio:1,maxUnitSize:1,maxUnitRatio:1}}(),meta.Device=function(){this.name="unknown",this.version="0",this.versionBuffer=null,this.vendors=["","webkit","moz","ms","o"],this.vendor="",this.support={},this.audioFormats=[],this.mobile=!1,this.isPortrait=!1,this.audioAPI=!1,this.hidden=null,this.visibilityChange=null,this.fullScreenRequest=null,this.fullScreenExit=null,this.fullScreenOnChange=null,this.fullscreen=!1,this.load()},meta.Device.prototype={load:function(){this.checkBrowser(),this.mobile=this.isMobileAgent(),this.checkConsoleCSS(),this.checkFileAPI(),this.support.onloadedmetadata="object"==typeof window.onloadedmetadata,this.support.onkeyup="object"==typeof window.onkeyup,this.support.onkeydown="object"==typeof window.onkeydown,this.support.canvas=this.isCanvasSupport(),this.support.webgl=this.isWebGLSupport(),this.modernize()},checkBrowser:function(){var name,currRegexp,match,regexps={Chrome:[/Chrome\/(\S+)/],Firefox:[/Firefox\/(\S+)/],MSIE:[/MSIE (\S+);/],Opera:[/OPR\/(\S+)/,/Opera\/.*?Version\/(\S+)/,/Opera\/(\S+)/],Safari:[/Version\/(\S+).*?Safari\//]},userAgent=navigator.userAgent,numElements=2;for(name in regexps)for(;currRegexp=regexps[name].shift();)if(match=userAgent.match(currRegexp)){this.version=match[1].match(new RegExp("[^.]+(?:.[^.]+){0,"+--numElements+"}"))[0],this.name=name,this.versionBuffer=this.version.split(".");for(var versionBufferLength=this.versionBuffer.length,i=0;i<versionBufferLength;i++)this.versionBuffer[i]=parseInt(this.versionBuffer[i]);break}null===this.versionBuffer||"unknown"===this.name?console.warn("(meta.Device.checkBrowser) Could not detect browser."):"Chrome"===this.name||"Safari"===this.name||"Opera"===this.name?this.vendor="webkit":"Firefox"===this.name?this.vendor="moz":"MSIE"===this.name&&(this.vendor="ms")},checkConsoleCSS:function(){this.mobile||"Chrome"!==this.name&&"Opera"!==this.name?this.support.consoleCSS=!1:this.support.consoleCSS=!0},checkFileAPI:function(){window.File&&window.FileReader&&window.FileList&&window.Blob?this.support.fileAPI=!0:this.support.fileAPI=!1},modernize:function(){Number.MAX_SAFE_INTEGER||(Number.MAX_SAFE_INTEGER=9007199254740991),this.supportConsole(),this.supportPageVisibility(),this.supportFullScreen(),this.supportRequestAnimFrame(),this.supportPerformanceNow(),this.supportAudioFormats(),this.supportAudioAPI(),this.supportFileSystemAPI()},isMobileAgent:function(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)},isCanvasSupport:function(){return!!window.CanvasRenderingContext2D},isWebGLSupport:function(){var canvas=document.createElement("canvas");return!!(canvas.getContext("webgl")||canvas.getContext("experimental-webgl"))},supportConsole:function(){window.console||(window.console={},window.console.log=meta.emptyFuncParam,window.console.warn=meta.emptyFuncParam,window.console.error=meta.emptyFuncParam)},supportPageVisibility:function(){void 0!==document.hidden?(this.hidden="hidden",this.visibilityChange="visibilitychange"):void 0!==document.hidden?(this.hidden="webkitHidden",this.visibilityChange="webkitvisibilitychange"):void 0!==document.hidden?(this.hidden="mozhidden",this.visibilityChange="mozvisibilitychange"):void 0!==document.hidden&&(this.hidden="mshidden",this.visibilityChange="msvisibilitychange")},supportFullScreen:function(){this._fullScreenRequest(),this._fullScreenExit(),this._fullScreenOnChange(),this.support.fullScreen=document.fullscreenEnabled||document.mozFullScreenEnabled||document.webkitFullscreenEnabled||document.msFullscreenEnabled},_fullScreenRequest:function(){var element=document.documentElement;void 0!==element.requestFullscreen?this.fullScreenRequest="requestFullscreen":void 0!==element.webkitRequestFullscreen?this.fullScreenRequest="webkitRequestFullscreen":void 0!==element.mozRequestFullScreen?this.fullScreenRequest="mozRequestFullScreen":void 0!==element.msRequestFullscreen&&(this.fullScreenRequest="msRequestFullscreen")},_fullScreenExit:function(){void 0!==document.exitFullscreen?this.fullScreenExit="exitFullscreen":void 0!==document.webkitExitFullscreen?this.fullScreenExit="webkitExitFullscreen":void 0!==document.mozCancelFullScreen?this.fullScreenExit="mozCancelFullScreen":void 0!==document.msExitFullscreen&&(this.fullScreenExit="msExitFullscreen")},_fullScreenOnChange:function(){void 0!==document.onfullscreenchange?this.fullScreenOnChange="fullscreenchange":void 0!==document.onwebkitfullscreenchange?this.fullScreenOnChange="webkitfullscreenchange":void 0!==document.onmozfullscreenchange?this.fullScreenOnChange="mozfullscreenchange":void 0!==document.onmsfullscreenchange&&(this.fullScreenOnChange="msfullscreenchange")},supportRequestAnimFrame:function(){window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback,element){window.setTimeout(callback,1e3/60)})},supportPerformanceNow:function(){void 0===window.performance&&(window.performance={}),void 0===window.performance.now&&(window.performance.now=Date.now)},supportAudioFormats:function(){var audio=document.createElement("audio");audio.canPlayType("audio/mp4")&&this.audioFormats.push("m4a"),audio.canPlayType("audio/ogg")&&this.audioFormats.push("ogg"),audio.canPlayType("audio/mpeg")&&this.audioFormats.push("mp3"),audio.canPlayType("audio/wav")&&this.audioFormats.push("wav")},supportAudioAPI:function(){window.AudioContext||(window.AudioContext=window.webkitAudioContext||window.mozAudioContext||window.oAudioContext||window.msAudioContext),window.AudioContext&&(this.audioAPI=!0)},supportFileSystemAPI:function(){window.requestFileSystem||(window.requestFileSystem=window.webkitRequestFileSystem||window.mozRequestFileSystem||window.oRequestFileSystem||window.msRequestFileSystem),window.requestFileSystem&&(this.support.fileSystemAPI=!0)}},meta.device=new meta.Device,meta.device.mobile&&(window.onerror=function(message,file,lineNumber){alert(file+": "+lineNumber+" "+message)}),meta.emptyFunc=function(){},meta.emptyFuncParam=function(param){},meta.enumNames=function(baseName,mask,min,max){for(var numbers,names=new Array(max-min),maskLength=mask.length,n=min;n<=max;n++)numbers=Math.floor(n/10),names[n]=baseName+mask.substr(0,maskLength-numbers-1)+n;return names},meta.getNameFromPath=function(path){var wildcardIndex=path.lastIndexOf("."),slashIndex=path.lastIndexOf("/");return wildcardIndex<0||path.length-wildcardIndex>5?path.slice(slashIndex+1):path.slice(slashIndex+1,wildcardIndex)},meta.randomItem=function(array){return array[meta.random.number(0,array.length-1)]},meta.loadFile=function(file,tag){return file instanceof File||console.warn("(meta.loadFile) Invalid file has been passed."),new Resource.Texture(file,tag)},meta.onDomLoad=function(func){if("interactive"!==document.readyState&&"complete"!==document.readyState){var cbFunc=function(event){func(),window.removeEventListener("DOMContentLoaded",cbFunc)};window.addEventListener("DOMContentLoaded",cbFunc)}else func()},meta.enumToString=function(buffer,value){if(void 0===buffer)return"unknown";for(var enumKey in buffer)if(buffer[enumKey]===value)return enumKey;return"unknown"},meta.hexToRgb=function(hex){hex.length<6&&(hex+=hex.substr(1,4));var result=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);return{r:parseInt(result[1],16),g:parseInt(result[2],16),b:parseInt(result[3],16)}},meta.isUrl=function(str){return-1!==str.indexOf("http://")||-1!==str.indexOf("https://")},meta.toUpperFirstChar=function(str){return str.charAt(0).toUpperCase()+str.slice(1)},meta.serialize=function(obj){var str=[];for(var key in obj)str.push(encodeURIComponent(key)+"="+encodeURIComponent(obj[key]));return str.join("&")},meta.info=function(text){var holder,texture,msg;if(meta.cache.infoView){texture=(holder=meta.cache.infoView.entities[0]).texture,(msg=holder.children[0]).text=text;var width=msg.width,height=msg.height+10;texture.resize(width,height),texture.fillRect(0,0,width,height)}else meta.cache.infoView=new meta.View("meta.info"),meta.cache.infoView.static=!0,(msg=new Entity.Text(text)).anchor(.5),msg.pivot(.5),(texture=new Resource.SVG).fillStyle="black",texture.fillRect(0,0,msg.width+10,msg.height+10),(holder=new Entity.Geometry(texture)).z=999999,holder.pivot(.5,0),holder.anchor(.5,0),holder.position(0,10),holder.attach(msg),meta.cache.infoView.attach(holder),meta.view.attachView(meta.cache.infoView)},meta.adaptTo=function(width,height,path){if(meta.engine&&meta.engine.isInited)console.warn("[meta.adaptTo]:","Only usable before engine is initialized.");else{var resolutions=meta.cache.resolutions;resolutions||(resolutions=[],meta.cache.resolutions=resolutions),"/"!==path.charAt(path.length-1)&&(path+="/");var newRes={width:width,height:height,path:path,unitSize:1,zoomThreshold:1};resolutions.push(newRes)}},meta.removeFromArray=function(item,array){for(var numItems=array.length,i=0;i<numItems;i++)if(item===array[i]){array[i]=array[numItems-1],array.pop();break}},meta.shuffleArray=function(array){for(var temp,item,rand=meta.random,length=array.length;length;)item=rand.number(0,--length),temp=array[length],array[length]=array[item],array[item]=temp;return array},meta.shuffleArrayRange=function(array,endRange,startRange){for(var temp,item,startRange=startRange||0,rand=meta.random;endRange>startRange;)item=rand.number(0,--endRange),temp=array[endRange],array[endRange]=array[item],array[item]=temp;return array},meta.mapArray=function(array){for(var obj={},num=array.length,n=0;n<num;n++)obj[array[n]]=n;return obj},meta.rotateArray=function(array){for(var tmp=array[0],numItems=array.length-1,i=0;i<numItems;i++)array[i]=array[i+1];array[numItems]=tmp},meta.nextPowerOfTwo=function(value){return value--,value|=value>>1,value|=value>>2,value|=value>>4,value|=value>>8,value|=value>>16,++value},meta.toHex=function(c){var hex=c.toString(16);return 1==hex.length?"0"+hex:hex},meta.rgbToHex=function(r,g,b){return"#"+((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1)},meta.isSpace=function(c){return" "===c||"\t"===c||"\r"===c||"\n"===c},meta.isNewline=function(c){return"\r"===c||"\n"===c},meta.isDigit=function(c){return c>="0"&&c<="9"||"."===c},meta.isAlpha=function(c){return c>="a"&&c<="z"||c>="A"&&c<="Z"||"_"==c&&c<="$"},meta.isAlphaNum=function(c){return c>="a"&&c<="z"||c>="A"&&c<="Z"||c>="0"&&c<="9"||"_"===c||"$"===c},meta.isBinOp=function(c){return"="===c||"!"===c||"<"===c||">"===c||"+"===c||"-"===c||"*"===c||"/"===c||"&"===c||"~"===c||"|"===c||"%"===c},meta.getClsFromPath=function(path){for(var scope=window,num=path.length,i=0;i<num;i++)if(!(scope=scope[path[i]]))return null;return null},meta.decodeBinaryBase64=function(content){for(var decodedData=atob(content),size=decodedData.length,data=new Array(size/4),n=0,i=0;n<size;n+=4,i++)data[i]=decodedData.charCodeAt(n)|decodedData.charCodeAt(n+1)<<8|decodedData.charCodeAt(n+2)<<16|decodedData.charCodeAt(n+3)<<24;return data},meta.Channel=function(name){this.name=name,this.subs=[],this.numSubs=0,this._emitting=!1,this._subsToRemove=null},meta.Channel.prototype={emit:function(data,event){this._emitting=!0;for(var sub,i=0;i<this.numSubs;i++)(sub=this.subs[i]).func.call(sub.owner,data,event);if(this._emitting=!1,this._subsToRemove){for(var numToRemove=this._subsToRemove.length,n=0;n<numToRemove;n++)this.remove(this._subsToRemove[n]);this._subsToRemove=null}},add:function(func,owner,priority){if(priority=priority||0,!func)return console.warn("(meta.Channel.subscribe) No valid callback function passed."),!1;for(var i=0;i<this.numSubs;i++)if(this.subs[i].owner===owner)return!1;var newSub=new meta.Subscriber(owner,func,priority);return this.subs.push(newSub),this.numSubs++,priority?(this._havePriority=!0,this.subs.sort(this._sortFunc)):this._havePriority&&this.subs.sort(this._sortFunc),!0},remove:function(owner){if(null===owner||void 0===owner)meta.channels[this.name]=null;else{if(this._emitting)return this._subsToRemove||(this._subsToRemove=[]),void this._subsToRemove.push(owner);for(var i=0;i<this.numSubs;i++)if(this.subs[i].owner===owner){this.subs[i]=this.subs[this.numSubs-1],this.subs.pop(),this.numSubs--;break}this._havePriority&&this.subs.sort(this._sortFunc)}},removeAll:function(){this.subs=[],this.numSubs=0},_sortFunc:function(a,b){return a.priority>b.priority?-1:1},_havePriority:!1},meta.Subscriber=function(owner,func,priority){this.owner=owner,this.func=func,this.priority=priority},meta.createChannel=function(name){if(!name)return console.warn("(meta.createChannel) No name was specified!"),null;var channel=meta.channels[name];return channel||(channel=new meta.Channel(name),meta.channels[name]=channel),channel},meta.releaseChannel=function(name){name?meta.channels[name]&&(meta.channels[name]=null):console.warn("(meta.releaseChannel) No name was specified!")},meta.subscribe=function(channel,func,owner,priority){if("object"==typeof owner)if(func)if("string"==typeof channel){var srcChannel=meta.channels[channel];if(srcChannel)channel=srcChannel;else if(!(channel=meta.createChannel(channel)))return;channel.add(func,owner,priority)}else{if("[object Array]"===Object.prototype.toString.call(channel)){for(var numChannels=channel.length,i=0;i<numChannels;i++)meta.subscribe(channel[i],func,owner,priority);return}console.warn("(meta.subscribe) Wrong type for channel object: "+typeof channel)}else console.warn("(meta.subscribe) No callback function passed.");else console.warn("(meta.subscribe) No owner passed.")},meta.unsubscribe=function(channel,owner){if("string"==typeof channel)(channel=meta.channels[channel])?channel.remove(owner):console.warn("(meta.unsubscribe) No name was specified!");else{if("[object Array]"===Object.prototype.toString.call(channel)){for(var numChannels=channel.length,i=0;i<numChannels;i++)meta.unsubscribe(channel[i],owner);return}console.warn("(meta.unsubscribe) Wrong type for channel object.")}},meta.emit=function(channel,data,event){"string"!=typeof channel||(channel=meta.channels[channel])?channel.emit(data,event):console.warn("(meta.emit) No name was specified!")},meta.View=function(name){this.name=name,this.entities=[],this.children=null,this.parent=null,this.flags=0},meta.View.prototype={remove:function(){if("master"!==this.name){this.parent&&this.parent.detachView(this);for(var num=this.entities.length,n=0;n<num;n++)this.entities[n].remove();if(this.entities.length=0,this.children)for(num=this.children.length,n=0;n<num;n++)this.children[n].remove()}else console.warn("(meta.View.remove) Master view can't be removed")},attach:function(entity){entity instanceof Entity.Geometry?entity.flags&this.Flag.REMOVED?console.warn("(meta.View.attach) Trying to add entity that has been marked as removed"):entity._view?entity._view===this?console.warn("(meta.View.attach) Entity is already added to this view"):console.warn("(meta.View.attach) Entity is already added to some other view"):(entity.parent!==this.entityParent&&(entity.parent=this.entityParent),entity.flags|=entity.Flag.ROOT,entity._view=this,0===this._x&&0===this._y||entity.updatePos(),0!==this._z&&entity.updateZ(),this.entities.push(entity),this._attachChildren(entity.children),this.flags&this.Flag.ACTIVE&&!(this.flags&this.Flag.INSTANCE_HIDDEN)&&meta.renderer.addEntity(entity,!1)):console.warn("(meta.View.attach) Trying to add invalid entity")},_attachChildren:function(children){if(children)for(var child,numChildren=children.length,i=0;i<numChildren;i++)(child=children[i]).removed||(child._view=this,this._attachChildren(child.children))},detach:function(entity){if(!(entity.flags&this.Flag.REMOVED))if(entity._view)if(entity._view===this){var num=this.entities.length,index=this.entities.indexOf(entity);index>-1&&(this.entities[index]=this.entities[num-1],this.entities.pop()),this.flags&this.Flag.ACTIVE&&!(this.flags&this.Flag.INSTANCE_HIDDEN)&&(meta.renderer.removeEntity(entity),entity._view=null)}else console.warn("(meta.View.detach) Entity is part of other view: "+entity._view.name);else console.warn("(meta.View.detach) Entity does not have view.")},attachView:function(view){if(!view)return this.parent?void console.warn("(meta.View.attach) No view was passed."):void meta.cache.view.attachView(this);if("string"==typeof view){var srcView=meta.cache.views[view];if(!srcView)return void console.warn("(meta.View.attach) No such view found: "+view);view=srcView}else if(!(view instanceof meta.View))return void console.warn("(meta.View.attach) Trying to attach invalid view object.");view.parent?console.warn("(meta.View.attach) View is already part of other view."):(this.children?this.children.push(view):this.children=[view],view.parent=this,this.flags&this.Flag.ACTIVE&&view._activate())},detachView:function(view){if(!view)return this.parent?void this.parent.detachView(this):void console.warn("(meta.View.detachView) No view was been passed.");if("string"==typeof view){var srcView=meta.cache.views[view];if(!srcView)return void console.warn('(meta.View.detachView) No such view found: "'+view+'"');view=srcView}if(view.parent){if(this.children)for(var numChildren=this.children.length,i=0;i<numChildren;i++)if(this.children[i]===view){this.children[i]=this.children[numChildren-1],this.children.pop();break}view.parent=null,this.flags&this.Flag.ACTIVE&&view._deactivate()}else console.warn("(meta.View.detachView) View has not parents to detach from")},detachViews:function(){for(var child,numChildren=this.children.length,n=0;n<numChildren;n++)(child=this.children[n]).detachView(child)},_activate:function(){if(this.flags|=this.Flag.ACTIVE,!(this.flags&this.Flag.INSTANCE_HIDDEN)&&(meta.renderer.addEntities(this.entities),this.children))for(var num=this.children.length,n=0;n<num;n++)this.children[n]._activate()},_deactivate:function(){if(this.flags&=~this.Flag.ACTIVE,!(this.flags&this.Flag.INSTANCE_HIDDEN)&&(meta.renderer.removeEntities(this.entities),this.children))for(var num=this.children.length,n=0;n<num;n++)this.children[n]._deactivate()},get active(){return(this.flags&this.Flag.ACTIVE)===this.Flag.ACTIVE},_updateHidden:function(){if(this.flags&this.Flag.INSTANCE_HIDDEN){if(this.flags&this.Flag.HIDDEN)return;if(this.parent.flags&this.Flag.INSTANCE_HIDDEN)return;this.flags&=~this.Flag.INSTANCE_HIDDEN,this.flags&this.Flag.ACTIVE&&meta.renderer.removeEntities(this.entities)}else{if(!(this.flags&this.Flag.HIDDEN||this.parent.flags&this.Flag.INSTANCE_HIDDEN))return;this.flags|=this.Flag.INSTANCE_HIDDEN,this.flags&this.Flag.ACTIVE&&meta.renderer.addEntities(this.entities)}if(this.children)for(var num=this.children.length,n=0;n<num;n++)this.children[n]._updateHidden()},set hidden(value){value?this.flags|=this.Flag.HIDDEN:this.flags&=~this.Flag.HIDDEN,this._updateHidden()},get hidden(){return(this.flags&this.Flag.HIDDEN)===this.Flag.HIDDEN},updateEntity:function(entity){0!=(this.flags&this.Flag.ACTIVE)&&(this.flags&this.Flag.INSTANCE_HIDDEN||(entity.flags&entity.Flag.INSTANCE_ENABLED?meta.renderer.addEntity(entity):meta.renderer.removeEntity(entity)))},set x(value){if(this._x!==value){this._x=value;for(var numEntities=this.entities.length,i=0;i<numEntities;i++)this.entities[i].updatePos()}},set y(value){if(this._y!==value){this._y=value;for(var numEntities=this.entities.length,i=0;i<numEntities;i++)this.entities[i].updatePos()}},set z(value){this._z=value;for(var numEntities=this.entities.length,i=0;i<numEntities;i++)this.entities[i].updateZ()},get x(){return this._x},get y(){return this._y},get z(){return this._z},get tween(){return this._tween||(this._tween=new meta.Tween(this)),this._tween},set static(value){if(this.flags&this.Flag.ACTIVE)console.error("(meta.View.set::static) Can`t change static mode if view is already active");else{value?(this.flags|=this.Flag.STATIC,this.entityParent=meta.renderer.staticHolder,this.entityBuffer=meta.renderer.entitiesStatic,this.entityBufferRemove=meta.renderer.entitiesStaticRemove):(this.flags&=~this.Flag.STATIC,this.entityParent=meta.renderer.holder,this.entityBuffer=meta.renderer.entities,this.entityBufferRemove=meta.renderer.entitiesRemove);for(var num=this.entities.length,n=0;n<num;n++)this.entities[n].parent=this.entityParent}},get static(){return(this.flags&this.Flag.STATIC)===this.Flag.STATIC},set debugger(value){if(this.flags&this.Flag.ACTIVE)console.error("(meta.View.set::debugger) Can`t change debugger mode if view is already active");else{value?(this.flags|=this.Flag.DEBUGGER,this.entityParent=meta.renderer.staticHolder,this.entityBuffer=meta.renderer.entitiesDebug,this.entityBufferRemove=meta.renderer.entitiesDebugRemove):(this.flags&=~this.Flag.DEBUGGER,this.entityParent=meta.renderer.holder,this.entityBuffer=meta.renderer.entities,this.entityBufferRemove=meta.renderer.entitiesRemove);for(var num=this.entities.length,n=0;n<num;n++)this.entities[n].parent=this.entityParent}},get debugger(){return(this.flags&this.Flag.DEBUGGER)===this.Flag.DEBUGGER},Flag:{HIDDEN:1,INSTANCE_HIDDEN:2,ACTIVE:4,STATIC:8,DEBUGGER:16},_x:0,_y:0,_z:0,_tween:null,entityParent:null,entityBuffer:null,entityBufferRemove:null},meta.createView=function(name){if(name&&"string"==typeof name){var view=meta.cache.views[name];if(!view)return view=new meta.View(name),meta.cache.views[name]=view,view;console.error("(meta.createView) View with a name - "+name+", already exist")}else console.error("(meta.createView) Invalid name of the view")},meta.setView=function(view){if(view){var cache=meta.cache;if("string"==typeof view){var name=view;(view=cache.views[name])||(console.warn("(meta.setView) Creating an empty view, could be unintended - "+name),view=new meta.View(name),cache.views[name]=view)}view!==cache.view?view.parentView?console.warn("(meta.setView) View is already attached to master or other view"):(cache.view.detachViews(),cache.view.attachView(view)):console.warn("(meta.setView) Cannot modify master view")}else console.error("(meta.setView) No view passed")},meta.getView=function(name){if(!name)return console.error("(meta.getView) No name specified"),null;var view=meta.cache.views[name];return view||(view=new meta.View(name),meta.cache.views[name]=view),view},meta.attachView=function(view){var cache=meta.cache;if("string"==typeof view){var srcView=cache.views[view];if(!srcView)return void console.warn("(meta.attachView) No such view found: "+view);view=srcView}view.parentView?console.warn("(meta.attachView) View already has parent attached"):cache.view.attachView(view)},meta.detachView=function(view){var cache=meta.cache;if("string"==typeof view){var srcView=cache.views[view];if(!view)return void console.warn("(meta.detachView) No such view found: "+view);view=srcView}view.parentView?cache.view.detachView(view):console.warn("(meta.detachView) View does not have parent attached")},Object.defineProperty(meta,"view",{set:function(view){meta.setView(view)},get:function(){return meta.cache.view}}),meta.Camera=function(){this.volume=new meta.math.AABBext(0,0,0,0),this.zoomBounds=null,this._wasResized=!1,this._autoZoom=!1,this._zoom=1,this.prevZoom=1,this.zoomRatio=1,this._draggable=!1,this._dragging=!1,this._moved=!1,this._center=!1,this._centerX=!0,this._centerY=!0,this._worldBounds=!1,this._followEntity=null,this.onResize=meta.createChannel(meta.Event.CAMERA_RESIZE),this.onMove=meta.createChannel(meta.Event.CAMERA_MOVE),this.init()},meta.Camera.prototype={init:function(){meta.engine.onResize.add(this._onResize,this),meta.subscribe(meta.Event.WORLD_RESIZE,this._onWorldResize,this),this.zoomBounds={width:-1,height:-1,minWidth:-1,minHeight:-1,maxWidth:-1,maxHeight:-1}},release:function(){this.onMove.release(),meta.engine.onResize.remove(this),meta.world.onResize.remove(this)},update:function(tDelta){if(this._followEntity){var entityVolume=this._followEntity.volume,cameraX=Math.floor(entityVolume.x)-Math.floor(this.volume.width/2),cameraY=Math.floor(entityVolume.y)-Math.floor(this.volume.height/2);this.position(cameraX,cameraY)}},updateView:function(){this._autoZoom?this.updateAutoZoom():this.updateZoom();var world=meta.world;if(!this._moved){var moveX=0,moveY=0;this._center?(moveX=this._centerX?Math.floor((this.volume.width-world.width)/2):0,moveY=this._centerY?Math.floor((this.volume.height-world.height)/2):0):(moveX=0,moveY=0),this.volume.move(moveX,moveY)}this._wasResized&&(this.onResize.emit(this,meta.Event.CAMERA_RESIZE),this._wasResized=!1),this.onMove.emit(this,meta.Event.CAMERA_MOVE)},updateZoom:function(){this.prevZoom!==this._zoom&&(this.zoomRatio=1/this._zoom,this.volume.scale(this.zoomRatio,this.zoomRatio),this._wasResized=!0)},updateAutoZoom:function(){var engine=meta.engine,width=this.zoomBounds.width,height=this.zoomBounds.height,diffX=engine.width/width,diffY=engine.height/height;this.prevZoom=this._zoom,this._zoom=diffX,diffY<diffX&&(this._zoom=diffY),engine.adaptResolution()&&(width=this.zoomBounds.width,height=this.zoomBounds.height,diffX=engine.width/width,diffY=engine.height/height,this._zoom=diffX,diffY<diffX&&(this._zoom=diffY),this.volume.resize(engine.width,engine.height)),this.updateZoom()},bounds:function(width,height){this._autoZoom=!0,this._wasResized=!0,this.zoomBounds.width=width,this.zoomBounds.height=height,0===this.volume.width&&0===this.volume.height||this.updateView()},minBounds:function(width,height){this._autoZoom=!0,this._wasResized=!0,this.zoomBounds.minWidth=width,this.zoomBounds.minHeight=height,this.updateView()},maxBounds:function(width,height){this._autoZoom=!0,this._wasResized=!0,this.zoomBounds.maxWidth=width,this.zoomBounds.maxHeight=height,this.updateView()},_onInput:function(data,event){var inputEvent=Input.Event;event===inputEvent.MOVE?this._drag(data):event===inputEvent.DOWN?data.keyCode===Input.Key.BUTTON_LEFT&&this._startDrag(data):event===inputEvent.UP&&data.keyCode===Input.Key.BUTTON_LEFT&&this._endDrag(data)},_onResize:function(data,event){this.volume.resize(data.width,data.height),this._wasResized=!0,this.updateView()},_onWorldResize:function(data,event){this.updateView()},_startDrag:function(data){this._draggable&&(this._dragging=!0)},_endDrag:function(data){this._dragging=!1},_drag:function(data){if(this._dragging){var scope=meta,diffX=(data.screenX-data.prevScreenX)*this.zoomRatio,diffY=(data.screenY-data.prevScreenY)*this.zoomRatio;if(this._moved=!0,this._worldBounds){var worldVolume=scope.world.volume,newX=this.volume.minX-diffX,newY=this.volume.minY-diffY;newX<worldVolume.minX?diffX-=worldVolume.minX-newX:newX+this.volume.width>worldVolume.maxX&&(diffX=this.volume.maxX-worldVolume.maxX),newY<worldVolume.minY?diffY-=worldVolume.minY-newY:newY+this.volume.height>worldVolume.maxY&&(diffY=this.volume.maxY-worldVolume.maxY)}this.volume.move(-diffX,-diffY),this.onMove.emit(this,scope.Event.CAMERA_MOVE)}},position:function(x,y){this.volume.x===x&&this.volume.y===y||(this.volume.position(x,y),this._moved=!0,this.updateView())},follow:function(entity){if(entity){if(!(entity instanceof Entity.Geometry))return void console.warn("(meta.Camera.follow): Invalid entity - should be part of Entity.Geometry");this._followEntity=entity}else this._followEntity=null},set x(value){this.volume.x!==value&&(this.volume.position(value,this.volume.y),this._moved=!0,this.updateView())},set y(value){this.volume.y!==value&&(this.volume.position(this.volume.x,value),this._moved=!0,this.updateView())},get x(){return this.volume.x},get y(){return this.volume.y},get width(){return this.volume.width},get height(){return this.volume.height},set zoom(value){this._zoom!==value&&(this.prevZoom=this._zoom,this._zoom=value,this.updateView())},get zoom(){return this._zoom},set enableBorderIgnore(value){this._enableBorderIgnore=value,this.updateView()},get enableBorderIgnore(){return this._enableBorderIgnore},set draggable(value){if(this._draggable!==value){this._draggable=value;var events=[Input.Event.DOWN,Input.Event.UP,Input.Event.MOVE];value?meta.subscribe(events,this._onInput,this):(meta.unsubscribe(events,this),this._dragging=!1)}},get draggable(){return this._draggable},set autoZoom(value){this._autoZoom!==value&&(this._autoZoom=value,this._wasResized=!0,this.updateView())},get autoZoom(){return this._autoZoom},set worldBounds(value){this._worldBounds!==value&&(this._worldBounds=value,this._wasResized=!0,this.updateView())},get worldBounds(){return this._worldBounds},set center(value){this._center=value,this.updateView()},set centerX(value){this._centerX=value,this.updateView()},set centerY(value){this._centerY=value,this.updateView()},get center(){return this._center},get centerX(){return this._centerX},get centerY(){return this._centerY}},meta.class("meta.World",{init:function(width,height){this.volume=new meta.math.AABB(0,0,0,0),this.volumes=[this.volume],this.onResize=meta.createChannel(meta.Event.WORLD_RESIZE),meta.camera.onResize.add(this._updateBounds,this)},bounds:function(minX,minY,maxX,maxY){this.volume.set(minX,minY,maxX-minX,maxY-minY),this.centerX=minX+(maxX-minX)/2,this.centerY=minY+(maxY-minY)/2,this._adapt=!1},_updateBounds:function(camera,event){this._adapt&&(this.volume.set(0,0,Math.ceil(camera.width),Math.ceil(camera.height)),this.centerX=camera.width/2,this.centerY=camera.height/2)},removeVolume:function(volume){for(var num=this.volumes.length,i=0;i<num;i++)if(this.volumes[i]===volume){this.volumes[i]=this.volumes[num-1],this.volumes.pop();break}},get randX(){return meta.random.number(this.volume.minX,this.volume.maxX)},get randY(){return meta.random.number(this.volume.minY,this.volume.maxY)},set adapt(value){this._adapt=value,value&&this._updateBounds(meta.camera,0)},get adapt(){return this._adapt},get width(){return this.volume.width},get height(){return this.volume.height},onResize:null,volume:null,centerX:0,centerY:0,volumes:null,_adapt:!0,_screenBounds:!0}),function(){function _addClassInstance(cls){var path=cls.prototype.__name__.split(".").slice(2),num=path.length-1;if(cls instanceof meta.Controller)console.error("(meta.controller): Controller parent class should be meta.Controller");else{for(var name,scope=window,prevScope=scope,n=0;n<num;n++)(scope=prevScope[name=path[n]])||(scope={},prevScope[name]=scope),prevScope=scope;scope[name=path[num]]?console.error("(meta.controller): Scope is already in use: "+path.join(".")):(cls.prototype.name=name,meta.engine.inited?scope[name]=new cls:meta.cache.ctrlsToCreate?meta.cache.ctrlsToCreate.push({cls:cls,scope:scope}):meta.cache.ctrlsToCreate=[{cls:cls,scope:scope}])}}meta.class("meta.Controller",{init:function(){this.view=meta.createView("__ctrl__"+this.__lastName__+meta.cache.ctrlUniqueID++),this.onInit&&this.onInit()},onInit:null,load:function(){this.flags&this.Flag.LOADED||this.onTryLoad&&!this.onTryLoad()||this.forceLoad()},forceLoad:function(){this.flags&this.Flag.LOADED||(0==(this.flags&this.Flag.FIRST_LOADED)&&(this.onFirstLoad&&this.onFirstLoad(),this.flags|=this.Flag.FIRST_LOADED),this.onLoad&&this.onLoad(),meta.engine.controllersReady.push(this),meta.cache.view.attachView(this.view),this.flags|=this.Flag.LOADED)},unload:function(){0!=(this.flags&this.Flag.LOADED)&&(this.onTryUnload&&!this.onTryUnload()||this.forceUnload())},forceUnload:function(){if(0!=(this.flags&this.Flag.LOADED)){if(this.onUnload&&this.onUnload(),this.onUpdate)for(var buffer=meta.engine.controllersUpdate,num=buffer.length,n=0;n<num;n++)if(buffer[n]===this){buffer.splice(n,1);break}meta.cache.view.detachView(this.view),this.flags&=~(this.Flag.LOADED|this.Flag.READY)}},onTryLoad:null,onFirstLoad:null,onLoad:null,onTryUnload:null,onUnload:null,onFirstReady:null,onReady:null,ready:function(){this.flags&this.Flag.READY||(0==(this.flags&this.Flag.FIRST_READY)&&(this.onFirstReady&&this.onFirstReady(),this.flags|=this.Flag.FIRST_READY),this.onReady&&this.onReady(),this.onUpdate&&meta.engine.controllersUpdate.push(this),this.flags|=this.Flag.READY)},onUpdate:null,Flag:{LOADED:1,READY:2,FIRST_LOADED:4,FIRST_READY:8},name:"",view:null,flags:0}),meta.controllers={},meta.cache.ctrlUniqueID=0,meta.controller=function(name,extend,obj){obj||("object"==typeof extend?(obj=extend,extend="meta.Controller"):obj=null),extend||(extend="meta.Controller"),meta.class("meta.controllers."+name,extend,obj,_addClassInstance)},meta.class("meta.Component",{owner:null}),meta.component=function(name,extend,obj){meta.class(name,extend,obj)}}(),meta.Timer=function(owner,func,tDelta,numTimes){this.owner=owner,this.id=meta.cache.timerIndex++,this.func=func,this.onRemove=null,this.tDelta=tDelta,this.numTimes=numTimes,void 0===this.numTimes&&(this.numTimes=-1),this.initNumTimes=this.numTimes,this.tAccumulator=0,this.tStart=Date.now(),this.__index=-1},meta.Timer.prototype={play:function(){-1===this.__index&&(this.__index=meta.engine.timers.push(this)-1)},stop:function(){-1!==this.__index&&(meta.engine.timersRemove.push(this),this.__index=-1)},pause:function(){this.paused=!0},resume:function(){this.paused=!1,this.tStart=Date.now()},reset:function(){this.tAccumulator=0,this.numTimes=this.initNumTimes,this.paused=!1,this.play()},onRemove:null,paused:!1},meta.createTimer=function(owner,func,tDelta,numTimes){"function"==typeof owner&&(numTimes=tDelta,tDelta=func,func=owner,owner=window);if(func)return new meta.Timer(owner,func,tDelta,numTimes);console.warn("(meta.addTimer) Invalid function passed")},meta.addTimer=function(owner,func,tDelta,numTimes){var newTimer=meta.createTimer(owner,func,tDelta,numTimes);return newTimer.play(),newTimer},meta.Event={UPDATE:"update",RESIZE:"resize",WORLD_RESIZE:"world-resize",CAMERA_MOVE:"camera-move",CAMERA_RESIZE:"camera-resize",BLUR:"blur",FOCUS:"focus",FULLSCREEN:"fullscreen",ADAPT:"adapt",DEBUG:"debug",RENDER_DEBUG:"debug-draw"},meta.Priority={LOW:0,MEDIUM:5e3,HIGH:1e4},meta.Cursor={ALIAS:"alias",ALL_SCROLL:"all-scroll",CELL:"cell",CONTEXT_MENU:"context-menu",COL_RESIZE:"col-resize",COPY:"copy",CROSSHAIR:"crosshair",DEFAULT:"default",E_RESIZE:"e-resize",EW_RESIZE:"ew-resize",GRAB:"grab",GRABBING:"grabbing",HELP:"help",MOVE:"move",N_RESIZE:"n-resize",NE_RESIZE:"ne-resize",NESW_RESIZE:"nesw-resize",NS_RESIZE:"ns-reisize",NW_RESIZE:"nw-resize",NWSE_RESIZE:"nwse-resize",NO_DROP:"no-drop",NONE:"none",NOT_ALLOWED:"not-allowed",POINTER:"pointer",PROGRESS:"progress",ROW_RESIZE:"row-resize",S_RESIZE:"s-resize",SE_RESIZE:"se-resize",SW_RESIZE:"sw-resize",TEXT:"text",VERTICAL_TEXT:"vertical-text",W_RESIZE:"w-resize",WAIT:"wait",ZOOM_IN:"zoom-in",ZOOM_OUT:"zoom-out",INITIAL:"initial"},function(){meta.ajax=function(params){var data=meta.serialize(params.data),xhr=new XMLHttpRequest;return"html"===params.dataType?params.responseType="document":"script"===params.dataType||"json"===params.dataType?params.responseType="text":void 0===params.dataType?(params.responseType="GET",xhr.overrideMimeType("text/plain")):params.responseType=params.dataType,void 0===params.type&&(params.type="GET"),xhr.open(params.type,params.url,!0),xhr.onload=function(){4===xhr.readyState&&200===xhr.status?void 0!==params.success&&("document"===params.responseType?params.success(xhr.responseXML):"script"===params.dataType?params.success(eval(xhr.responseText)):"json"===params.dataType?params.success(JSON.parse(xhr.responseText)):params.success(xhr.responseText)):void 0!==params.error&&params.error()},xhr.send(data),xhr}}(),meta.Tokenizer=function(){this.currChar=0,this.buffer=null,this.bufferLength=0,this.cursor=0,this.token={type:0,str:"",value:0,line:0}},meta.Tokenizer.prototype={setup:function(data){this.buffer=data,this.bufferLength=data.length,this.cursor=0},nextToken:function(){for(this.token.type=0,this.token.str="",this.token.value=0,this.nextChar();meta.isSpace(this.currChar);)this.nextChar();if(meta.isAlpha(this.currChar)){for(this.token.str+=this.currChar,this.nextChar();meta.isAlphaNum(this.currChar);)this.token.str+=this.currChar,this.nextChar();switch(this.cursor--,this.token.str){case"true":this.token.type=this.Type.BOOL,this.token.value=1;break;case"false":this.token.type=this.Type.BOOL;break;case"NaN":this.token.type=this.Type.NUMBER,this.token.value=NaN;break;default:this.token.type=this.Type.NAME}return this.token}if(meta.isDigit(this.currChar)){for(this.token.str+=this.currChar,this.nextChar();meta.isDigit(this.currChar);)this.token.str+=this.currChar,this.nextChar();return this.cursor--,"."===this.token.str?(this.token.type=this.Type.SYMBOL,this.token.value=this.token.str,this.token):(this.token.type=this.Type.NUMBER,this.token.value=parseFloat(this.token.str),this.token)}if(meta.isBinOp(this.currChar))return this.token.str=this.currChar,this.token.type=this.Type.BINOP,this.token;if('"'===this.currChar||"'"===this.currChar){var endChar=this.currChar;this.nextChar();for(var peekChar=this.peekChar();;){if(this.currChar===endChar){this.currChar===peekChar&&(this.token.str+=this.currChar,this.nextChar());break}if("\0"===this.currChar)return this.token.type=this.Type.EOF,this.token;this.token.str+=this.currChar,this.nextChar()}return this.token.type=this.Type.STRING,this.token}return"\0"===this.currChar?(this.token.type=this.Type.EOF,this.token):(this.token.type=this.Type.SYMBOL,this.token.str=this.currChar,this.token)},nextChar:function(){this.currChar=this.peekChar(),this.cursor++,"\n"!==this.currChar&&"\0"!==this.currChar||this.token.line++},peekChar:function(){return this.cursor>=this.bufferLength?"\0":this.buffer.charAt(this.cursor)},Type:{EOF:0,NUMBER:1,BOOL:2,NAME:3,STRING:4,BINOP:5,SYMBOL:6}},meta.tokenizer=new meta.Tokenizer,meta.math={degToRad:function(degree){return degree*Math.PI/180},radToDeg:function(rad){return 180*rad/Math.PI},radiansToPoint:function(x1,y1,x2,y2){var dx=x2-x1,dy=y2-y1;return Math.atan(dx/dy)},clamp:function(num,min,max){return num<min?min:num>max?max:num},map:function(v,a,b,x,y){return v==a?x:(v-a)*(y-x)/(b-a)+x},length:function(x1,y1,x2,y2){var x=x2-x1,y=y2-y1;return Math.sqrt(x*x+y*y)},length2:function(x,y){return Math.sqrt(x*x+y*y)},limit:function(value,maxValue){return value>maxValue?maxValue:value<-maxValue?-maxValue:value},lerp:function(value1,value2,amount){return value1+(value2-value1)*amount},lookAt:function(srcX,srcY,targetX,targetY){return Math.atan2(targetX-srcX,srcY-targetY)},lookAtEntity:function(src,target){return meta.math.lookAt(src.x,src.y,target.x,target.y)},VolumeType:{AABB:0,CIRCLE:1,SEGMENT:2}},meta.math.Vector2=function(x,y){this.x=x,this.y=y},meta.math.Vector2.prototype={reset:function(){this.x=0,this.y=0},set:function(x,y){this.x=x,this.y=y},add:function(x,y){this.x+=x,this.y+=y},addValue:function(value){this.x+=x,this.y+=y},addVec:function(vec){this.x+=vec.x,this.y+=vec.y},sub:function(x,y){this.x-=x,this.y-=y},subValue:function(value){this.x-=value,this.y-=value},subVec:function(vec){this.x-=vec.x,this.y-=vec.y},mul:function(x,y){this.x*=x,this.y*=y},mulValue:function(value){this.x*=value,this.y*=value},mulVec:function(vec){this.x*=vec.x,this.y*=vec.y},div:function(x,y){this.x/=x,this.y/=y},divValue:function(value){this.x/=value,this.y/=value},divVec:function(vec){this.x/=vec.x,this.y/=vec.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},normalize:function(){var length=Math.sqrt(this.x*this.x+this.y*this.y);length>0?(this.x/=length,this.y/=length):(this.x=0,this.y=0)},dot:function(vec){return this.x*vec.x+this.y*vec.y},truncate:function(max){var length=Math.sqrt(this.x*this.x+this.y*this.y);length>max&&(this.x*=max/length,this.y*=max/length)},limit:function(max){this.x>max?this.x=max:this.x<-max&&(this.x=-max),this.y>max?this.y=max:this.y<-max&&(this.y=-max)},clamp:function(minX,minY,maxX,maxY){this.x=Math.min(Math.max(this.x,minX),maxX),this.y=Math.min(Math.max(this.y,minY),maxY)},lengthSq:function(){return this.x*this.x+this.y*this.y},heading:function(){return-Math.atan2(-this.y,this.x)+.5*Math.PI},perp:function(){var tmpX=this.x;this.x=-this.y,this.y=tmpX},reflect:function(normal){var value=this.dot(normal);this.x-=2*value*normal.x,this.y-=2*value*normal.y},print:function(str){str?console.log('[vec "'+str+'"] x: '+this.x+" y: "+this.y):console.log("[vec] x: "+this.x+" y: "+this.y)}},meta.math.AABB=function(x,y,width,height){this.x=x||0,this.y=y||0,this.width=width||0,this.height=height||0,this.halfWidth=this.width/2,this.halfHeight=this.height/2,this.pivotPosX=this.width*this.pivotX,this.pivotPosY=this.height*this.pivotY,this.minX=this.x,this.minY=this.y,this.maxX=this.x+this.width,this.maxY=this.y+this.height},meta.math.AABB.prototype={set:function(x,y,width,height){this.x=x||0,this.y=y||0,this.width=width||0,this.height=height||0,this.halfWidth=this.width/2,this.halfHeight=this.height/2,this.pivotPosX=this.width*this.pivotX,this.pivotPosY=this.height*this.pivotY,this.minX=this.x,this.minY=this.y,this.maxX=this.x+this.width,this.maxY=this.y+this.height},position:function(x,y){this.x=x,this.y=y,this.minX=this.x-this.pivotPosX,this.minY=this.y-this.pivotPosY,this.maxX=this.minX+this.width,this.maxY=this.minY+this.height},move:function(x,y){this.x+=x,this.y+=y,this.minX+=x,this.minY+=y,this.maxX+=x,this.maxY+=y},resize:function(width,height){this.width=width,this.height=height,this.halfWidth=width/2,this.halfHeight=height/2,this.pivotPosX=this.width*this.pivotX,this.pivotPosY=this.height*this.pivotY,this.minX=this.x-this.pivotPosX,this.minY=this.y-this.pivotPosY,this.maxX=this.minX+this.width,this.maxY=this.minY+this.height},pivot:function(x,y){void 0===y&&(y=x),this.pivotX=x,this.pivotY=y,this.pivotPosX=this.width*this.pivotX,this.pivotPosY=this.height*this.pivotY,this.minX=this.x-this.pivotPosX,this.minY=this.y-this.pivotPosY,this.maxX=this.minX+this.width,this.maxY=this.minY+this.height},vsAABB:function(src){return!(this.maxX<src.minX||this.minX>src.maxX)&&!(this.maxY<src.minY||this.minY>src.maxY)},vsBorderAABB:function(src){return!(this.maxX<=src.minX||this.minX>=src.maxX)&&!(this.maxY<=src.minY||this.minY>=src.maxY)},vsAABBIntersection:function(src){if(!(this.maxX<src.minX||this.minX>src.maxX||this.maxY<src.minY||this.minY>src.maxY))return this.minX>src.minX||this.minY>src.minY?1:this.maxX<src.maxX||this.maxY<src.maxY?1:2},vsPoint:function(x,y){return!(this.minX>x||this.maxX<x)&&!(this.minY>y||this.maxY<y)},vsBorderPoint:function(x,y){return!(this.minX>=x||this.maxX<=x)&&!(this.minY>=y||this.maxY<=y)},getSqrDistance:function(x,y){var tmp,sqDist=0;return x<this.minX&&(sqDist+=(tmp=this.minX-x)*tmp),x>this.maxX&&(sqDist+=(tmp=x-this.maxX)*tmp),y<this.minY&&(sqDist+=(tmp=this.minY-y)*tmp),y>this.maxY&&(sqDist+=(tmp=y-this.maxY)*tmp),sqDist},getDistanceVsAABB:function(aabb){var centerX=this.minX+(this.maxX-this.minX)/2,centerY=this.minY+(this.maxY-this.minY)/2,diffX=aabb.minX+(aabb.maxY-aabb.minY)/2-centerX,diffY=aabb.minY+(aabb.maxY-aabb.minY)/2-centerY;return Math.sqrt(diffX*diffX+diffY*diffY)},isUndefined:function(){return void 0===this.maxY},genCircle:function(){var radius,width=this.maxX-this.minX,height=this.maxY-this.minY;return radius=width>height?width/2:height/2,new meta.math.Circle(this.x,this.y,radius)},print:function(str){str?console.log("(AABB) "+str+" minX: "+this.minX+" minY: "+this.minY+" maxX: "+this.maxX+" maxY: "+this.maxY):console.log("(AABB) minX: "+this.minX+" minY: "+this.minY+" maxX: "+this.maxX+" maxY: "+this.maxY)},pivotX:0,pivotY:0,type:meta.math.VolumeType.AABB},meta.math.AABBext=function(){this.x=0,this.y=0,this.width=0,this.height=0,this.halfWidth=0,this.halfHeight=0,this.initWidth=0,this.initHeight=0,this.minX=0,this.minY=0,this.maxX=0,this.maxY=0},meta.math.AABBext.prototype={position:function(x,y){this.x=x,this.y=y,this.minX=this.x-this.pivotPosX,this.minY=this.y-this.pivotPosY,this.maxX=this.minX+this.width,this.maxY=this.minY+this.height},move:function(x,y){this.x+=x,this.y+=y,this.minX+=x,this.minY+=y,this.maxX+=x,this.maxY+=y},updatePos:function(){this.minX=this.x-this.pivotPosX,this.minY=this.y-this.pivotPosY,this.maxX=this.minX+this.width,this.maxY=this.minY+this.height},pivot:function(x,y){void 0===y&&(y=x),this.pivotX=x,this.pivotY=y,this.initPivotPosX=this.initWidth*this.pivotX|0,this.initPivotPosY=this.initHeight*this.pivotY|0,this.updatePivotPos()},updatePivotPos:function(){this.scaleX>0?this.pivotPosX=this.pivotX*this.width:this.pivotPosX=(1-this.pivotX)*this.width,this.scaleY>0?this.pivotPosY=this.pivotY*this.height:this.pivotPosY=(1-this.pivotY)*this.height,this.minX=this.x-this.pivotPosX,this.minY=this.y-this.pivotPosY,this.maxX=this.minX+this.width,this.maxY=this.minY+this.height},resize:function(width,height){this.initWidth=width,this.initHeight=height,this.initPivotPosX=width*this.pivotX|0,this.initPivotPosY=height*this.pivotY|0,this.width=width*Math.abs(this.scaleX)|0,this.height=height*Math.abs(this.scaleY)|0,this.halfWidth=this.width/2,this.halfHeight=this.height/2,this.updatePivotPos()},scale:function(x,y){this.scaleX=x*this.flipX,this.scaleY=y*this.flipY,this.width=Math.floor(this.initWidth*x),this.height=Math.floor(this.initHeight*y),this.halfWidth=this.width/2,this.halfHeight=this.height/2,this.updatePosTransform()},flip:function(x,y){void 0===x?(this.flipX=-this.flipX,this.scaleX*=-1):this.flipX!==x&&(this.flipX=x,this.scaleX*=-1),void 0===y||this.flipY!==y&&(this.flipY=y,this.scaleY*=-1),this.updatePosTransform()},rotate:function(angle){var pi2=2*Math.PI;(angle=angle%pi2)<0&&(angle+=pi2),this.angle=angle,this.sin=Math.sin(angle),this.cos=Math.cos(angle),this.m11=this.cos*this.scaleX,this.m12=this.sin*this.scaleX,this.m21=-this.sin*this.scaleY,this.m22=this.cos*this.scaleY,this.__transformed=1},updatePosTransform:function(){this.scaleX>0?this.pivotPosX=this.pivotX*this.width:this.pivotPosX=(1-this.pivotX)*this.width,this.scaleY>0?this.pivotPosY=this.pivotY*this.height:this.pivotPosY=(1-this.pivotY)*this.height,this.minX=this.x-this.pivotPosX,this.minY=this.y-this.pivotPosY,this.maxX=this.minX+this.width,this.maxY=this.minY+this.height,this.m11=this.cos*this.scaleX,this.m12=this.sin*this.scaleX,this.m21=-this.sin*this.scaleY,this.m22=this.cos*this.scaleY,this.__transformed=1},vsAABB:function(src){return!(this.maxX<=src.minX||this.minX>=src.maxX)&&!(this.maxY<=src.minY||this.minY>=src.maxY)},vsAABBIntersection:function(src){if(!(this.maxX<src.minX||this.minX>src.maxX||this.maxY<src.minY||this.minY>src.maxY))return this.minX>=src.minX||this.minY>=src.minY?1:this.maxX<=src.maxX||this.maxY<=src.maxY?1:2},vsPoint:function(x,y){return!(this.minX>=x||this.maxX<=x)&&!(this.minY>=y||this.maxY<=y)},getSqrDistance:function(x,y){var tmp,sqDist=0;return x<this.minX&&(sqDist+=(tmp=this.minX-x)*tmp),x>this.maxX&&(sqDist+=(tmp=x-this.maxX)*tmp),y<this.minY&&(sqDist+=(tmp=this.minY-y)*tmp),y>this.maxY&&(sqDist+=(tmp=y-this.maxY)*tmp),sqDist},getDistanceVsAABB:function(aabb){var centerX=this.minX+(this.maxX-this.minX)/2,centerY=this.minY+(this.maxY-this.minY)/2,diffX=aabb.minX+(aabb.maxY-aabb.minY)/2-centerX,diffY=aabb.minY+(aabb.maxY-aabb.minY)/2-centerY;return Math.sqrt(diffX*diffX+diffY*diffY)},genCircle:function(){var radius,width=this.maxX-this.minX,height=this.maxY-this.minY;return radius=width>height?width/2:height/2,new meta.math.Circle(this.x,this.y,radius)},print:function(str){str?console.log("(Volume) "+str+" minX: "+this.minX+" minY: "+this.minY+" maxX: "+this.maxX+" maxY: "+this.maxY):console.log("(Volume) minX: "+this.minX+" minY: "+this.minY+" maxX: "+this.maxX+" maxY: "+this.maxY)},pivotX:0,pivotY:0,pivotPosX:0,pivotPosY:0,initPivotPosX:0,initPivotPosY:0,anchorPosX:0,anchorPosY:0,scaleX:1,scaleY:1,flipX:1,flipY:1,angle:0,sin:0,cos:1,m11:1,m12:0,m21:0,m22:1,__transformed:0,type:meta.math.VolumeType.AABB},meta.math.Circle=function(x,y,radius){this.x=x,this.y=y,this.radius=radius,this.minX=x-radius,this.minY=y-radius,this.maxX=x+radius,this.maxY=y+radius},meta.math.Circle.prototype={position:function(x,y){this.x=x,this.y=y,this.minX=x-this.radius,this.minY=y-this.radius,this.maxX=x+this.radius,this.maxY=y+this.radius},move:function(addX,addY){this.x+=addX,this.y+=addY,this.minX+=addX,this.minY+=addY,this.maxX+=addX,this.maxY+=addY},vsPoint:function(x,y){return 2*(this.x-x)+2*(this.y-y)<=2*radius},vsAABB:function(aabb){},vsCircle:function(circle){var dx=circle.x-this.x,dy=circle.y-this.y,radii=this.radius+circle.radius;return dx*dx+dy*dy<radii*radii},overlapCircle:function(circle){var distance=Math.sqrt((this.x-circle.x)*(this.y-circle.y));if(!(distance>this.radius+circle.radius))return distance<=Math.abs(this.radius+circle.radius)?1:2},genAABB:function(){return new meta.math.AABB(this.x-this.radius,this.y-this.radius,this.x+this.radius,this.y+this.radius)},print:function(str){str?console.log("["+str+"] x:",this.x,"y:",this.y,"raidus:",this.radius):console.log("x:",this.x,"y:",this.y,"raidus:",this.radius)},type:meta.math.VolumeType.CIRCLE},meta.math.Matrix4=function(){this.m=new Float32Array(16),this.m[0]=1,this.m[5]=1,this.m[10]=1,this.m[15]=1},meta.math.Matrix4.prototype={reset:function(){this.m[0]=1,this.m[1]=0,this.m[2]=0,this.m[3]=0,this.m[4]=0,this.m[5]=1,this.m[6]=0,this.m[7]=0,this.m[8]=0,this.m[9]=0,this.m[10]=1,this.m[11]=0,this.m[12]=0,this.m[13]=0,this.m[14]=0,this.m[15]=1},scale:function(x,y,z){this.m[0]=x,this.m[5]=y,this.m[10]=z},ortho:function(left,right,bottom,top,zNear,zFar){this.m[0]=2/(right-left),this.m[1]=0,this.m[2]=0,this.m[3]=0,this.m[4]=0,this.m[5]=2/(top-bottom),this.m[6]=0,this.m[7]=0,this.m[8]=0,this.m[9]=0,this.m[10]=-2/(zFar-zNear),this.m[11]=0,this.m[12]=-(right+left)/(right-left),this.m[13]=-(top+bottom)/(top-bottom),this.m[14]=-(zFar+zNear)/(zFar-zNear),this.m[15]=1}},meta.math.Random=function(){this.seed=0,this.a=0,this.m=0,this.q=0,this.r=0,this.oneOverM=0,this.init()},meta.math.Random.prototype={init:function(){this.setSeed(3456789012,!0)},generate:function(){var hi=Math.floor(this.seed/this.q),lo=this.seed%this.q,test=this.a*lo-this.r*hi;return this.seed=test>0?test:test+this.m,this.seed*this.oneOverM},number:function(min,max){var number=this.generate();return Math.round((max-min)*number+min)},numberF:function(min,max){return(max-min)*this.generate()+min},setSeed:function(seed,useTime){if(void 0!==useTime&&(useTime=!0),!0===useTime){var date=new Date;this.seed=seed+16777215*date.getSeconds()+65535*date.getMinutes()}else this.seed=seed;this.a=48271,this.m=2147483647,this.q=Math.floor(this.m/this.a),this.r=this.m%this.a,this.oneOverM=1/this.m}},meta.random=new meta.math.Random,function(){var Resource={};Resource.Event={FAILED:"res-failed",UNLOADED:"res-unloaded",LOADED:"res-loaded",RESIZE:"res-resize",CHANGED:"res-changed",ADDED:"res-added",REMOVED:"res-removed",LOADING_START:"res-loading-started",LOADING_END:"res-loading-ended",LOADING_UPDATE:"red-loadig-update"},Resource.Type={BASIC:1,TEXTURE:2,SOUND:3,SPRITE_SHEET:4,FONT:5},Resource.TextureType={UNKNOWN:-1,CANVAS:0,WEBGL:1},window.Resource=Resource}(),meta.class("Resource.Manager",{init:function(){this.onAdded=meta.createChannel(Resource.Event.ADDED),this.onRemoved=meta.createChannel(Resource.Event.REMOVED),this.onLoaded=meta.createChannel(Resource.Event.LOADED),this.onLoadingStart=meta.createChannel(Resource.Event.LOADING_START),this.onLoadingEnd=meta.createChannel(Resource.Event.LOADING_END),this.onLoadingUpdate=meta.createChannel(Resource.Event.LOADING_UPDATE),this.textures={},this.spriteSheets={},this.fonts={},this.sounds={},this.data=[],this.data[Resource.Type.TEXTURE]=this.textures,this.data[Resource.Type.SPRITE_SHEET]=this.spriteSheets,this.data[Resource.Type.FONT]=this.fonts,this.data[Resource.Type.SOUND]=this.sounds,meta.audio=new Resource.AudioManager,meta.engine.onAdapt.add(this.onAdapt,this)},add:function(resource){if(!(resource.flags&resource.Flag.ADDED)){resource.flags|=resource.Flag.ADDED,"unknown"===resource.name&&resource.path&&(resource.name=resource.tag+meta.getNameFromPath(resource.path));var buffer=this.data[resource.type];return buffer[resource.name]?(console.warn("(Resource.Manager.add) There is already a resource("+meta.enumToString(Resource.Type,resource.type)+") added with a name: "+resource.name),null):(buffer[resource.name]=resource,this.onAdded.emit(resource,Resource.Event.ADDED),resource)}},remove:function(resource){var buffer=this.data[resource.type];buffer[resource.name]?(delete buffer[resource.name],resource.emit(this,Resource.Event.REMOVED),this.onRemoved.emit(resource,Resource.Event.REMOVED)):console.warn("(Resource.Manager.remove) Resource("+meta.enumToString(Resource.Type,resource.type)+")("+resource.name+") is not added to the manager.")},createTexture:function(name){var texture;return name?(texture=this.textures[name])||((texture=new Resource.Texture).name=name):texture=new Resource.Texture,texture._loaded=!1,this.add(texture),texture},createAnim:function(name,frameNames,fps){if(meta.resources.textures[name])return console.warn("(meta.createAnim) There is already texture with a name - "+name),null;var texture=new Resource.Texture;return texture.name=name,texture.createAnim(frameNames),texture.fps=fps||9,meta.resources.add(texture),texture},createAnimEx:function(name,frameNames,path,fps){if(meta.resources.textures[name])return console.warn("(meta.createAnimEx) There is already texture with a name - "+name),null;var texture=new Resource.Texture;return texture.name=name,texture.createAnimEx(frameNames,path),texture.fps=fps||9,meta.resources.add(texture),texture},_updateLoading:function(){if(this.numToLoad--,this.onLoadingUpdate.emit(this,Resource.Event.LOADING_UPDATE),0===this.numToLoad){var texture;for(var key in this.textures)(texture=this.textures[key])._loaded||(console.log("(Resource.Manager.loadSuccess) Texture requested but not loaded: "+texture.name),this.remove(texture));this.numTotalToLoad=0,this.loading=!1,this.onLoadingEnd.emit(this,Resource.Event.LOADING_END)}},loadFile:function(path,onSuccess){this.loading||(this.loading=!0,this.onLoadingStart.emit(this,Resource.Event.LOADING_START)),this.numToLoad++,this.numTotalToLoad++;var self=this;meta.ajax({url:path,success:function(response){onSuccess&&onSuccess(response),self._updateLoading()},error:function(){self._updateLoading()}})},addToLoad:function(resource){this.loading||(this.loading=!0,this.onLoadingStart.emit(this,Resource.Event.LOADING_START)),this.add(resource),resource.loading=!0,resource.currStep=0,this.numToLoad+=resource.steps,this.numTotalToLoad+=resource.steps},loadSuccess:function(resource){resource.currStep++,this.numLoaded++,resource.loading=!1,this.onLoaded.emit(resource,Resource.Event.LOADED),this._updateLoading()},loadFailed:function(resource){this.numLoaded+=resource.steps-resource.currStep,this._updateLoading(),resource.loading=!1},nextStep:function(resource){resource.currStep<resource.steps&&(resource.currStep++,this.numLoaded++,this._updateLoading())},addToQueue:function(resource){this._syncQueue||(this._syncQueue=[]),this._syncQueue.push(resource)},loadNextFromQueue:function(){this.isSyncLoading=!1,this._syncQueue&&this._syncQueue.length&&(this._syncQueue[this._syncQueue.length-1].forceLoad(!0),this._syncQueue.pop())},onAdapt:function(data,event){var texture,unitRatio=meta.unitRatio;for(var key in textures)(texture=this.textures[key]).unitRatio=unitRatio,texture.load()},preloadResource:function(cls,buffer,folderPath,tag){if(folderPath?folderPath.lastIndexOf("/")!==folderPath.length-1&&(folderPath+="/"):folderPath="",buffer instanceof Array)for(var numResources=buffer.length,i=0;i<numResources;i++)this._addResource(cls,buffer[i],folderPath,tag);else{if("object"!=typeof buffer&&"string"!=typeof buffer)return!1;this._addResource(cls,buffer,folderPath,tag)}return!0},_addResource:function(cls,data,folderPath,tag){var resource;return"object"==typeof data?(data.path&&(data.path=folderPath+data.path),resource=new cls(data,tag)):resource=new cls(folderPath+data,tag),resource},loadTexture:function(buffer,folderPath,tag){this.preloadResource(Resource.Texture,buffer,folderPath,tag)},loadSpriteSheet:function(buffer,folderPath,tag){this.preloadResource(Resource.SpriteSheet,buffer,folderPath,tag)},loadFont:function(buffer,folderPath,tag){this.preloadResource(Resource.Font,buffer,folderPath,tag)},loadSound:function(buffer,folderPath,tag){this.preloadResource(Resource.Sound,buffer,folderPath,tag)},getUniqueID:function(){return++this._uniqueID},data:null,textures:null,spriteSheets:null,fonts:null,sounds:null,rootPath:"",numLoaded:0,numToLoad:0,numTotalToLoad:0,_syncQueue:null,isSyncLoading:!1,_uniqueID:0,loading:!1,onAdded:null,onRemoved:null,onLoaded:null,onLoadingStart:null,onLoadingEnd:null,onLoadingUpdate:null}),meta.class("Resource.AudioManager",{init:function(){var audioProto=Resource.Sound.prototype;meta.device.audioAPI&&meta.flags.audioAPI?(this.context=new AudioContext,this.gainNode=this.context.createGain(),this.gainNode.connect(this.context.destination),this.gainNode.gain.value=this._volume,audioProto._context=this.context,audioProto._prepare=audioProto._prepare_WebAudio,audioProto._loadFromPath=audioProto._loadFromPath_WebAudio,audioProto._createInstance=audioProto._createInstance_WebAudio,audioProto.steps=2,meta.device.support.consoleCSS?console.log("%cAudio: %cWebAudio ","font-weight: bold; padding: 2px 0 2px 0;","padding: 2px 0 2px 0;"):console.log("Audio: WebAudio")):(this.audioAPI=!1,audioProto._prepare=audioProto._prepare_Audio,audioProto._loadFromPath=audioProto._loadFromPath_Audio,audioProto._createInstance=audioProto._createInstance_Audio,audioProto._syncLoading=!0,meta.device.support.consoleCSS?console.log("%cAudio: %c<audio> ","font-weight: bold; padding: 2px 0 1px 0; width: 500px;","padding: 2px 0 1px 0;"):console.log("Audio: <audio>"))},set volume(value){if(this._volume=meta.math.clamp(value,0,1),!this._mute)if(this.audioAPI)this.gainNode.gain.value=this._volume;else{var sounds=meta.resources.resources[Resource.Type.SOUND];for(var key in sounds)sounds[key].volume=this._volume}},get volume(){return this._volume},set mute(value){if(this._mute!==value){this._mute=value;var volume;if(volume=value?0:this._volume,this.audioAPI)this.gainNode.gain.value=volume;else{var sounds=meta.resources.resources[Resource.Type.SOUND];for(var key in sounds)sounds[key].volume=volume}}},get mute(){return this._mute},context:null,gainNode:null,_volume:.5,_mute:!1,audioAPI:!0}),meta.class("Resource.Basic",{init:function(data,tag){this.id=meta.resources.getUniqueID(),tag&&(this.tag=tag),this.onInit&&this.onInit(data,tag)},onInit:null,subscribe:function(func,owner){return this.chn||(this.chn=meta.createChannel("__res"+this.id)),this.chn.add(func,owner)},unsubscribe:function(owner){this.chn&&(this.chn.remove(owner),0===this.chn.numSubs&&(this.chn.remove(),this.chn=null))},emit:function(data,event){this.chn&&this.chn.emit(data,event)},set loaded(value){value?this._loaded?(this._loaded=value,this.emit(this,Resource.Event.CHANGED)):(this._loaded=value,this.emit(this,Resource.Event.LOADED)):this._loaded&&(this._loaded=value,this.emit(this,Resource.Event.UNLOADED))},get loaded(){return this._loaded},Flag:{ADDED:8},id:0,flags:0,type:Resource.Type.BASIC,name:"unknown",path:"",fullPath:"",tag:"",chn:null,_loaded:!1,loading:!1,used:!1,steps:1,currStep:0}),meta.class("Resource.Texture","Resource.Basic",{onInit:function(data,tag){if(this.generate(),data instanceof File)this.loadFile(data);else{var type=typeof data;if("string"===type)this.load(data);else if("object"===type){for(var key in data)this[key]=data[key];data.frames?this.animated=!0:(this.framesX>1||this.framesY>1)&&(this.frames=this.framesX*this.framesY,this.animated=!0),this.path&&this.load(this.path)}}},remove:function(){meta.resources.remove(this)},generate:function(){this.loaded=!0,this.canvas=document.createElement("canvas"),this.canvas.width=this.trueFullWidth,this.canvas.height=this.trueFullHeight,this.ctx=this.canvas.getContext("2d")},load:function(path){if(!this.loading&&(this.loaded=!1,path)){this.path=path;var wildCardIndex=this.path.lastIndexOf(".");(-1===wildCardIndex||this.path.length-wildCardIndex>4)&&(this.path+=".png"),meta.cache.currResolution?this.fullPath=meta.resources.rootPath+meta.cache.currResolution.path+this.path:this.fullPath=meta.resources.rootPath+this.path;var self=this,img=new Image;img.onload=function(){if(!img.complete)return console.warn("(Resource.Texture.load) Could not load texture from - "+img.src),void meta.resources.loadFailed(self);self.createFromImg(img),meta.resources.loadSuccess(self)},img.onerror=function(event){meta.resources.loadFailed(self),self.emit(this,Resource.Event.FAILED)},img.src=this.fullPath,meta.resources.addToLoad(this)}},loadFile:function(file){if(!this.loading){this.loaded=!1,this.path=window.URL.createObjectURL(file),this.fullPath=this.path;var self=this,img=new Image;img.onload=function(){if(!img.complete)return console.warn("(Resource.Texture.load) Could not load texture from - "+img.src),void meta.resources.loadFailed(self);self.createFromImg(img),meta.resources.loadSuccess(self),window.URL.revokeObjectURL(self.path),console.log(self.name)},img.onerror=function(event){meta.resources.loadFailed(self),self.emit(this,Resource.Event.FAILED)},img.src=this.fullPath,meta.resources.addToLoad(this)}},createFromImg:function(img){this._loaded&&this.clear(),this.resizeSilently(img.width,img.height),this.ctx.drawImage(img,0,0),this.unitRatio=meta.unitRatio,this._reloading=!1,this.loaded=!0},calcFrame:function(){this.animated?this.frames>1&&1===this.framesX&&1===this.framesY?(this.framesX=this.trueFullWidth/this.frameWidth,this.framesY=this.trueFullHeight/this.frameHeight):(this.frameWidth=this.trueFullWidth/this.framesX,this.frameHeight=this.trueFullHeight/this.framesY):(this.frameWidth=this.trueFullWidth,this.frameHeight=this.trueFullHeight)},_createCachedImg:function(){this._cachedImg||(this._cachedImg=document.createElement("canvas"),this._cachedImg.width=this.trueFullWidth,this._cachedImg.height=this.trueFullHeight,this._cachedCtx=this._cachedImg.getContext("2d"))},convertToAnim:function(frameWidth,frameHeight,frames,fps){this.frameWidth=frameWidth,this.frameHeight=frameHeight,this.frames=frames,this.fps=fps||9,this.animated=!0,this._loaded&&this.calcFrame()},createAnim:function(frameNames){this._numToLoad=0;var texture,textureName,wildCard,wildCardIndex,textures=meta.resources.textures,num=frameNames.length;this.frameData=new Array(num),this.frames=num;for(var n=0;n<num;n++)-1!==(wildCardIndex=(textureName=frameNames[n]).lastIndexOf("."))?(wildCard=textureName.substr(wildCard+1),textureName=textureName.substr(0,wildCardIndex)):wildCard="",(texture=textures[textureName])||(texture=meta.resources.createTexture(textureName)),texture._loaded||(texture.subscribe(this._handleTextureFrameEvent,this),this._numToLoad++),this.frameData[n]=new this.Frame(texture,0,0);0===this._numToLoad&&this._prepareFromFrameData()},createAnimEx:function(frameNames,path){this._numToLoad=0;var texture,textureName,wildCard,wildCardIndex,textures=meta.resources.textures,num=frameNames.length;this.frameData=new Array(num),this.frames=num;for(var n=0;n<num;n++)-1!==(wildCardIndex=(textureName=frameNames[n]).lastIndexOf("."))?(wildCard=textureName.substr(wildCard+1),textureName=textureName.substr(0,wildCardIndex)):wildCard="",(texture=textures[textureName])||(texture=new Resource.Texture(path+textureName+wildCard)),texture._loaded||(this._numToLoad++,texture.subscribe(this._handleTextureFrameEvent,this)),this.frameData[n]=new this.Frame(texture,0,0);0===this._numToLoad&&this._prepareFromFrameData()},_prepareFromFrameData:function(){var frameTexture=this.frameData[0].texture;this.width=frameTexture.width,this.height=frameTexture.height,this.loaded=!0},_handleTextureFrameEvent:function(data,eventType){eventType===Resource.Event.LOADED&&(this._numToLoad--,data.unsubscribe(this)),0===this._numToLoad&&this._prepareFromFrameData()},resize:function(width,height){this.trueFullWidth===width&&this.trueFullHeight===height||(this.resizeSilently(width,height),this.loaded=!0)},resizeSilently:function(width,height){if(this.trueFullWidth!==width||this.trueFullHeight!==height){this.flags|=this.TextureFlag.RESIZED,this.trueFullWidth=width,this.trueFullHeight=height,this.calcFrame();var unitRatio=meta.engine.unitRatio;this.width=this.frameWidth*unitRatio+.5|0,this.height=this.frameHeight*unitRatio+.5|0,this.fullWidth=this.trueFullWidth*unitRatio+.5|0,this.fullHeight=this.trueFullHeight*unitRatio+.5|0,this.halfWidth=.5*this.width,this.halfHeight=.5*this.height,this._loaded&&this.canvas.width>1&&this.canvas.height>1?(this._tmpImg.width=this.canvas.width,this._tmpImg.height=this.canvas.height,this._tmpCtx.drawImage(this.canvas,0,0),this.canvas.width=this.trueFullWidth,this.canvas.height=this.trueFullHeight,this.ctx.drawImage(this._tmpImg,0,0)):(this.canvas.width=this.trueFullWidth,this.canvas.height=this.trueFullHeight)}},upResize:function(width,height){width<this.trueFullWidth&&(width=this.trueFullWidth),height<this.trueFullHeight&&(height=this.trueFullHeight),this.resize(width,height)},draw:function(ctx,x,y){this.ptr?ctx.drawImage(this.ptr.canvas,this.x,this.y,this.width,this.height,x,y,this.width,this.height):ctx.drawImage(this.canvas,x,y)},drawFrame:function(ctx,x,y,frame){this.frameData?this.frameData[frame].texture.draw(ctx,x,y):ctx.drawImage(this.canvas,this.frameWidth*(frame%this.framesX),this.frameHeight*Math.floor(frame/this.framesX),this.frameWidth,this.frameHeight,x,y,this.frameWidth,this.frameHeight)},clear:function(){this.ctx.clearRect(0,0,this.trueFullWidth,this.trueFullHeight)},drawOver:function(texture,x,y){if(texture){if(x=x||0,y=y||0,"string"==typeof texture){var obj=meta.resources.textures[texture];if(!obj)return void console.warn("(Resource.Texture.drawOver) No such texture with name - "+texture);texture=obj}if(texture.textureType===Resource.TextureType.WEBGL){if(!texture._canvasCache)return texture._canvasCache=new Resource.Texture(Resource.TextureType.CANVAS,texture.path),texture._canvasCache.load(),texture=texture._canvasCache,this._loadCache={name:"drawOver",texture:texture,x:x,y:y},this.loaded=!1,void texture.subscribe(this.onTextureCacheEvent,this);texture=texture._canvasCache}var ctx=this.ctx;if(this.textureType&&(this._createCachedImg(),ctx=this._cachedCtx),ctx.drawImage(texture.image,x,y),this.textureType){var gl=meta.ctx;gl.bindTexture(gl.TEXTURE_2D,this.image),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,this._cachedImg)}this.loaded=!0}else console.warn("(Resource.Texture.drawOver) No texture specified.")},generateAlphaMask:function(){if(this._loaded){if(0===this.textureType){var alphaMask=new Resource.Texture(Resource.TextureType.CANVAS);alphaMask.resize(this.trueFullWidth,this.trueFullHeight);for(var imgData=this.ctx.getImageData(0,0,this.trueFullWidth,this.trueFullHeight),data=imgData.data,numBytes=data.length,i=0;i<numBytes;i+=4)data[i]=255,data[i+1]=255,data[i+2]=255;return alphaMask.ctx.putImageData(imgData,0,0),alphaMask.loaded=!0,alphaMask}console.warn("([)Resource.Texture.generateMask): Only canvas textures are supported currently.")}else console.warn("(Resource.Texture.generateMask): Texture is not loaded yet.")},onTextureCacheEvent:function(data,event){event===Resource.Event.LOADED&&(data.unsubscribe(this),"drawOver"===this._loadCache.name?this.drawOver(this._loadCache.texture,this._loadCache.x,this._loadCache.y):this[this._loadCache.name](this._loadCache.data),this._loadCache=null)},offset:function(x,y){this.offsetX=x,this.offsetY=y,this._loaded&&this.emit(this,Resource.Event.CHANGED)},getData:function(){return this.ctx.getImageData(0,0,this.frameWidth,this.frameHeight).data},getPixelAt:function(x,y){return this.ctx.getImageData(x,y,1,1).data},applyCanvas:function(canvas){this.canvas=canvas,this.ctx=canvas.getContext("2d"),this.resize(canvas.width,canvas.height)},TextureFlag:{RESIZED:1},Frame:function(texture,x,y){this.texture=texture,this.x=x,this.y=y},type:Resource.Type.TEXTURE,ptr:null,canvas:null,ctx:null,flags:0,x:0,y:0,width:0,height:0,_width:0,_height:0,fullWidth:0,fullHeight:0,trueFullWidth:0,trueFullHeight:0,_widthRatio:0,_heightRatio:0,offsetX:0,offsetY:0,unitRatio:1,fps:9,frames:1,framesX:1,framesY:1,frameData:null,reloading:!1,_tmpImg:null,_tmpCtx:null,_cachedImg:null,_cachedCtx:null,_numToLoad:0,_loadCache:null,_canvasCache:null}),Resource.Texture.prototype._tmpImg=document.createElement("canvas"),Resource.Texture.prototype._tmpCtx=Resource.Texture.prototype._tmpImg.getContext("2d"),meta.class("Resource.Sound","Resource.Basic",{onInit:function(data,tag){this._instances=[],this._prepare(),"string"==typeof data&&this.load(data)},_prepare:null,_prepare_Audio:function(){var self=this;this._context=this._getInstance(),this._context.audio.addEventListener("error",function(){self.format?self._onLoadFailed():self._loadNextExtension()}),this._numInstancesUsed=0},_prepare_WebAudio:function(){var self=this;this._request=new XMLHttpRequest,this._request.responseType="arraybuffer",this._request.onreadystatechange=function(){self._onStateChange()},this._gainNode=meta.audio.context.createGain(),this._gainNode.connect(meta.audio.gainNode)},load:function(path){if(!this.loading){var wildCardIndex=path.lastIndexOf(".");-1!==wildCardIndex&&path.length-wildCardIndex<=5?(this.format=path.substr(wildCardIndex+1,path.length-wildCardIndex-1),this.path=meta.resources.rootPath+path.substr(0,wildCardIndex)):this.path=meta.resources.rootPath+path,this.loading=!0,this.loaded=!1,meta.resources.addToLoad(this),this._loadNextExtension()}},_loadNextExtension:function(){var path,formats=meta.device.audioFormats,numFormats=formats.length;if(this.format){for(var supported=!1,n=0;n<numFormats;n++)if(this.format===formats[n]){supported=!0;break}if(!supported)return console.log("(Resource.Sound) Trying to load unsupported sound format: "+this.format),void this._onLoadFailed();path=this.path+"."+this.format}else{if(++this._requestFormat>numFormats)return void this._onLoadFailed();path=this.path+"."+meta.device.audioFormats[this._requestFormat-1]}this._loadFromPath(path)},_loadFromPath:null,_loadFromPath_WebAudio:function(path){this._request.open("GET",path,!0),this._request.send()},_loadFromPath_Audio:function(path){this._context.audio.src=path,this._context.audio.load()},_onStateChange:function(){if(4===this._request.readyState)if(200===this._request.status){meta.resources.nextStep(this);var self=this;this._context.decodeAudioData(this._request.response,function(buffer){self._onDecodeSuccess(buffer)},function(error){self._onDecodeError(error)}),this._request=null}else this.format?this._onLoadFailed():this._loadNextExtension()},_onDecodeSuccess:function(buffer){this.format||(this.path+="."+meta.device.audioFormats[this._requestFormat-1]),this._buffer=buffer,this._loading=!1,this.loaded=!0,meta.resources.loadSuccess(this);for(var instance,numInstances=this._instances.length,i=0;i<numInstances;i++)(instance=this._instances[i]).autoPlay&&instance.play()},_onDecodeError:function(error){console.log(error),this.format||(this.path+="."+meta.device.audioFormats[this._requestFormat-1]),console.warn("(Resource.Sound.load) Error decoding file: "+this.path),this._loading=!1,meta.resources.loadFailed(this)},_onLoadFailed:function(){if(!this.format){var format=meta.device.audioFormats[this._requestFormat-1];format&&(this.path+="."+format)}console.warn("(Resource.Sound.load) Error loading file: "+this.path),this._loading=!1,meta.resources.loadFailed(this)},onEnd:null,play:function(looping,offset){meta.audio.audioAPI&&(this._gainNode.gain.value=this._volume),this._getInstance().play(looping,offset)},stop:function(){meta.audio.audioAPI&&(this._gainNode.gain.value=0);for(var i=0;i<this._numInstancesUsed;i++)this._instances[i].stop()},pause:function(){meta.audio.audioAPI&&(this._gainNode.gain.value=0);for(var i=0;i<this._numInstancesUsed;i++)this._instances[i].pause()},resume:function(){meta.audio.audioAPI&&(this._gainNode.gain.value=this._volume);for(var i=0;i<this._numInstancesUsed;i++)this._instances[i].resume()},_createInstance:null,_createInstance_WebAudio:function(){return new Resource.AudioInstance(this)},_createInstance_Audio:function(){return new Resource.AudioInstance_Audio(this)},_getInstance:function(){this._instances.length===this._numInstancesUsed&&this._instances.push(this._createInstance());var instance=this._instances[this._numInstancesUsed];return instance.id=this._numInstancesUsed,this._numInstancesUsed++,instance},_clearInstance:function(instance){this._numInstancesUsed--;var lastInstance=this._instances[this._numInstancesUsed];lastInstance.id=instance.id,this._instances[instance.id]=lastInstance,this._instances[this._numInstancesUsed]=instance},set volume(value){if(this._volume!==value)if(this._volume=value,meta.audio.audioAPI)this._gainNode.gain.value=value;else for(var numInstances=this._instances.length,i=0;i<numInstances;i++)this._instances[i].volume=value},get volume(){return this._volume},get playing(){var instance=this._instances[0];return!!instance&&instance.playing},get paused(){var instance=this._instances[0];return!!instance&&instance.paused},get looping(){var instance=this._instances[0];return!!instance&&instance.looping},get duration(){if(meta.audio.audioAPI){if(this._buffer)return this._buffer.duration;var instance=this._instances[0];if(!instance)return;return instance.audio.duration}},set currentTime(offset){var instance=this._instances[0];instance&&(instance.currentTime=offset)},get currentTime(){var instance=this._instances[0];if(instance)return instance.currentTime},type:Resource.Type.SOUND,format:"",_instances:null,_numInstancesUsed:0,_context:null,_buffer:null,_request:null,_requestFormat:0,_gainNode:null,_volume:1}),Resource.AudioInstance=function(parent){this.parent=parent,this.id=-1,this.source=null,this.looping=!1,this.paused=!1,this.playing=!1,this.offset=0,this.tStart=0,this.tPaused=0;var self=this;this.onEndFunc=function(){self.parent.onEnd&&self.parent.onEnd(self.parent),self.paused||(self.looping?(self.source.disconnect(),self.play(!0,0)):self.parent._clearInstance(self))}},Resource.AudioInstance.prototype={play:function(looping,offset){looping=looping||!1,offset=offset||0,this.paused=!1,this.parent._loaded?(this.playing=!0,this.autoPlay?this.autoPlay=!1:(this.looping=looping,this.offset=offset),this.source=meta.audio.context.createBufferSource(),this.source.buffer=this.parent._buffer,this.source.connect(this.parent._gainNode),this.source.onended=this.onEndFunc,this.offset<0?this.offset=0:this.offset>this.source.buffer.duration&&(this.offset=this.source.buffer.duration),this.source.start(0,this.offset),this.tStart=this.source.context.currentTime-this.offset):(this.autoPlay=!0,this.looping=looping,this.offset=offset)},stop:function(){this.source&&(this.paused=!1,this.looping=!1,this.source.stop(this.source.context.currentTime+.2))},pause:function(){this.paused||(this.paused=!0,this.playing?this.tPaused=this.source.context.currentTime-this.tStart:this.tPaused=0,this.source&&(this.source.disconnect(this.parent._gainNode),this.source.stop(0)))},resume:function(){this.play(this.looping,this.tPaused)},set currentTime(offset){this.stop(),this.play(this.looping,offset)},get currentTime(){if(this.playing)return this.source.context.currentTime-this.tStart},autoPlay:!1},Resource.AudioInstance_Audio=function(parent){this.parent=parent,this.id=-1,this.looping=!1,this.paused=!1,this.playing=!1,this.offset=0,this.audio=new Audio,this.audio.preload="auto",this._canPlay=!1,this._metaLoaded=!1,this._loaded=!1;var self=this;this._canPlayFunc=function(){self.audio.removeEventListener("canplaythrough",self._canPlayFunc),self._canPlay=!0,meta.device.support.onloadedmetadata&&self._metaLoaded&&self._onLoaded()},this._metaFunc=function(){self.audio.removeEventListener("loadedmetadata",self._metaFunc),self._metaLoaded=!0,self.canPlay&&self._onLoaded()},this._onEndedFunc=function(){self._onEnd()},this._addEvents(parent)},Resource.AudioInstance_Audio.prototype={play:function(looping,offset){looping=looping||!1,offset=offset||0,this.paused=!1,this._loaded?(this.playing=!0,this.autoPlay?this.autoPlay=!1:(this.looping=looping,this.offset=offset),this.audio.currentTime=this.offset,this.audio.play()):(this.autoPlay=!0,this.looping=looping,this.offset=offset)},stop:function(){this.playing=!1,this.audio.pause(),this.parent._clearInstance(this)},pause:function(){this.playing=!1,this.audio.pause()},resume:function(){this.playing=!0,this.audio.play()},_addEvents:function(){this.audio.addEventListener("canplaythrough",this._canPlayFunc,!1),meta.device.support.onloadedmetadata&&this.audio.addEventListener("loadedmetadata",this._metaFunc,!1),this.audio.addEventListener("ended",this._onEndedFunc,!1),this.parent._loaded&&(this.audio.src=this.parent.fullPath,this.audio.load())},_onLoaded:function(){if(!this.parent._loaded){this.parent.format||(this.parent.path+="."+meta.device.audioFormats[this.parent._requestFormat-1]),this.parent._loading=!1,this.parent.loaded=!0,this.parent.fullPath=this.parent.path+"."+this.parent.format;for(var instance,instances=this.parent._instances,numInstances=this.parent._instances.length,i=1;i<numInstances;i++)(instance=instances[i]).audio.src=this.parent.fullPath,instance.audio.load();meta.resources.loadSuccess(parent),meta.resources.loadNextFromQueue()}this._loaded=!0,this.autoPlay&&this.play(!1,0)},_onEnd:function(){this.looping?(this.audio.play(),this.audio.currentTime=0):this.playing&&(this.playing=!1,this.parent._clearInstance(this))},set currentTime(time){this.playing?this.audio.currentTime=time||0:(this.audio.play(),this.audio.currentTime=time||0,this.audio.pause())},get currentTime(){return this.audio.currentTime},set volume(value){var mixedVolume=value*meta.audio._volume;this.audio.volume=mixedVolume},autoPlay:!1},meta.class("Resource.SpriteSheet","Resource.Basic",{onInit:function(param,path){if("string"==typeof param)path=param,param=void 0;else for(var key in param)this[key]=param[key];if(path){var wildCardIndex=path.lastIndexOf(".");-1!==wildCardIndex&&path.length-wildCardIndex<=5&&(this.format=path.substr(wildCardIndex+1,path.length-wildCardIndex-1),path=path.substr(0,wildCardIndex)),this.path=meta.resources.rootPath+path,this.format||(this.format="xml"),this.load(this.path)}},load:function(){if(!this.loading){this.loading=!0,this.loaded=!1,this._atlasLoaded=!1,this.texture?"string"==typeof this.texture&&(this.texture=new Resource.Texture(this.texture)):this.texture=new Resource.Texture(this.path),this.texture.subscribe(this._onTextureEvent,this);var self=this,atlasPath=this.path+"."+this.format;this._request=new XMLHttpRequest,this._request.open("GET",atlasPath,!0),this._request.onreadystatechange=function(){self._onStateChange()},this._request.send(),meta.resources.addToLoad(this)}},loadData:function(data,format){(format=format||this.format)||(format="xml"),this.format=format;var result=!1;if("xml"===format){var xml=(parser=new DOMParser).parseFromString(data,"text/xml");result=this.loadXML(xml)}else if("json"===format){var json=JSON.parse(data);result=this.loadJSON(json)}else if("plist"===format){var parser=new DOMParser,plist=parser.parseFromString(data,"text/xml");result=this.loadPlist(plist)}else console.warn("(Resource.SpriteSheet.loadData):","Trying to load an unsupported format - "+this.format);return this.loaded=result,result},_createTexture:function(name,x,y,width,height){var texture=meta.resources.createTexture(name);return texture.ptr=this.texture,texture.canvas=this.texture.canvas,texture.x=x,texture.y=y,texture.width=width,texture.height=height,texture.loaded=!0,texture},loadFromImg:function(path,frameWidth,frameHeight,margin,spacing){var self=this;this.texture=new Resource.Texture(path),this.texture.subscribe(function(){self._generateFromImg(frameWidth,frameHeight,margin,spacing)})},_generateFromImg:function(frameWidth,frameHeight,margin,spacing){var trueFrameWidth=frameWidth+2*spacing,trueFrameHeight=frameWidth+2*spacing,rawFramesX=this.texture.trueFullWidth/trueFrameWidth,rawFramesY=this.texture.trueFullHeight/trueFrameHeight,framesX=Math.floor(rawFramesX),framesY=Math.floor(rawFramesY),numFrames=framesX*framesY;this.frames=new Array(numFrames);var posX,posY,offset=margin,id=0;if(rawFramesX!==framesX||rawFramesY!==framesY)for(var width,height,offsetX,offsetY,maxWidth=this.texture.trueFullWidth,maxHeight=this.texture.trueFullHeight,y=0;y<framesY;y++){width=0,offsetY=(height+=frameHeight)>maxHeight?maxHeight-height:0;for(x=0;x<framesX;x++)offsetX=(width+=frameWidth)>maxWidth?maxWidth-width:0,posX=x*frameWidth+x*(2*margin)+offset,posY=y*frameHeight+y*(2*margin)+offset,this.frames[id]=this._createTexture(this.texture.name+"$$"+id,posX,posY,frameWidth+offsetX,frameHeight+offsetY),id++}else for(y=0;y<framesY;y++)for(var x=0;x<framesX;x++)posX=x*frameWidth+x*(2*margin)+offset,posY=y*frameHeight+y*(2*margin)+offset,this.frames[id]=this._createTexture(this.texture.name+"$$"+id,posX,posY,frameWidth,frameHeight),id++;this.loaded=!0},loadXML:function(xml){if(!xml)return console.warn("(Resource.SpriteSheet.loadXML) Invalid XML file."),!1;for(var node,childNodes=xml.documentElement.childNodes,numNodes=childNodes.length,i=0;i<numNodes;i++)if("SubTexture"===(node=childNodes[i]).nodeName)this._createTexture(node.getAttribute("name"),parseInt(node.getAttribute("x")),parseInt(node.getAttribute("y")),parseInt(node.getAttribute("width")),parseInt(node.getAttribute("height")));else if("sprite"===node.nodeName)this._createTexture(node.getAttribute("n"),parseInt(node.getAttribute("x")),parseInt(node.getAttribute("y")),parseInt(node.getAttribute("w")),parseInt(node.getAttribute("h")));else if("dict"===node.nodeName)return this.loadPlist(xml);return!0},loadPlist:function(plist){if(!plist)return console.warn("(Resource.SpriteSheet.loadPlist) Invalid Plist file"),!1;for(var node,childNodes=plist.documentElement.childNodes,numNodes=childNodes.length,i=0;i<numNodes;i++)if("dict"===(node=childNodes[i]).nodeName)return this._loadPlist_dict(node)},_loadPlist_dict:function(node){for(var nodes=node.childNodes,numNodes=nodes.length,command="",i=0;i<numNodes;i++)if("key"===(node=nodes[i]).nodeName)command=node.textContent;else if("dict"===node.nodeName){if(!command)continue;"frames"===command&&this._loadPlist_frames(node)}},_loadPlist_frames:function(node){for(var nodes=node.childNodes,numNodes=nodes.length,name="",i=0;i<numNodes;i++)"key"===(node=nodes[i]).nodeName?name=node.textContent:"dict"===node.nodeName&&this._loadPlist_frame(node,name)},_loadPlist_frame:function(node,name){for(var data,nodes=node.childNodes,numNodes=nodes.length,command="",i=0;i<numNodes;i++)if("key"===(node=nodes[i]).nodeName)command=node.textContent;else if("string"===node.nodeName&&"frame"===command)return data=node.textContent.match(/[0-9]+/g),void this._createTexture(name,parseInt(data[0]),parseInt(data[1]),parseInt(data[2]),parseInt(data[3]))},loadJSON:function(json){return json?(json.frames instanceof Array?this._loadJSON_array(json):this._loadJSON_hash(json),!0):(console.warn("(Resource.SpriteSheet.loadFromJSON) Invalid JSON file."),!1)},_loadJSON_array:function(json){for(var frame,frameInfo,frames=json.frames,numFrames=frames.length,i=0;i<numFrames;i++)frameInfo=(frame=frames[i]).frame,this._createTexture(frame.filename,frameInfo.x,frameInfo.y,frameInfo.w,frameInfo.h)},_loadJSON_hash:function(json){var frame,frames=json.frames;for(var key in frames)frame=frames[key].frame,this._createTexture(key,frame.x,frame.y,frame.w,frame.h)},_onTextureEvent:function(data,event){event===Resource.Event.LOADED&&(this.texture.unsubscribe(this),this._atlasLoaded&&(this.loadData(this._response,this.format),meta.resources.loadSuccess(this),this._response=null))},_onStateChange:function(){4===this._request.readyState&&(200===this._request.status?(this._atlasLoaded=!0,this._response=this._request.response,this._request=null,this.texture._loaded&&(this.loadData(this._response,this.format),meta.resources.loadSuccess(this),this._response=null)):(this._loaded=!1,this._request.onreadystatechange=null,this._request=null,meta.resources.loadFailed(this)))},type:Resource.Type.SPRITE_SHEET,format:"",texture:null,frames:null,_request:null,_response:null,_atlasLoaded:!1}),meta.class("Resource.Font","Resource.Basic",{onInit:function(path,tag){path&&this.load(meta.resources.rootPath+path)},load:function(path){if(!this.loading&&(this.loaded=!1,path)){this.path=path;var wildCardIndex=this.path.lastIndexOf(".");-1===wildCardIndex||this.path.length-wildCardIndex>4?(this.path+=".fnt",this.format="fnt"):this.format=this.path.substr(wildCardIndex+1);var parseFunc=this["parse_"+this.format];if(parseFunc){this.chars=new Array(256),meta.resources.addToLoad(this),this.texture=new Resource.Texture(path),this.texture.subscribe(this._onTextureEvent,this);var self=this;meta.ajax({url:this.path,success:function(data){parseFunc.call(self,data)},error:function(){self._onError()}})}else console.warn("(Resource.Font.load) Unsupported format: "+this.format)}},_onError:function(){meta.resources.loadFailed(this)},parse_fnt:function(data){for(this.tokenizer.setup(data),this.tokenizer.nextToken();0!==this.tokenizer.token.type;)this._parseToken_fnt();var currChar;for(var key in this.chars)(currChar=this.chars[key]).offsetY>this._minOffsetY&&(currChar.offsetY-=this._minOffsetY);this._loadedFormat=!0,this.texture._loaded&&(meta.resources.loadSuccess(this),this.loaded=!0)},_parseToken_fnt:function(){var token=this.tokenizer.token,line=token.line;switch(token.str){case"char":for(var rect=new this.Rect;(token=this.tokenizer.nextToken()).line===line;)switch(token.str){case"id":this.tokenizer.nextToken(),token=this.tokenizer.nextToken(),this.chars[token.value]=rect;break;case"x":this.tokenizer.nextToken(),token=this.tokenizer.nextToken(),rect.x=token.value;break;case"y":this.tokenizer.nextToken(),token=this.tokenizer.nextToken(),rect.y=token.value;break;case"yoffset":this.tokenizer.nextToken(),token=this.tokenizer.nextToken(),rect.offsetY=token.value,token.value<this._minOffsetY&&0!==token.value&&(this._minOffsetY=token.value);break;case"width":this.tokenizer.nextToken(),token=this.tokenizer.nextToken(),rect.width=token.value;break;case"height":this.tokenizer.nextToken(),token=this.tokenizer.nextToken(),rect.height=token.value,this.height<token.value&&(this.height=token.value);break;case"xadvance":this.tokenizer.nextToken(),token=this.tokenizer.nextToken(),rect.kerning=token.value}break;default:this.tokenizer.nextToken()}},_onTextureEvent:function(data,event){switch(event){case Resource.Event.LOADED:this._loadedFormat&&(meta.resources.loadSuccess(this),this.loaded=!0);break;case Resource.Event.FAILED:}},Rect:function(){this.x=0,this.y=0,this.width=0,this.height=0,this.kerning=0,this.offsetY=0},tokenizer:meta.tokenizer,type:Resource.Type.FONT,format:"",texture:null,chars:null,height:1,_loadedFormat:!1,_minOffsetY:Number.MAX_VALUE}),meta.class("Resource.SVG","Resource.Texture",{fillRect:function(x,y,width,height){0==(this.flags&this.TextureFlag.RESIZED)&&this.resizeSilently(width+x,height+y),this.ctx.fillStyle=this._fillStyle,this.ctx.fillRect(x,y,width,height),this.loaded=!0},line:function(x1,y1,x2,y2){if(0==(this.flags&this.TextureFlag.RESIZED)){var maxX,maxY;x1<x2?(x1,maxX=x2):(x2,maxX=x1),y1<y2?(y1,maxY=y2):(y2,maxY=y1),this.resizeSilently(maxX,maxY)}this.ctx.strokeStyle=this._strokeStyle,this.ctx.lineWidth=this._lineWidth,this.ctx.beginPath(),this.ctx.moveTo(x1,y1),this.ctx.lineTo(x2,y2),this.ctx.stroke(),this.loaded=!0},rect:function(x,y,width,height){var offset;offset=this._lineWidth%2==1?.5:0,0==(this.flags&this.TextureFlag.RESIZED)&&(offset?this.resizeSilently(width+x+1,height+y+1):this.resizeSilently(width+x,height+y)),this.ctx.save(),this.ctx.translate(offset,offset),this.ctx.beginPath(),this.ctx.rect(x,y,width,height),this._fillStyle&&(this.ctx.fillStyle=this._fillStyle,this.ctx.fill()),!this._strokeStyle&&this._fillStyle||(this.ctx.lineWidth=this._lineWidth,this.ctx.strokeStyle=this._strokeStyle,this.ctx.stroke()),this.ctx.restore(),this.loaded=!0},circle:function(radius){var offset=this._lineWidth,size=2*(radius+offset);0==(this.flags&this.TextureFlag.RESIZED)&&this.resizeSilently(size,size),this.ctx.beginPath(),this.ctx.arc(radius+offset,radius+offset,radius,0,2*Math.PI,!1),this.ctx.closePath(),this._fillStyle&&(this.ctx.fillStyle=this._fillStyle,this.ctx.fill()),!this._strokeStyle&&this._fillStyle||(this.ctx.lineWidth=this._lineWidth,this.ctx.strokeStyle=this._strokeStyle,this.ctx.stroke()),this.loaded=!0},tileAuto:function(texture,center,offsetX,offsetY){if("string"==typeof texture){var newTexture=meta.resources.textures[texture];if(!newTexture)return void console.warn("(Resource.Texture.tileAuto): Could not get texture with name: "+texture);texture=newTexture}else if(!texture)return void console.warn("(Resource.Texture.tileAuto): Invalid texture");if(texture._loaded){offsetX=offsetX||0,offsetY=offsetY||0;var numX=Math.ceil(this.fullWidth/texture.fullWidth)||1,numY=Math.ceil(this.fullHeight/texture.fullHeight)||1,textureWidth=numX*(texture.fullWidth+offsetX)+offsetX,textureHeight=numY*(texture.fullHeight+offsetY)+offsetY,textureOffsetX=offsetX,textureOffsetY=offsetY;center&&(textureOffsetX=.5*-(textureWidth-this.fullWidth),textureOffsetY=.5*-(textureHeight-this.fullHeight));for(var posX=textureOffsetX,posY=textureOffsetY,x=0;x<numX;x++){for(var y=0;y<numY;y++)this.ctx.drawImage(texture.canvas,posX,posY),posY+=texture.frameHeight+offsetY;posX+=texture.frameWidth+offsetX,posY=textureOffsetY}this.loaded=!0}else{this.loaded=!1;var self=this;texture.subscribe(function(data,event){self.tileAuto(texture,center,offsetX,offsetY)},this)}},tile:function(texture,numX,numY,offsetX,offsetY){if("string"==typeof texture){var newTexture=meta.resources.textures[texture];if(!newTexture)return void console.warn("(Resource.Texture.tile): Could not get texture with name: "+texture);texture=newTexture}else if(!texture)return void console.warn("(Resource.Texture.tile): Invalid texture");if(texture._loaded){var textureWidth=numX*(texture.fullWidth+offsetX)+offsetX,textureHeight=numY*(texture.fullHeight+offsetY)+offsetY;this.resizeSilently(textureWidth,textureHeight);for(var textureOffsetY=offsetY,posX=offsetX,posY=textureOffsetY,x=0;x<numX;x++){for(var y=0;y<numY;y++)this.ctx.drawImage(texture.canvas,posX,posY),posY+=texture.frameHeight+offsetY;posX+=texture.frameWidth+offsetX,posY=textureOffsetY}this.loaded=!0}else{this.loaded=!1;var self=this;texture.subscribe(function(data,event){self.tile(data,numX,numY,offsetX,offsetY)},this)}},shape:function(buffer){meta;var i,x,y,minX=Number.POSITIVE_INFINITY,minY=minX,maxX=Number.NEGATIVE_INFINITY,maxY=maxX,numItems=buffer.length;for(i=0;i<numItems;i+=2)x=1*buffer[i]|0,y=1*buffer[i+1]|0,x<minX&&(minX=x),y<minY&&(minY=y),x>maxX&&(maxX=x),y>maxY&&(maxY=y),buffer[i]=x,buffer[i+1]=y;minX>0&&(minX=0),minY>0&&(minY=0);var ctx=this.ctx,halfLineWidth=this._lineWidth/2,offsetX=-minX+halfLineWidth,offsetY=-minY+halfLineWidth;for(0==(this.flags&this.TextureFlag.RESIZED)&&this.resizeSilently(maxX-minX+this._lineWidth,maxY-minY+this._lineWidth),ctx.lineWidth=this._lineWidth,this._lineCap&&(ctx.lineCap=this._lineCap),this._lineDash&&ctx.setLineDash(this._lineDash),ctx.translate(.5,.5),ctx.beginPath(),ctx.moveTo(buffer[0]+offsetX,buffer[1]+offsetY),i=2;i<numItems;i+=2)ctx.lineTo(buffer[i]+offsetX,buffer[i+1]+offsetY);this.closePath&&ctx.closePath(),this._fillStyle&&(this.ctx.fillStyle=this._fillStyle,this.ctx.fill()),!this._strokeStyle&&this._fillStyle||(this.ctx.lineWidth=this._lineWidth,this.ctx.strokeStyle=this._strokeStyle,this.ctx.stroke()),this.loaded=!0},arc:function(radius,startAngle,endAngle,counterClockwise){if(0==(this.flags&this.TextureFlag.RESIZED)){var size=2*(radius+this._lineWidth);this.resizeSilently(size,size)}this.ctx.beginPath(),this.ctx.arc(radius+this._lineWidth,radius+this._lineWidth,radius,startAngle,endAngle,!1),this.closePath&&this.ctx.closePath(),this._fillStyle&&(this.ctx.fillStyle=this._fillStyle,this.ctx.fill()),!this._strokeStyle&&this._fillStyle||(this.ctx.lineWidth=this._lineWidth,this.ctx.strokeStyle=this._strokeStyle,this.ctx.stroke()),this.loaded=!0},roundRect:function(width,height,radius){var offset;offset=this._lineWidth%2==1?.5:0,0==(this.flags&this.TextureFlag.RESIZED)&&(offset?this.resizeSilently(width+1,height+1):this.resizeSilently(width,height));var halfWidth=Math.ceil(this._lineWidth/2);this.ctx.save(),this.ctx.translate(offset,offset),this.ctx.beginPath(),this.ctx.moveTo(halfWidth+radius,halfWidth),this.ctx.lineTo(width-halfWidth-radius,halfWidth),this.ctx.quadraticCurveTo(width-halfWidth,halfWidth,width-halfWidth,halfWidth+radius),this.ctx.lineTo(width-halfWidth,height-halfWidth-radius),this.ctx.quadraticCurveTo(width-halfWidth,height-halfWidth,width-halfWidth-radius,height-halfWidth),this.ctx.lineTo(halfWidth+radius,height-halfWidth),this.ctx.quadraticCurveTo(halfWidth,height-halfWidth,halfWidth,height-halfWidth-radius),this.ctx.lineTo(halfWidth,radius+halfWidth),this.ctx.quadraticCurveTo(halfWidth,halfWidth,halfWidth+radius,halfWidth),this.ctx.closePath(),this._fillStyle&&(this.ctx.fillStyle=this._fillStyle,this.ctx.fill()),!this._strokeStyle&&this._fillStyle||(this.ctx.lineWidth=this._lineWidth,this.ctx.strokeStyle=this._strokeStyle,this.ctx.stroke()),this.ctx.restore(),this.loaded=!0},gradient:function(buffer){for(var gradient=this.ctx.createLinearGradient(0,0,0,this.fullHeight),numStops=buffer.length,n=0;n<numStops;n+=2)gradient.addColorStop(buffer[n],buffer[n+1]);this.ctx.clearRect(0,0,this.fullWidth,this.fullHeight),this.ctx.fillStyle=gradient,this.ctx.fillRect(0,0,this.fullWidth,this.fullHeight),this.loaded=!0},grid:function(numX,numY,sizeX,sizeY){var width=numX*sizeX,height=numY*sizeY;0==(this.flags&this.TextureFlag.RESIZED)&&this.resizeSilently(width+this.lineWidth,height+this.lineWidth),this.ctx.strokeStyle=this.strokeStyle,this.ctx.lineWidth=this.lineWidth;var lineOffset=.5*this.lineWidth;this.ctx.save(),this.ctx.translate(lineOffset,lineOffset);for(var offset=0,x=0;x<=numX;x++)this.ctx.moveTo(offset,0),this.ctx.lineTo(offset,height),offset+=sizeX;offset=0;for(var y=0;y<=numY;y++)this.ctx.moveTo(-lineOffset,offset),this.ctx.lineTo(width+lineOffset,offset),offset+=sizeY;this.ctx.stroke(),this.ctx.restore(),this.loaded=!0},set lineWidth(value){this._lineWidth=value},get lineWidth(){return this._lineWidth},set fillStyle(hex){this._fillStyle=hex},get fillStyle(){return this._fillStyle},set strokeStyle(hex){this._strokeStyle=hex},get strokeStyle(){return this._strokeStyle},Cache:function(name,data){this.name=name,this.data=data},_lineWidth:2,_lineCap:"",_lineDash:"",_fillStyle:"",_strokeStyle:"",closePath:!1}),window.Input={BUTTON_ENUM_OFFSET:2e3},Input.Event={DOWN:"inputDown",UP:"inputUp",MOVE:"inputMove",CLICK:"inputClick",DBCLICK:"inputDbClick"},Input.Key={BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,ESC:27,SPACE:32,LEFT:37,UP:38,RIGHT:39,DOWN:40,DELETE:46,NUM_0:48,NUM_1:49,NUM_2:50,NUM_3:51,NUM_4:52,NUM_5:53,NUM_6:54,NUM_7:55,NUM_8:56,NUM_9:57,NUMPAD_0:96,NUMPAD_1:97,NUMPAD_2:98,NUMPAD_3:99,NUMPAD_4:100,NUMPAD_5:101,NUMPAD_6:102,NUMPAD_7:103,NUMPAD_8:104,NUMPAD_9:105,MULTIPLY:106,ADD:107,SUBTRACT:109,DECIMAL:110,DIVIDE:111,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,SQUARE_BRACKET_LEFT:91,SQUARE_BRACKET_RIGHT:91,PARENTHESES_LEFT:91,PARENTHESES_RIGHT:91,BRACES_LEFT:91,BRACES_RIGHT:92,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,PLUS:187,MINUS:189,TILDE:192,APOSTROPHE:222,BUTTON_LEFT:0+Input.BUTTON_ENUM_OFFSET,BUTTON_MIDDLE:1+Input.BUTTON_ENUM_OFFSET,BUTTON_RIGHT:2+Input.BUTTON_ENUM_OFFSET},meta.class("Input.Manager",{init:function(){var numTotalKeys=this.numKeys+this.numInputs+1;this.keys=new Array(numTotalKeys),this.touches=[],this.pressed={},this.keybind={},this._event={event:null,type:"",x:0,y:0,prevScreenX:0,prevScreenY:0,screenX:0,screenY:0,keyCode:0,entity:null,keyboard:!1},this._addEventListeners(),this._loadIgnoreKeys(),meta.engine.onBlur.add(this.resetInput,this),this.keyID=new Array(numTotalKeys);var keyEnum=Input.Key;for(var key in keyEnum)this.keyID[keyEnum[key]]=key},_addEventListeners:function(){this.onDown=meta.createChannel(Input.Event.DOWN),this.onUp=meta.createChannel(Input.Event.UP),this.onMove=meta.createChannel(Input.Event.MOVE),this.onClick=meta.createChannel(Input.Event.CLICK),this.onDbClick=meta.createChannel(Input.Event.DBCLICK);var self=this;window.addEventListener("mousedown",function(event){self.handleMouseDown(event)}),window.addEventListener("mouseup",function(event){self.handleMouseUp(event)}),window.addEventListener("mousemove",function(event){self.handleMouseMove(event)}),window.addEventListener("dblclick",function(event){self.handleMouseDbClick(event)}),window.addEventListener("touchstart",function(event){self.handleTouchDown(event)}),window.addEventListener("touchend",function(event){self.handleTouchUp(event)}),window.addEventListener("touchmove",function(event){self.handleTouchMove(event)}),window.addEventListener("touchcancel",function(event){self.handleTouchUp(event)}),window.addEventListener("touchleave",function(event){self.handleTouchUp(event)}),meta.device.support.onkeydown&&window.addEventListener("keydown",function(event){self.handleKeyDown(event)}),meta.device.support.onkeyup&&window.addEventListener("keyup",function(event){self.handleKeyUp(event)})},handleKeyDown:function(event){var keyCode=event.keyCode;if(document.activeElement===document.body&&(window.top&&this._iframeKeys[keyCode]&&event.preventDefault(),void 0!==this._cmdKeys[keyCode]&&this._numCmdKeys++,void 0!==this._ignoreKeys[keyCode]&&this._numCmdKeys<=0&&event.preventDefault()),!(this.blockInput||this.stickyKeys&&this.keys[keyCode])){if("Meta"===event.keyIdentifier)this.metaPressed=!0;else if(this.metaPressed)return;if(this.keys[keyCode]=1,this.pressed[this.keyID[keyCode]]=1,this._keybindMap&&this._keybindMap[keyCode])for(var buffer=this._keybindMap[keyCode],num=buffer.length,n=0;n<num;n++)this.keybind[buffer[n]]=1;if(this._event.event=event,this._event.prevScreenX=0,this._event.prevScreenY=0,this._event.screenX=0,this._event.screenY=0,this._event.x=0,this._event.y=0,this._event.keyCode=keyCode,this._event.keyboard=!0,this.onDown.emit(this._event,Input.Event.DOWN),this.keyRepeat){if(!this._inputTimer){var self=this;this._inputTimer=meta.addTimer(this,function(){self._event.keyCode=self._repeatKey,self.onDown.emit(self._event,Input.Event.DOWN)},this.keyRepeat)}this._repeatKey=keyCode,this._inputTimer.resume(),this._inputTimer.tAccumulator=0}}},handleKeyUp:function(event){var keyCode=event.keyCode;if(document.activeElement===document.body&&(window.top&&this._iframeKeys[keyCode]&&event.preventDefault(),void 0!==this._cmdKeys[keyCode]&&this.keys[keyCode]&&this._numCmdKeys--,void 0===this._ignoreKeys[keyCode]&&this._numCmdKeys<=0&&event.preventDefault()),!this.blockInput){if(this.metaPressed=!1,this.keys[keyCode]=0,this.pressed[this.keyID[keyCode]]=0,this._keybindMap&&this._keybindMap[keyCode])for(var buffer=this._keybindMap[keyCode],num=buffer.length,n=0;n<num;n++)this.keybind[buffer[n]]=0;this._event.event=event,this._event.prevScreenX=0,this._event.prevScreenY=0,this._event.prevX=0,this._event.prevY=0,this._event.x=0,this._event.y=0,this._event.keyCode=keyCode,this._event.keyboard=!0,this.onUp.emit(this._event,Input.Event.UP),this.keyRepeat&&this._inputTimer&&this._inputTimer.pause()}},handleMouseDown:function(event){if(!this.blockInput){var keyCode=event.button+Input.BUTTON_ENUM_OFFSET;if(this.keys[keyCode]=1,this.pressed[this.keyID[keyCode]]=keyCode,this._keybindMap&&this._keybindMap[keyCode])for(var buffer=this._keybindMap[keyCode],num=buffer.length,n=0;n<num;n++)this.keybind[buffer[n]]=1;var camera=meta.camera;this.prevScreenX=this.screenX,this.prevScreenY=this.screenX,this.screenX=(event.pageX-this.engine.offsetLeft)/this.engine.scaleX*this.engine.ratio,this.screenY=(event.pageY-this.engine.offsetTop)/this.engine.scaleY*this.engine.ratio,this.x=this.screenX*camera.zoomRatio+camera.volume.x|0,this.y=this.screenY*camera.zoomRatio+camera.volume.y|0,this._event.event=event,this._event.prevScreenX=this.prevScreenX,this._event.prevScreenY=this.prevScreenY,this._event.screenX=this.screenX,this._event.screenY=this.screenY,this._event.x=this.x,this._event.y=this.y,this._event.keyCode=keyCode,this._event.keyboard=!1,this.onDown.emit(this._event,Input.Event.DOWN),this._event.entity=null}},handleMouseUp:function(event){if(!this.blockInput){var keyCode=event.button+Input.BUTTON_ENUM_OFFSET;if(this.keys[keyCode]=0,this.pressed[this.keyID[keyCode]]=0,this._keybindMap&&this._keybindMap[keyCode])for(var buffer=this._keybindMap[keyCode],num=buffer.length,n=0;n<num;n++)this.keybind[buffer[n]]=0;var camera=meta.camera;this.prevScreenX=this.screenX,this.prevScreenY=this.screenY,this.screenX=(event.pageX-this.engine.offsetLeft)/this.engine.scaleX*this.engine.ratio,this.screenY=(event.pageY-this.engine.offsetTop)/this.engine.scaleY*this.engine.ratio,this.x=this.screenX*camera.zoomRatio+camera.volume.x|0,this.y=this.screenY*camera.zoomRatio+camera.volume.y|0,this._event.event=event,this._event.prevScreenX=this.prevScreenX,this._event.prevScreenY=this.prevScreenY,this._event.screenX=this.screenX,this._event.screenY=this.screenY,this._event.x=this.x,this._event.y=this.y,this._event.keyCode=keyCode,this._event.keyboard=!1,this.onUp.emit(this._event,Input.Event.UP),this.onClick.emit(this._event,Input.Event.CLICK),this._event.entity=null}},handleMouseMove:function(event){if(document.activeElement===document.body&&event.preventDefault(),!this.blockInput){var camera=meta.camera;this.prevScreenX=this.screenX,this.prevScreenY=this.screenY,this.screenX=(event.pageX-this.engine.offsetLeft)/this.engine.scaleX*this.engine.ratio,this.screenY=(event.pageY-this.engine.offsetTop)/this.engine.scaleY*this.engine.ratio,this.x=this.screenX*camera.zoomRatio+camera.volume.x|0,this.y=this.screenY*camera.zoomRatio+camera.volume.y|0,this._event.event=event,this._event.prevScreenX=this.prevScreenX,this._event.prevScreenY=this.prevScreenY,this._event.screenX=this.screenX,this._event.screenY=this.screenY,this._event.x=this.x,this._event.y=this.y,this._event.keyCode=-1,this._event.keyboard=!1,this.onMove.emit(this._event,Input.Event.MOVE),this._event.entity=null}},handleMouseDbClick:function(event){if(!this.blockInput){var keyCode=event.button;if(this.keys[keyCode]=0,this.pressed[this.keyID[keyCode]]=0,this._keybindMap&&this._keybindMap[keyCode])for(var buffer=this._keybindMap[keyCode],num=buffer.length,n=0;n<num;n++)this.keybind[buffer[n]]=0;var camera=meta.camera;if(this.prevScreenX=this.screenX,this.prevScreenY=this.screenY,this.screenX=(event.pageX-this.engine.offsetLeft)*this.engine.scaleX*this.engine.ratio,this.screenY=(event.pageY-this.engine.offsetTop)*this.engine.scaleY*this.engine.ratio,this.x=this.screenX*camera.zoomRatio+camera.volume.x|0,this.y=this.screenY*camera.zoomRatio+camera.volume.y|0,this._event.event=event,this._event.prevScreenX=this.prevScreenX,this._event.prevScreenY=this.prevScreenY,this._event.screenX=this.screenX,this._event.screenY=this.screenY,this._event.x=this.x,this._event.y=this.y,this._event.keyCode=keyCode,this._event.keyboard=!1,this.onDbClick.emit(this._event,Input.Event.DBCLICK),this._onUpCBS&&this._onUpCBS[keyCode])for(var cbs=this._onUpCBS[keyCode],numCbs=cbs.length,i=0;i<numCbs;i++)cbs[i](this._event,Input.Event.UP);this._event.entity=null}},handleTouchDown:function(event){document.activeElement===document.body&&event.preventDefault();for(var touch,screenX,screenY,x,y,id,camera=meta.camera,numTouches=event.changedTouches.length,i=0;i<numTouches;i++){id=this.touches.length-1,touch=event.changedTouches[i],this.touches.push(touch.identifier),this.numTouches++,screenX=(touch.pageX-this.engine.offsetLeft)*this.engine.scaleX*this.engine.ratio,screenY=(touch.pageY-this.engine.offsetTop)*this.engine.scaleY*this.engine.ratio,x=screenX*camera.zoomRatio+camera.volume.x|0,y=screenY*camera.zoomRatio+camera.volume.y|0;var keyCode=id+Input.BUTTON_ENUM_OFFSET;if(this.keys[keyCode]=1,id<3&&(this.pressed[this.keyID[keyCode]]=1,this._keybindMap&&this._keybindMap[keyCode]))for(var buffer=this._keybindMap[keyCode],num=buffer.length,n=0;n<num;n++)this.keybind[buffer[n]]=1;this._event.event=event,this._event.prevScreenX=screenX,this._event.prevScreenY=screenY,this._event.screenX=screenX,this._event.screenY=screenY,this._event.x=x,this._event.y=y,this._event.keyCode=keyCode,this._event.keyboard=!1,0===id&&(this.screenX=screenX,this.screenY=screenY,this.x=x,this.y=y),this.onDown.emit(this._event,Input.Event.DOWN),this._event.entity=null}},handleTouchUp:function(event){document.activeElement===document.body&&event.preventDefault();for(var touch,id,screenX,screenY,x,y,camera=meta.camera,numTouches=event.changedTouches.length,i=0;i<numTouches;i++)if(touch=event.changedTouches[i],-1!==(id=this._getTouchID(touch.identifier))){this.touches.splice(id,1),this.numTouches--,screenX=(touch.pageX-this.engine.offsetLeft)*this.engine.scaleX*this.engine.ratio,screenY=(touch.pageY-this.engine.offsetTop)*this.engine.scaleY*this.engine.ratio,x=screenX*camera.zoomRatio+camera.volume.x|0,y=screenY*camera.zoomRatio+camera.volume.y|0;var keyCode=id+Input.BUTTON_ENUM_OFFSET;if(this.keys[keyCode]=0,id<3&&(this.pressed[this.keyID[keyCode]]=0,this._keybindMap&&this._keybindMap[keyCode]))for(var buffer=this._keybindMap[keyCode],num=buffer.length,n=0;n<num;n++)this.keybind[buffer[n]]=0;this._event.event=event,0===id?(this.prevScreenX=this.screenX,this.prevScreenY=this.screenY,this.screenX=screenX,this.screenY=screenY,this.x=x,this.y=y,this._event.prevScreenX=this.prevScreenX,this._event.prevScreenY=this.prevScreenY):(this._event.prevScreenX=0,this._event.prevScreenY=0),this._event.screenX=screenX,this._event.screenY=screenY,this._event.x=x,this._event.y=y,this._event.keyCode=id,this._event.keyboard=!1,this.onUp.emit(this._event,Input.Event.UP),this.onClick.emit(this._event,Input.Event.CLICK),this._event.entity=null}},handleTouchMove:function(event){document.activeElement===document.body&&event.preventDefault();for(var touch,id,screenX,screenY,x,y,camera=meta.camera,numTouches=event.changedTouches.length,i=0;i<numTouches;i++)if(touch=event.changedTouches[i],-1!==(id=this._getTouchID(touch.identifier))){screenX=(touch.pageX-this.engine.offsetLeft)*this.engine.scaleX*this.engine.ratio,screenY=(touch.pageY-this.engine.offsetTop)*this.engine.scaleY*this.engine.ratio,x=screenX*camera.zoomRatio+camera.volume.x|0,y=screenY*camera.zoomRatio+camera.volume.y|0;var keyCode=id+Input.BUTTON_ENUM_OFFSET;this._event.event=event,0===id?(this.prevScreenX=this.screenX,this.prevScreenY=this.screenY,this.screenX=screenX,this.screenY=screenY,this.x=x,this.y=y,this._event.prevScreenX=this.prevScreenX,this._event.prevScreenY=this.prevScreenY):(this._event.prevScreenX=screenX,this._event.prevScreenY=screenY),this._event.screenX=0,this._event.screenY=0,this._event.x=x,this._event.y=y,this._event.keyCode=keyCode,this._event.keyboard=!1,this.onMove.emit(this._event,Input.Event.MOVE),this._event.entity=null}},resetInput:function(){var i;this._event.event=null,this._event.prevX=0,this._event.prevY=0,this._event.x=0,this._event.y=0,this._event.keyCode=0,this._event.keyboard=!1,this.metaPressed=!1;this.numKeys,this.numInputs;for(i=0;i<this.numTotalKeys;i++)this.keys[i]&&(this.keys[i]=0,this._event.keyCode=i,this.onKeyUp.emit(this._event,Input.Event.UP));if(this.pressed={},this.keybind={},this._numCmdKeys=0,this.numTouches){for(i=0;i<this.numTouches;i++)this._event.keyCode=i,this.onUp.emit(this._event,Input.Event.UP);this.touches.length=0,this.numTouches=0}},getEvent:function(){return this._event.event=null,this._event.prevScreenX=this.prevScreenX,this._event.prevScreenY=this.prevScreenY,this._event.screenX=this.screenX,this._event.screenY=this.screenY,this._event.x=this.inputX,this._event.y=this.inputY,this._event.keyCode=-1,this._event},_loadIgnoreKeys:function(){this._ignoreKeys=[],this._ignoreKeys[8]=1,this._ignoreKeys[9]=1,this._ignoreKeys[13]=1,this._ignoreKeys[17]=1,this._ignoreKeys[91]=1,this._ignoreKeys[38]=1,this._ignoreKeys[39]=1,this._ignoreKeys[40]=1,this._ignoreKeys[37]=1,this._ignoreKeys[124]=1,this._ignoreKeys[125]=1,this._ignoreKeys[126]=1,this._cmdKeys=[],this._cmdKeys[91]=1,this._cmdKeys[17]=1,this._iframeKeys=[],this._iframeKeys[37]=1,this._iframeKeys[38]=1,this._iframeKeys[39]=1,this._iframeKeys[40]=1},_ignoreFKeys:function(value){this._ignoreKeys[112]=value,this._ignoreKeys[113]=value,this._ignoreKeys[114]=value,this._ignoreKeys[115]=value,this._ignoreKeys[116]=value,this._ignoreKeys[117]=value,this._ignoreKeys[118]=value,this._ignoreKeys[119]=value,this._ignoreKeys[120]=value,this._ignoreKeys[121]=value,this._ignoreKeys[122]=value,this._ignoreKeys[123]=value},set ignoreFKeys(flag){flag?this._ignoreFKeys(1):this._ignoreFKeys(0)},get ignoreFKeys(){return!!this._ignoreKeys[112]},_getTouchID:function(eventTouchID){for(var i=0;i<this.numTouches;i++)if(this.touches[i]===eventTouchID)return i;return-1},addKeybind:function(keybind,keys){this._keybindMap||(this._keybindMap=new Array(this.numKeys+this.numInputs+1));for(var key,numKeys=keys.length,n=0;n<numKeys;n++)key=keys[n],this._keybindMap[key]?this._keybindMap[key].push(keybind):this._keybindMap[key]=[keybind]},isDown:function(key){return this.keys[key]},isUp:function(key){return!this.keys[key]},onDown:null,onUp:null,onMove:null,onClick:null,onDbClick:null,engine:meta.engine,keyID:null,keys:null,touches:null,pressed:null,keybind:null,_keybindMap:null,blockInput:!1,stickyKeys:!0,metaPressed:!1,keyRepeat:0,_inputTimer:null,_repeatKey:0,numKeys:256,numInputs:10,numTouches:0,x:0,y:0,screenX:0,screenY:0,prevScreenX:0,prevScreenY:0,_event:null,_ignoreKeys:null,_cmdKeys:null,_iframeKeys:null,_numCmdKeys:0}),window.Entity={},Entity.Event={INPUT_UP:"entityUp",INPUT_DOWN:"entityDown",CLICK:"entityClick",DBCLICK:"entityDbClick",DRAG:"drag",DRAG_START:"dragStart",DRAG_END:"dragEnd",HOVER:"hover",HOVER_ENTER:"hoverEnter",HOVER_EXIT:"hoverExit",STATE_CHANGE:"stateChange"},meta.class("Entity.Geometry",{init:function(arg){this.listeners=null,this.volume=new meta.math.AABBext,this.anim=new Component.Anim,this.anim.owner=this,this.initArg(arg),this.onCreate&&this.onCreate(arg)},initArg:function(arg){if("object"==typeof arg)if(arg instanceof Resource.Texture)this.texture=arg;else for(var key in arg)this[key]=arg[key];else"string"==typeof arg&&(this.texture=arg)},onCreate:null,set enabled(value){if(value){if(this.flags&this.Flag.ENABLED)return;this.flags|=this.Flag.ENABLED}else{if(0==(this.flags&this.Flag.ENABLED))return;this.flags&=~this.Flag.ENABLED}this._updateEnabled(!0)},get enabled(){return(this.flags&this.Flag.ENABLED)===this.Flag.ENABLED},_updateEnabled:function(parent){if(this.flags&this.Flag.INSTANCE_ENABLED){if(this.flags&this.Flag.ENABLED&&this.parent.flags&this.Flag.INSTANCE_ENABLED)return;this.flags&=~this.Flag.INSTANCE_ENABLED}else{if(!(this.flags&this.Flag.ENABLED&&this.parent.flags&this.Flag.INSTANCE_ENABLED))return;this.flags|=this.Flag.INSTANCE_ENABLED}if(this.children)for(var num=this.children.length,n=0;n<num;n++)this.children[n]._updateEnabled(!1);parent&&this._view&&this._view.updateEntity(this)},_activate:function(){if(this.flags|=this.Flag.ACTIVE,this.flags&this.Flag.UPDATING&&(this.updating=!0),0===this._anchorX&&0===this._anchorY||this._updateAnchor(),this.components!==this.parent.components){var component;for(var key in this.components)(component=this.components[key]).onActiveEnter&&component.onActiveEnter()}},_deactivate:function(){if(this.flags&=~(this.Flag.ACTIVE|this.Flag.RENDER),this.components!==this.parent.components){var component;for(var key in this.components)(component=this.components[key]).onActiveExit&&component.onActiveExit()}},remove:function(){this.flags&this.Flag.REMOVED||(this.flags|=this.Flag.REMOVED,this.flags&this.Flag.ACTIVE?this.renderer.removeEntity(this):this._remove())},_remove:function(){this._texture&&(this._texture.unsubscribe(this),this._texture=null),this.tween&&this.tween.clear(),this.view&&this.view.detach(this),this.onRemove&&this.onRemove()},onRemove:null,update:null,draw:null,updatePos:function(){if(this.volume.x=this._x+this.totalOffsetX,this.volume.y=this._y+this.totalOffsetY,this.volume.updatePos(),this.node&&this.renderer.culling.update(this),this.children)for(var child,numChildren=this.children.length,i=0;i<numChildren;i++)(child=this.children[i]).flags&this.Flag.IGNORE_PARENT_POS||(child._parentX=this.volume.x-this.volume.pivotPosX-this.offsetPosX,child._parentY=this.volume.y-this.volume.pivotPosY-this.offsetPosY,child.updateTotalOffset());this.renderer.needRender=!0},updateTotalOffset:function(){this.totalOffsetX=this.offsetPosX+this._parentX+this.anchorPosX,this.totalOffsetY=this.offsetPosY+this._parentY+this.anchorPosY,this._view&&(this.totalOffsetX+=this._view._x,this.totalOffsetY+=this._view._y),this.updatePos()},position:function(x,y){this._x===x&&this._y===y||(this._x=x,this._y=y,this.updatePos())},move:function(x,y){0===x&&0===y||(this._x+=x,this._y+=y,this.updatePos())},moveForward:function(delta){var newX=this._x+delta*Math.cos(this.volume.angle-1.57079),newY=this._y+delta*Math.sin(this.volume.angle-1.57079);this._x===newX&&this._y===newY||(this._x=newX,this._y=newY,this.updatePos())},moveDirected:function(delta,angleOffset){var newX=this._x+-delta*Math.cos(this.volume.angle-1.57079+angleOffset),newY=this._y+-delta*Math.sin(this.volume.angle-1.57079+angleOffset);this._x===newX&&this._y===newY||(this._x=newX,this._y=newY,this.updatePos())},strafe:function(delta){var newX=this._x+-delta*Math.cos(this._angleRad+Math.PI),newY=this._y+-delta*Math.sin(this._angleRad+Math.PI);this._x===newX&&this._y===newY||(this._x=newX,this._y=newY,this.updatePos())},set x(x){this._x=x,this.updatePos()},set y(y){this._y=y,this.updatePos()},get x(){return this._x},get y(){return this._y},get absX(){return this.volume.x},get absY(){return this.volume.y},set z(z){this._z!==z&&(this._z=z,this.updateZ())},get z(){return this._z},updateZ:function(){if(this.totalZ=this._z+this._parentZ,this._view&&(this.totalZ+=this._view._z),this.children)for(var child,numChildren=this.children.length,i=0;i<numChildren;i++)(child=this.children[i])._parentZ=this.totalZ+1e-5,child.updateZ();this.renderer.needSort=!0},offset:function(x,y){this._offsetX===x&&this._offsetY===y||(this._offsetX=x,this._offsetY=y,this._texture?(this.offsetPosX=Math.round(this._offsetX+this._texture.offsetX),this.offsetPosY=Math.round(this._offsetY+this._texture.offsetY)):(this.offsetPosX=Math.round(this._offsetX),this.offsetPosY=Math.round(this._offsetY)),this.updateTotalOffset())},set offsetX(x){this._offsetX!==x&&(this._offsetX=x,this._texture?this.offsetPosX=Math.round((this._offsetX+this._texture.offsetX)*this.volume.scaleX):this.offsetPosX=Math.round(this._offsetX*this.volume.scaleX),this.updateTotalOffset(),this.updatePos())},set offsetY(y){this._offsetY!==y&&(this._offsetY=y,this._texture?this.offsetPosY=Math.round((this._offsetY+this._texture.offsetY)*this.volume.scaleY):this.offsetPosY=Math.round(this._offsetY*this.volume.scaleX),this.updateTotalOffset(),this.updatePos())},get offsetX(){return this._offsetX},get offsetY(){return this._offsetY},pivot:function(x,y){this.volume.pivot(x,y),this.renderer.needRender=!0},set pivotX(x){this.volume.pivot(x,this.volume.pivotY),this.renderer.needRender=!0},set pivotY(y){this.volume.pivot(this.volume.pivotX,y),this.renderer.needRender=!0},get pivotX(){return this.volume.pivotX},get pivotY(){return this.volume.pivotY},anchor:function(x,y){void 0===y&&(y=x),this._anchorX=x,this._anchorY=y,this._updateAnchor()},_updateAnchor:function(){if(this._static){var engine=meta.engine;this.anchorPosX=this.parent.volume.width*engine.zoom*this._anchorX,this.anchorPosY=this.parent.volume.height*engine.zoom*this._anchorY}else this.anchorPosX=this.parent.volume.width*this._anchorX,this.anchorPosY=this.parent.volume.height*this._anchorY;this.updateTotalOffset()},set anchorX(x){this._anchorX=x,this._updateAnchor()},set anchorY(y){this._anchorY=y,this._updateAnchor()},get anchorX(){return this._anchorX},get anchroY(){return this._anchorY},set angle(value){value=value*Math.PI/180,this.volume.angle!==value&&(this._angle=value,this.updateAngle())},set angleRad(value){this._angle!==value&&(this._angle=value,this.updateAngle(value))},get angle(){return 180*this._angle/Math.PI},get angleRad(){return this._angle},updateAngle:function(){if(this.flags&this.Flag.IGNORE_PARENT_ANGLE?this.volume.rotate(this._angle):this.volume.rotate(this._angle+this.parent.volume.angle),this.node&&this.renderer.culling.update(this),this.children)for(var child,numChildren=this.children.length,i=0;i<numChildren;i++)(child=this.children[i]).flags&this.Flag.IGNORE_PARENT_ANGLE||child.updateAngle();this.renderer.needRender=!0},scale:function(x,y){void 0===y&&(y=x),this._scaleX=x,this._scaleY=y,this._updateScale()},_updateScale:function(){if(this.volume.scale(this._scaleX*this._parentScaleX,this._scaleY*this._parentScaleY),this._texture?(this.totalOffsetX=Math.round((this._offsetX+this._texture.offsetX)*this.volume.scaleX),this.totalOffsetY=Math.round((this._offsetY+this._texture.offsetY)*this.volume.scaleY)):(this.totalOffsetX=Math.round(this._offsetX*this.volume.scaleX),this.totalOffsetY=Math.round(this._offsetY*this.volume.scaleY)),this._updateAnchor(),this.children)for(var child,numChildren=this.children.length,i=0;i<numChildren;i++)(child=this.children[i]).flags&this.Flag.IGNORE_PARENT_SCALE||(child._parentScaleX=this.volume.scaleX,child._parentScaleY=this.volume.scaleY,child._updateScale(),child._updateAnchor());this.renderer.needRender=!0},fitIn:function(width,height){this.volume.width<1?this.volume.height<1?this.volume.resize(1,1):this.volume.resize(1,this.volume.initHeight):this.volume.height<1&&this.volume.resize(this.volume.initWidth,1),this.flags|=this.Flag.FIT_IN,this.scale(width/this.volume.initWidth,height/this.volume.initHeight)},resetFitIn:function(){this.flags&=~this.Flag.FIT_IN,this.scale(1,1),this.updateFromTexture()},set scaleX(x){this._scaleX!==x&&(this._scaleX=x,this._updateScale())},set scaleY(y){this._scaleY!==y&&(this._scaleY=y,this._updateScale())},get scaleX(){return this._scaleX},get scaleY(){return this._scaleY},flip:function(x,y){this.volume.flip(x,y),this.renderer.needRender=!0},set flipX(x){this.flip(x,this.volume.flipY)},set flipY(y){this.flip(this.volume.flipX,y)},get flipX(){return this.volume.flipX},get flipY(){return this.volume.flipY},set alpha(value){this._alpha!==value&&(this._alpha=value,this.updateAlpha())},get alpha(){return this._alpha},updateAlpha:function(){if(this.totalAlpha=this._alpha*this.parent.totalAlpha,this.totalAlpha<0?this.totalAlpha=0:this.totalAlpha>1&&(this.totalAlpha=1),this.children)for(var child,num=this.children.length,n=0;n<num;n++)(child=this.children[n]).flags&this.Flag.IGNORE_PARENT_ALPHA||child.updateAlpha();this.volume.__transformed=1,this.renderer.needRender=!0},resize:function(width,height){if(this.volume.width!==width||this.volume.height!==height){if(this.volume.resize(width,height),this.updatePos(),this._updateResize(),this.children)for(var numChildren=this.children.length,i=0;i<numChildren;i++)this.children[i]._updateResize();this.renderer.needRender=!0}},set width(width){this.texture&&(this.volume.width!==width?this.flags|=this.Flag.DYNAMIC_CLIP:this.flags&=~this.Flag.DYNAMIC_CLIP),this.resize(width,this.volume.height)},set height(height){this.texture&&(this.volume.height!==height?this.flags|=this.Flag.DYNAMIC_CLIP:this.flags&=~this.Flag.DYNAMIC_CLIP),this.resize(this.volume.width,height)},get width(){return this.volume.width},get height(){return this.volume.height},_updateResize:function(){this._updateAnchor(),this.onResize&&this.onResize()},onResize:null,clip:function(clip){clip instanceof Entity.Geometry?this.clipVolume=clip.volume:clip instanceof meta.math.AABB?this.clipVolume=clip:this.clipVolume=null,this.renderer.needRender=!0},clipBounds:function(width,height){this.clipVolume?this.clipVolume.set(0,0,width,height):this.clipVolume=new meta.math.AABB(0,0,width,height),this.flags|=this.Flag.CLIP_BOUNDS,this.renderer.needRender=!0},_onTextureEvent:function(data,event){var resEvent=Resource.Event;event===resEvent.LOADED?this.loaded=!0:event===resEvent.UNLOADED?this.loaded=!1:event===resEvent.REMOVED&&(this.texture=null),this.updateFromTexture()},_onLoadingEnd:function(data,event){var texture=meta.resources.textures[this._textureName];texture?this.texture=texture:console.warn("(Entity.Geometry) Unavailable texture - "+this._textureName),meta.resources.onLoadingEnd.remove(this)},updateFromTexture:function(){if(this._texture?(this.flags&this.Flag.FIT_IN&&this.scale(this.volume.width/this._texture.width,this.volume.height/this._texture.height),this.volume.resize(this._texture.width,this._texture.height),this.totalOffsetX=Math.round((this._offsetX+this._texture.offsetX)*this.volume.scaleX),this.totalOffsetY=Math.round((this._offsetY+this._texture.offsetY)*this.volume.scaleY)):(this.flags&this.Flag.FIT_IN?this.scale(this.volume.width,this.volume.height):this.volume.resize(1,1),this.totalOffsetX=Math.round(this._offsetX*this.volume.scaleX),this.totalOffsetY=Math.round(this._offsetY*this.volume.scaleY)),this._updateAnchor(),this.children)for(var numChildren=this.children.length,n=0;n<numChildren;n++)this.children[n]._updateAnchor()},onTextureChange:null,set texture(texture){if(this._texture!==texture){if(this._texture&&this._texture.unsubscribe(this),texture){if("string"==typeof texture){if(this._texture=meta.resources.textures[texture],!this._texture)return void(meta.resources.loading?(this._textureName=texture,meta.resources.onLoadingEnd.add(this._onLoadingEnd,this)):console.warn("(Entity.Geometry) Unavailable texture - "+texture))}else this._texture=texture;this._texture.subscribe(this._onTextureEvent,this),this._texture._loaded&&(this.updateFromTexture(),this.flags|=this.Flag.LOADED)}else this._texture=texture,this.flags&=~this.Flag.LOADED;this.anim.set(this._texture),this.onTextureChange&&this.onTextureChange()}},get texture(){return this._texture},set updating(value){if(value){if(-1!==this.__updateIndex)return;this.flags|=this.Flag.UPDATING,this.flags&this.Flag.ACTIVE&&(this.__updateIndex=this.renderer.entitiesUpdate.push(this)-1)}else{if(-1===this.__updateIndex)return;this.flags&=~this.Flag.UPDATING,this.flags&this.Flag.ACTIVE&&(this.renderer.entitiesUpdateRemove.push(this),this.__updateIndex=-1)}},get updating(){return(this.flags&this.Flag.UPDATING)===this.Flag.UPDATING},_setView:function(view,parent){if(this._view!==view){if(parent)if(view){if(view.flags&view.Flag.ACTIVE&&!(view.flags&view.Flag.INSTANCE_HIDDEN)){if(this._view=view,this.children)for(var num=this.children.length,n=0;n<num;n++)this.children[n]._setView(view,!1);return void this.renderer.addEntity(this)}this.renderer.removeEntity(this)}else this._view&&this.renderer.removeEntity(this);if(this._view=view,this.children)for(var num=this.children.length,n=0;n<num;n++)this.children[n]._setView(view,!1)}},attach:function(entity){entity?entity!==this?entity._view?console.warn("(Entity.Geometry.attach) Trying to attach entity that has already been attached to other entity"):(entity.parent=this,this.children?this.children.push(entity):(this.children=[entity],1===this.scaleX&&1===this.scaleY||this._updateScale()),0==(entity.flags&this.Flag.IGNORE_PARENT_POS)&&(entity._parentX=this.volume.x-this.volume.pivotPosX-this.offsetPosX,entity._parentY=this.volume.y-this.volume.pivotPosY-this.offsetPosY,entity.updateTotalOffset()),this.updateZ(),0!==this.volume.angle&&this.updateAngle(),1!==this.totalAlpha&&this.updateAlpha(),entity._updateHidden(),this._view&&entity._setView(this._view,!0)):console.warn("(Entity.Geometry.attach) Trying to attach themself"):console.warn("(Entity.Geometry.attach) Invalid entity passed")},_detach:function(entity){entity.parent=this.renderer.holder,entity.updatePos(),entity.updateZ(),entity._setView(null,!0),0!==this.volume.angle&&entity.updateAngle(),1!==this.totalAlpha&&entity.updateAlpha(),entity._updateHidden()},detach:function(entity){if(entity)if(entity.parent===this){var index=this.children.indexOf(entity);this.children[index]=this.children[this.children.length-1],this.children.pop(),this._detach(entity)}else console.warn("(Entity.Geometry.detach) Entity has different parent from this");else console.warn("(Entity.Geometry.detach) Invalid entity has been passed")},detachAll:function(){if(this.children){for(var num=this.children.length,n=0;n<num;n++)this._detach(this.children[n]);this.children.length=0}},get view(){return this._view},_updateHidden:function(){if(this.flags&this.Flag.INSTANCE_HIDDEN){if(this.flags&this.Flag.HIDDEN)return;if(this.parent.flags&this.Flag.INSTANCE_HIDDEN&&0==(this.flags&this.Flag.IGNORE_PARENT_HIDDEN))return;this.flags&=~this.Flag.INSTANCE_HIDDEN}else{if(!(this.flags&this.Flag.HIDDEN||this.parent.flags&this.Flag.INSTANCE_HIDDEN&&0==(this.flags&this.Flag.IGNORE_PARENT_HIDDEN)))return;this.flags|=this.Flag.INSTANCE_HIDDEN}if(this.children)for(var num=this.children.length,n=0;n<num;n++)this.children[n]._updateHidden()},set hidden(value){if(value){if(this.flags&this.Flag.HIDDEN)return;this.flags|=this.Flag.HIDDEN}else{if(0==(this.flags&this.Flag.HIDDEN))return;this.flags&=~this.Flag.HIDDEN}this._updateHidden()},get hidden(){return(this.flags&this.Flag.HIDDEN)===this.Flag.HIDDEN},set state(name){this._state!==name&&(this.onStateExit&&this.onStateExit(),this._state=name,this.onStateEnter&&this.onStateEnter())},get state(){return this._state},onStateChange:null,set picking(value){if(value){if(this.flags&this.Flag.PICKING)return;this.flags|=this.Flag.PICKING,this.flags&this.Flag.RENDER&&this.renderer.entitiesPicking.push(this)}else{if(0==(this.flags&this.Flag.PICKING))return;this.flags&=~this.Flag.PICKING,this.flags&this.Flag.RENDER&&this.renderer.entitiesPickingRemove.push(this)}},get picking(){return(this.flags&this.Flag.PICKING)===this.Flag.PICKING},isPointInside:function(x,y){if(1==this.volume.__transformed){var offsetX=x-this.volume.x,offsetY=y-this.volume.y;x=offsetX*this.volume.cos+offsetY*this.volume.sin+this.volume.x,y=offsetY*this.volume.cos-offsetX*this.volume.sin+this.volume.y}return this.volume.vsPoint(x,y)},isPointInsidePx:function(x,y){var volume=this.volume;if(1==volume.__transformed){var offsetX=x-volume.x,offsetY=y-volume.y;x=offsetX*volume.cos+offsetY*volume.sin+volume.x,y=offsetY*volume.cos-offsetX*volume.sin+volume.y}if(!this.volume.vsPoint(x,y))return!1;var offsetX=(x-volume.minX)/volume.scaleX|0,offsetY=(y-volume.minY)/volume.scaleY|0;return this._texture.getPixelAt(offsetX,offsetY)[3]>50},onDown:null,onUp:null,onClick:null,onDbClick:null,onDrag:null,onDragStart:null,onDragEnd:null,onHover:null,onHoverEnter:null,onHoverExit:null,dragStart:function(x,y){this._dragOffsetX=x-this.volume.x,this._dragOffsetY=y-this.volume.y},dragTo:function(x,y){x-=this.totalOffsetX+this._dragOffsetX,y-=this.totalOffsetY+this._dragOffsetY,this.volume.x===x&&this.volume.y===y||this.position(x,y)},addTimer:function(func,tDelta,numTimes){var timer=meta.addTimer(this,func,tDelta,numTimes);return this.timers?this.timers.push(timer):this.timers=[timer],timer},set tween(obj){if(obj){if(this._tweenCache?(this._tweenCache.stop(),this._tweenCache=new meta.Tween.Cache(this)):this._tweenCache=new meta.Tween.Cache(this),obj instanceof meta.Tween.Link)this._tweenCache.tween=obj.tween;else{if(!(obj instanceof meta.Tween))return void console.warn("(Entity.Geometry.set::tween) Ivalid object! Should be meta.Tween or meta.Tween.Link object");this._tweenCache.tween=obj}var tween=this._tweenCache.tween;tween.autoPlay&&(tween.cache=this._tweenCache,tween.play())}else this._tween=null},get tween(){return this._tweenCache||(this.tween=new meta.Tween),this._tweenCache.tween.cache=this._tweenCache,this._tweenCache.tween},addComponent:function(component,params){if("string"==typeof component&&(component=Component[component]),!component)return console.warn("(Entity.Geometry.addComponent) Adding an invalid component"),null;var name=component.prototype.__lastName__;if(this.components&&this.components[name])return console.warn("(Entity.Geometry.addComponent) Entity already has component: "+name),null;var comp=new component(this);if(comp.owner=this,params)for(var key in params)comp[key]=params[key];return this.parent.components===this.components&&(this.components={}),this.components[name]=comp,comp.onAdd&&comp.onAdd(),comp},removeComponent:function(name){var comp=this.components[name];if(comp&&"object"==typeof comp){for(var found=!1,numComponents=this.components.length,i=0;i<numComponents;i++)if(this.components[i]===comp){this.components[i]=this.components[numComponents-1],this.components.pop(),found=!0;break}found?(comp.unload&&comp.unload(),this[name]=null):console.warn("(Entity.Geometry.removeComponent) No such components added in: "+name)}else console.warn("(Entity.Geometry.removeComponent) No such component added: "+name)},removeAllComponents:function(){if(components)for(var numComponents=this.components.length,i=0;i<numComponents;i++)this.removeComponent(this.components[i])},lookAt:function(x,y){this.flags&this.Flag.IGNORE_PARENT_ANGLE?this.angleRad=-Math.atan2(x-this.volume.x,y-this.volume.y)+Math.PI:this.angleRad=-Math.atan2(x-this.volume.x,y-this.volume.y)+Math.PI-this.parent.volume.angle},on:function(event,func){if(!this.listeners){var listeners={};return listeners[event]=[func],void(this.listeners=listeners)}var buffer=this.listeners[event];buffer?buffer.push(event):this.listeners[event]=[func]},off:function(event,func){var buffer=this.listeners[event];if(buffer){var index=buffer.indexOf(func);-1!==index&&(buffer[index]=buffer[buffer.length-1],buffer.pop())}},emit:function(event,arg){var buffer=this.listeners[event];if(buffer)for(var n=0;n<buffer.length;n++)buffer[n](arg)},set loaded(value){if(value){if(this.flags&this.Flag.LOADED)return;this.flags|=this.Flag.LOADED}else{if(0==(this.flags&this.Flag.LOADED))return;this.flags&=~this.Flag.LOADED}},get loaded(){return(this.flags&this.Flag.LOADED)===this.Flag.LOADED},renderDebug:null,set debug(value){if(value){if(this.flags&this.Flag.DEBUG)return;this.flags|=this.Flag.DEBUG,this.renderer.numDebug++}else{if(0==(this.flags&this.Flag.DEBUG))return;this.flags&=~this.Flag.DEBUG,this.renderer.numDebug--}this.renderer.needRender=!0},get debug(){return(this.flags&this.Flag.DEBUG)===this.Flag.DEBUG},Flag:{ENABLED:1,INSTANCE_ENABLED:2,HIDDEN:4,INSTANCE_HIDDEN:8,ACTIVE:16,INSTANCE_ACTIVE:32,VISIBILE:64,ROOT_HOLDER:128,UPDATING:256,REMOVED:512,IGNORE_PARENT_POS:1024,IGNORE_PARENT_Z:2048,IGNORE_PARENT_ANGLE:4096,IGNORE_PARENT_ALPHA:8192,IGNORE_PARENT_SCALE:16384,IGNORE_PARENT_HIDDEN:32768,RENDER:65536,RENDER_REMOVE:1<<17,DEBUG:1<<18,DYNAMIC_CLIP:1<<19,FIT_IN:1<<20,CLIP_BOUNDS:1<<21,LOADED:1<<22,PICKING:1<<25,ROOT:1<<26},renderer:null,parent:null,_view:null,node:null,_texture:null,_x:0,_y:0,_parentX:0,_parentY:0,_z:0,totalZ:0,_parentZ:0,_angle:0,_alpha:1,totalAlpha:1,_scaleX:1,_scaleY:1,_parentScaleX:1,_parentScaleY:1,_offsetX:0,_offsetY:0,offsetPosX:0,offsetPosY:0,_anchorX:0,_anchorY:0,anchorPosX:0,anchorPosY:0,totalOffsetX:0,totalOffsetY:0,_dragOffsetX:0,_dragOffsetY:0,volume:null,clipVolume:null,children:null,anim:null,_state:"",timers:null,_tweenCache:null,components:{},hover:!1,pressed:!1,dragged:!1,__debug:!1,__updateIndex:-1,flags:0}),function(){function Text(arg){Entity.Geometry.call(this),this._bitmapFont=null,this._text="",this._lineBuffer=new Array,this._wordBuffer=new Array,this._limitWidth=0,this._maxWidth=0,this._font="Tahoma",this._fontSize=12,this._fontSizePx="12px",this._color="#fff",this._style="",this._outline=!1,this._outlineColor="#000",this._outlineWidth=1,this._shadow=!0,this._shadowColor="#000",this._shadowBlur=3,this._shadowOffsetX=0,this._shadowOffsetY=0,arg&&(this.text=arg)}Text.prototype={onCreate:function(params){this.texture=new Resource.Texture,this._texture.resize(this._fontSize,this._fontSize),this._lineBuffer=new Array(1),this.text=params},updateTxt:function(){var ctx=this._texture.ctx;this._bitmapFont?this.updateTxt_bitmapFont(ctx):this.updateTxt_canvasFont(ctx),this.renderer.needRender=!0},updateTxt_bitmapFont:function(ctx){if(this._bitmapFont.loaded){for(var numChars,tmpWidth,currText,i,canvas=this._bitmapFont.texture.canvas,chars=this._bitmapFont.chars,charRect=null,fontHeight=this._bitmapFont.height,numLines=this._lineBuffer.length,n=0;n<numLines;n++){for(numChars=(currText=this._lineBuffer[n]).length,tmpWidth=0,i=0;i<numChars;i++)(charRect=chars[currText.charCodeAt(i)])&&(tmpWidth+=charRect.kerning);tmpWidth>this._maxWidth&&(this._maxWidth=tmpWidth)}this._texture.clear(),this._texture.resize(this._maxWidth,fontHeight*numLines);var posX=0,posY=0;for(n=0;n<numLines;n++){for(numChars=(currText=this._lineBuffer[n]).length,i=0;i<numChars;i++)(charRect=chars[currText.charCodeAt(i)])&&(charRect.width<1||charRect.height<1||(ctx.drawImage(canvas,charRect.x,charRect.y,charRect.width,charRect.height,posX,posY+charRect.offsetY,charRect.width,charRect.height),posX+=charRect.kerning));posY+=fontHeight,posX=0}}},updateTxt_canvasFont:function(ctx){ctx.font=this._style+" "+this._fontSizePx+" "+this._font,this._maxWidth=0;var lineBuffer,numLines=this._lineBuffer.length;if(this._limitWidth>0)numLines=(lineBuffer=this.calcLineBuffer(ctx)).length;else{lineBuffer=this._lineBuffer;for(var metrics,n=0;n<numLines;n++)(metrics=ctx.measureText(lineBuffer[n])).width>this._maxWidth&&(this._maxWidth=metrics.width)}var posX=0,posY=0;this._shadow&&(this._maxWidth+=2*this._shadowBlur,posX+=this._shadowBlur);var fontHeight=1.3*this._fontSize;this._texture.resize(Math.ceil(this._maxWidth),Math.ceil(fontHeight*numLines)),ctx.clearRect(0,0,this.volume.initWidth,this.volume.initHeight),ctx.font=this._style+" "+this._fontSizePx+" "+this._font,ctx.fillStyle=this._color,ctx.textBaseline="top",this._shadow&&(ctx.shadowColor=this._shadowColor,ctx.shadowOffsetX=this._shadowOffsetX,ctx.shadowOffsetY=this._shadowOffsetY,ctx.shadowBlur=this._shadowBlur),this._outline&&(ctx.lineWidth=this._outlineWidth,ctx.strokeStyle=this._outlineColor);for(n=0;n<numLines;n++)ctx.fillText(lineBuffer[n],posX,posY),this._outline&&ctx.strokeText(lineBuffer[n],posY,posY),posY+=fontHeight},calcLineBuffer:function(ctx){for(var word,words,numWords,metrics,lineBuffer=[],text="",width=0,numLines=this._lineBuffer.length,n=0;n<numLines;n++)if(words=this._wordBuffer[n],1===(numWords=words.length))word=words[0],(metrics=ctx.measureText(word)).width>this._maxWidth&&(this._maxWidth=metrics.width),lineBuffer.push(word);else for(var i=0;i<numWords;i++)word=words[i],width+(metrics=text?ctx.measureText(" "+word):ctx.measureText(word)).width>this._limitWidth?(lineBuffer.push(text),this._maxWidth<width&&(this._maxWidth=width),i===numWords-1?(lineBuffer.push(word),this._maxWidth<metrics.width&&(this._maxWidth=metrics.width),width=0,text=null):(text=word,width=metrics.width)):(text?text+=" "+word:text=word,i===numWords-1?(lineBuffer.push(text),this._maxWidth<width+metrics.width&&(this._maxWidth=width+metrics.width),text=0,width=0):width+=metrics.width);return lineBuffer},set text(text){if(void 0!==text?"number"==typeof text?(this._text=text+"",this._lineBuffer[0]=this._text):(this._text=text,-1!==text.indexOf("\n")?this._lineBuffer=text.split("\n"):this._lineBuffer[0]=this._text):(this._text="",this._lineBuffer[0]=this._text),this._limitWidth>0){var numLines=this._lineBuffer.length;this._wordBuffer.length=numLines;for(var n=0;n<numLines;n++)this._wordBuffer[n]=this._lineBuffer[n].split(" ")}this.updateTxt()},get text(){return this._text},set font(font){var fontResource=meta.resources.fonts[font];if(fontResource){if(this._bitmapFont=fontResource,!fontResource._loaded)return this._texture.clear(),void fontResource.subscribe(this._onFontEvent,this)}else this._font=font,this._bitmapFont=null;this.updateTxt()},get font(){return this._font},set size(size){this._fontSize=size,this._fontSizePx=size+"px",this.updateTxt()},get size(){return this._fontSize},set color(color){this._color=color,this.updateTxt()},get color(){return this._color},set style(style){this._style!==style&&(this._style=style,this.updateTxt())},get style(){return this._style},set outlineColor(color){this._outlineColor!==color&&(this._outlineColor=color,this._outline=!0,this.updateTxt())},get outlineColor(){return this._outlineColor},set outlineWidth(width){this._outlineWidth!==width&&(this._outlineWidth=width,this._outline=!0,this.updateTxt())},get outlineWidth(){return this._outlineWidth},set outline(value){this._outline!==value&&(this._outline=value,this.updateTxt())},get outline(){return this._outline},set shadow(value){this._shadow!==value&&(this._shadow=value,this.updateTxt())},get shadow(){return this._shadow},set shadowColor(value){this._shadowColor!==value&&(this._shadowColor=value,this._shadow=!0,this.updateTxt())},get shadowColor(){return this._shadowColor},set shadowBlur(value){this._shadowBlur!==value&&(this._shadowBlur=value,this._shadow=!0,this.updateTxt())},get shadowBlur(){return this._shadowBlur},set shadowOffsetX(value){this._shadowOffsetX!==value&&(this._shadowOffsetX=value,this._shadow=!0,this.updateTxt())},set shadowOffsetY(value){this._shadowOffsetY!==value&&(this._shadowOffsetY=value,this._shadow=!0,this.updateTxt())},get shadowOffsetX(){return this._shadowOffsetY},get shadowOffsetY(){return this._shadowOffsetY},_onFontEvent:function(data,event){this.updateTxt()},set limitWidth(value){this._limitWidth!==value&&(this._limitWidth=value,this._wordBuffer||(this._wordBuffer=[]),this.text=this._text)},get limitWidth(){return this._limitWidth}},_inherits(Text,Entity.Geometry),Entity.Text=Text,modules[37]=Text}(),meta.class("Entity.Tiling","Entity.Geometry",{onCreate:function(texture){meta.camera.volume;var newTexture=new Resource.Texture;newTexture.ctx.globalCompositeOperator="copy",this.texture=newTexture,this.tile(texture)},draw:function(ctx){var x=0|this.volume.minX,y=0|this.volume.minY;ctx.transform(this.volume.m11,this.volume.m12,this.volume.m21,this.volume.m22,0|this.volume.x,0|this.volume.y),ctx.beginPath(),ctx.rect(-this.volume.initPivotPosX,-this.volume.initPivotPosY,this.volume.width,this.volume.height),ctx.clip();for(var image=this.tileTexture.canvas,width=this.tileTexture.fullWidth,height=this.tileTexture.fullHeight,posX=this._tileOffsetX,posY=this._tileOffsetY,y=0;y<this._drawTilesY;y++){for(x=0;x<this._drawTilesX;x++)ctx.drawImage(image,posX,posY),posX+=width;posX=this._tileOffsetX,posY+=height}},tile:function(texture){if(this.tileTexture&&!this.tileTexture._loaded&&this.tileTexture.unsubscribe(this),"string"==typeof texture){if(this.tileTexture=meta.resources.textures[texture],!this.tileTexture)return void console.warn("(Entity.Tiling.tile) Could not find texture with a name - "+texture)}else this.tileTexture=texture;this.tileTexture._loaded?this.updateTiling():this.tileTexture.subscribe(this.onTextureEvent,this)},options:function(opts){this.tileX=opts.tileX||0,this.tileY=opts.tileY||0,void 0!==opts.wrap&&(this.wrap=opts.wrap);var follow=opts.follow||!1;follow!==this.follow?meta.subscribe(meta.Event.CAMERA_MOVE,this.onResize,this):meta.unsubscribe(meta.Event.CAMERA_MOVE,this),this.follow=follow,this.updateSize()},resize:function(width,height){this._origWidth=width,this._origHeight=height,this._super(width,height),this.updateSize()},updateTiling:function(){if(this.tileTexture._loaded){var width=this.tileTexture.fullWidth,height=this.tileTexture.fullHeight,scrollX=this._scrollX,scrollY=this._scrollY;if(this.follow){var cameraVolume=meta.camera.volume;scrollX-=cameraVolume.minX,scrollY-=cameraVolume.minY}0===this.tileX?this._tileOffsetX=scrollX>0?scrollX%width-width:scrollX%width:this._tileOffsetX=scrollX,0===this.tileY?this._tileOffsetY=scrollY>0?scrollY%height-height:scrollY%height:this._tileOffsetY=scrollY,this._drawTilesX=Math.ceil((this._texture.fullWidth-this._tileOffsetX)/width),this._drawTilesY=Math.ceil((this._texture.fullHeight-this._tileOffsetY)/height),this._tileOffsetX-=this.volume.initPivotPosX,this._tileOffsetY-=this.volume.initPivotPosY,this.tileX>0&&this._drawTilesX>this.tileX&&(this._drawTilesX=this.tileX),this.tileY>0&&this._drawTilesY>this.tileY&&(this._drawTilesY=this.tileY),this.renderer.needRender=!0}},updateSize:function(){if(this.tileTexture&&this.tileTexture._loaded){var width=1,height=1;width=this._origWidth>0?this._origWidth:0===this.tileX?this.parent.width:this.tileTexture.fullWidth*this.tileX,height=this._origHeight>0?this._origHeight:0===this.tileY?this.parent.height:this.tileTexture.fullHeight*this.tileY,this._texture.resizeSilently(width,height),this.volume.resize(width,height),this.updateTiling()}},onTextureEvent:function(data,event){event===Resource.Event.LOADED&&(this.tileTexture.unsubscribe(this),this.updateSize())},onResize:function(data,event){this.updateSize()},scroll:function(x,y){this._scrollX=x,this._scrollY=y,this.updateTiling()},tileTexture:null,follow:!1,tileX:0,tileY:0,_scrollX:0,_scrollY:0,_tileScaleX:1,_tileScaleY:1,_drawTilesX:0,_drawTilesY:0,_tileOffsetX:0,_tileOffsetY:0,_origWidth:0,_origHeight:0}),meta.class("Entity.ParticleEmitter","Entity.Geometry",{onCreate:function(){this.particles=[],this.preset="meteor"},update:function(tDelta){if(this.elapsed+=tDelta,this.elapsed>this.duration)this.updating=!1;else{if(this.emissionRate>0){var rate=1/this.emissionRate;this.emissionCounter+=tDelta;var num=Math.floor(this.emissionCounter/rate);if(num>0){this.emissionCounter-=num*rate,num>this.particles.length-this.numActive&&(num=this.particles.length-this.numActive);for(var newNumActive=this.numActive+num,i=this.numActive;i<newNumActive;i++)this.initParticle(this.particles[i]);this.numActive=newNumActive}}for(var particle,n=0;n<this.numActive;n++)(particle=this.particles[n]).life-=tDelta,particle.life<=0?(this.numActive--,this.particles[n]=this.particles[this.numActive],this.particles[this.numActive]=particle):this.updateParticle(particle,tDelta);this.renderer.needRender=!0}},initParticle:function(particle){particle.x=meta.random.numberF(-1,1)*this.xVar,particle.y=meta.random.numberF(-1,1)*this.yVar,particle.life=this.life+meta.random.numberF(-1,1)*this.lifeVar;var speed=this.speed+meta.random.numberF(-1,1)*this.speedVar,angle=this.startAngle+meta.random.numberF(-1,1)*this.startAngleVar;particle.velX=Math.cos(Math.PI*angle/180)*speed,particle.vecY=-Math.sin(Math.PI*angle/180)*speed,particle.radialAccel=this.radialAccel+this.radialAccelVar*meta.random.numberF(-1,1),particle.tangentialAccel=this.tangentialAccel+this.tangentialAccelVar*meta.random.numberF(-1,1),this._textureTinting&&(particle.color[0]=this.startColor[0]+this.startColorVar[0]*meta.random.numberF(-1,1),particle.color[1]=this.startColor[1]+this.startColorVar[1]*meta.random.numberF(-1,1),particle.color[2]=this.startColor[2]+this.startColorVar[2]*meta.random.numberF(-1,1),particle.color[3]=this.startColor[3]+this.startColorVar[3]*meta.random.numberF(-1,1),this._endColor[0]=this.endColor[0]+this.endColorVar[0]*meta.random.numberF(-1,1),this._endColor[1]=this.endColor[1]+this.endColorVar[1]*meta.random.numberF(-1,1),this._endColor[2]=this.endColor[2]+this.endColorVar[2]*meta.random.numberF(-1,1),this._endColor[3]=this.endColor[3]+this.endColorVar[3]*meta.random.numberF(-1,1),particle.colorDelta[0]=(this._endColor[0]-this.startColor[0])/particle.life,particle.colorDelta[1]=(this._endColor[1]-this.startColor[1])/particle.life,particle.colorDelta[2]=(this._endColor[2]-this.startColor[2])/particle.life,particle.colorDelta[3]=(this._endColor[3]-this.startColor[3])/particle.life),particle.scale=this.startScale+this.startScaleVar*meta.random.numberF(-1,1);var endScale=this.endScale+this.endScaleVar*meta.random.numberF(-1,1);particle.scaleDelta=(endScale-particle.scale)/particle.life},updateParticle:function(particle,tDelta){particle.forcesX=this.gravityX*tDelta,particle.forcesY=this.gravityY*tDelta,particle.velX+=particle.forcesX,particle.vecY+=particle.forcesY,particle.x+=particle.velX*tDelta,particle.y+=particle.vecY*tDelta,particle.color&&(particle.color[0]+=particle.colorDelta[0]*tDelta,particle.color[1]+=particle.colorDelta[1]*tDelta,particle.color[2]+=particle.colorDelta[2]*tDelta,particle.color[3]+=particle.colorDelta[3]*tDelta),particle.scale+=this.scaleDelta},draw:function(ctx){if(this._texture.loaded){meta.time.deltaF;var img=this.texture.canvas,parentX=this.volume.minX-.5*img.width,parentY=this.volume.minY-.5*img.height;this._textureAdditive?ctx.globalCompositeOperation="lighter":ctx.globalCompositeOperation="source-over";for(var particle,color,n=0;n<this.numActive;n++)(color=(particle=this.particles[n]).color)[3]>1&&(color[3]=1),color[3]<0&&(color[3]=0),this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height),this._ctx.globalCompositeOperation="source-over",this._ctx.globalAlpha=color[3],this._ctx.drawImage(img,0,0),this._ctx.globalCompositeOperation="source-atop",this._ctx.fillStyle="rgba("+(0|color[0])+", "+(0|color[1])+", "+(0|color[2])+", 1.0)",this._ctx.fillRect(0,0,this._canvas.width,this._canvas.height),this._ctx.globalCompositeOperation="source-over",this._ctx.globalAlpha=color[3],ctx.drawImage(this.texture.canvas,parentX+particle.x,parentY+particle.y)}},play:function(){this.updating=!0},pause:function(){this.updating=!1},togglePlay:function(){this.updating?this.pause():this.play()},reset:function(){this.numActive=0,this.elapsed=0},set texture(value){value?this._texture=value:(this._svgTexture||(this._svgTexture=new Resource.SVG,this._svgTexture.fillStyle="white",this._svgTexture.circle(this._radius)),this._texture=this._svgTexture),this._texture.loaded?this.updateTintCanvas():this.texture.subscribe(this.onTextureEvent,this)},get texture(){return this._texture},updateTintCanvas:function(){this._canvas||(this._canvas=document.createElement("canvas"),this._ctx=this._canvas.getContext("2d")),this._canvas.width=this._texture.width,this._canvas.height=this._texture.height},onTextureEvent:function(data,event){this.updateTintCanvas(),this._texture.unsubscribe(this)},set totalParticles(value){var num=this.particles.length;this.particles.length=value;for(var n=num;n<value;n++)this.particles[n]=new this.Particle;this.numActive>value&&(this.numActive=value)},get totalParticles(){return this.particles.length},set textureAdditive(value){this._textureAdditive=value},get textureAdditive(){return this._textureAdditive},set textureTinting(value){this._textureTinting=value},get textureTinting(){return this._textureTinting},set radius(value){this._radius=value,this._texture===this._svgTexture&&(this._svgTexture.clear(),this._svgTexture.circle(this._radius),this.updateTintCanvas())},get radius(){return this._radius},set preset(name){var preset=this.presets[name];for(var key in preset)this[key]!==preset[key]&&(this[key]=preset[key]);this.textureAdditive=this._textureAdditive},Particle:function(){this.life=0,this.x=0,this.y=0,this.velX=0,this.velY=0,this.radialAccel=0,this.tangentialAccel=0,this.forcesX=0,this.forcesY=0,this.color=new Float32Array(4),this.colorDelta=new Float32Array(4),this.scale=1,this.scaleDelta=1},particles:null,numActive:0,emissionRate:0,emissionCounter:0,elapsed:0,duration:1/0,life:1,lifeVar:0,xVar:0,yVar:0,speed:0,speedVar:0,startAngle:0,startAngleVar:0,startScale:1,startScaleVar:0,endScale:1,endScaleVar:0,gravityX:0,gravityY:0,radialAccel:0,radialAccelVar:0,tangentialAccel:0,tangentialAccelVar:0,startColor:null,startColorVar:null,endColor:null,endColorVar:null,_endColor:new Float32Array(4),_canvas:null,_ctx:null,_svgTexture:null,_radius:10,_textureAdditive:!1,presets:{empty:{totalParticles:50,emissionRate:10,life:1,lifeVar:0},meteor:{totalParticles:45,emissionRate:40,life:1,lifeVar:.1,xVar:2,yVar:2,speed:15,speedVar:5,angle:90,angleVar:360,gravityX:-200,gravityY:-200,radialAccel:0,radialAccelVar:0,tangentialAccel:0,tangentialAccelVar:0,startColor:[255,42,0,1],startColorVar:[0,0,51,.1],endColor:[0,0,0,1],endColorVar:[0,0,0,0],scale:1,scaleVar:1,endScale:1,endScaleVar:1,textureAdditive:!0,radius:10}}}),meta.class("Component.Basic",{set updating(value){if(value){if(this._updating)return;if(this._updating=!0,this.owner.flags&this.owner.Flag.INSTANCE_ENABLED)if(this._updateIndex>-1){var compsUpdateRemove=meta.renderer.compsUpdateRemove;compsUpdateRemove[compsUpdateRemove.indexOf(this)]=null}else{var compsUpdate=meta.renderer.compsUpdate;compsUpdate.push(this),this._updateIndex=compsUpdate.length}}else{if(!this._updating)return;this._updating=!1,this._updateIndex>-1&&meta.renderer.compsUpdateRemove.push(this)}},get updating(){return this._updating},owner:null,_updating:!1,_updateIndex:-1}),meta.component("Component.Anim",{set:function(texture){if(!texture)return-1!==this.__index&&meta.renderer.removeAnim(this),void(this.texture=null);this.texture=texture,this._frame=0,texture.frames>1?(this.texture=texture,this.fps=texture.fps,this.__tAnim=0,this.reverse?this._frame=texture.frames-1:this._frame=0,this.autoPlay&&meta.renderer.addAnim(this)):-1!==this.__index&&meta.renderer.removeAnim(this)},play:function(loop,fps){this.texture?(this.loop=loop||!1,this.fps=fps||this.texture.fps,meta.renderer.addAnim(this)):console.warn("(Component.Anim.play) Invalid texture")},pause:function(){meta.renderer.removeAnim(this)},resume:function(){meta.renderer.addAnim(this)},stop:function(){this.reverse?this._frame=texture.frames-1:this._frame=0,meta.renderer.removeAnim(this)},reset:function(){this.reverse?this._frame=texture.frames-1:this._frame=0,meta.renderer.addAnim(this)},onEnd:null,onCancel:null,update:function(tDelta){if(this.__tAnim+=tDelta,!(this.__tAnim<this.__delay)){var frames=this.__tAnim/this.__delay|0;this.__tAnim-=frames*this.__delay,this.reverse?(this._frame-=frames,this._frame<0&&(this.pauseLastFrame?(meta.renderer.removeAnim(this),this._frame=0):this.loop?this._frame=(this.texture.frames+this._frame)%this.texture.frames:(meta.renderer.removeAnim(this),this._frame=this.texture.frames-1),this.onEnd&&this.onEnd.call(this.owner))):(this._frame+=frames,this._frame>=this.texture.frames&&(this.pauseLastFrame?(meta.renderer.removeAnim(this),this._frame=this.texture.frames-1):this.loop?this._frame=this._frame%this.texture.frames:(meta.renderer.removeAnim(this),this._frame=0),this.onEnd&&this.onEnd.call(this.owner))),this.owner.renderer.needRender=!0}},set frame(frame){this._frame=frame,this.owner.renderer.needRender=!0},get frame(){return this._frame},set fps(fps){this._fps=fps,this.__delay=1/(fps*this._speed)},get fps(){return this._fps},set speed(speed){this._speed=speed,this.__delay=1/(fps*this._speed)},get speed(){return this._speed},set paused(value){value?this.pause():this.resume()},get paused(){return!0},loop:!0,reverse:!1,autoPlay:!0,pauseLastFrame:!1,_fps:0,_speed:1,_frame:0,__index:-1,__delay:0,__tAnim:0}),meta.class("Entity.Tilemap","Entity.Geometry",{init:function(tilesX,tilesY,tileWidth,tileHeight){this._super(),tilesX&&("string"==typeof tilesX?this.load(tilesX):this.create(tilesX,tilesY,tileWidth,tileHeight))},initArg:function(arg){},load:function(path){if(path){var index=path.lastIndexOf(".")+1,pathIndex=path.lastIndexOf("/"),ext=path.substr(index);this.path=path,this.folderPath=path.substr(0,pathIndex+1),this.loaded=!1,this.tilesets=[];var self=this,parseFunc=this["_parse_"+ext];parseFunc?meta.resources.loadFile(path,function(data){parseFunc.call(self,data)}):console.warn("(Entity.Tilemap.load): Unsupported file format: "+ext)}else console.warn("(Entity.Tilemap.load): Invalid path specified")},create:function(tilesX,tilesY,tileWidth,tileHeight,type){this.properties={},this.tilesX=tilesX,this.tilesY=tilesY,this.tileWidth=tileWidth,this.tileHeight=tileHeight,this.type=type||"orthogonal",this.resize(tilesX*tileWidth,tilesY*tileHeight),this.tilesets=[],this.detachAll()},createTileset:function(gid,name,path,tileWidth,tileHeight,margin,spacing){if(!(gid<1)){var texture=null,spriteSheet=null;(spriteSheet=meta.resources.spriteSheets[name])||((spriteSheet=new Resource.SpriteSheet).name=name,spriteSheet.loadFromImg(path,tileWidth,tileHeight,margin||0,spacing||0),meta.resources.spriteSheets[name]=spriteSheet),texture=spriteSheet.texture;var tileset=new meta.Tileset(gid,texture,spriteSheet,tileWidth,tileHeight);return this.tilesets.push(tileset),spriteSheet.loaded||spriteSheet.subscribe(this.handleTilesetEvent,this)&&(this.loaded=!1,this.numToLoad++),0===this.numToLoad&&this.finishLoading(),tileset}console.warn("(Entity.Tilemap.createTileset) gid argument should be 1 or larger number")},createLayer:function(data,tilesX,tilesY,name){var layer;switch(this.type){case this.Type.ORTHOGONAL:layer=new Entity.TilemapOrthoLayer;break;case this.Type.ISOMETRIC:layer=new Entity.TilemapIsoLayer;break;case this.Type.HEXAGONAL:layer=new Entity.TilemapHexLayer;break;default:console.warn("(Entity.Tilemap.createLayer) Trying to create unsupported layer type")}return layer.tilesX=void 0===tilesX?this.tilesX:tilesX,layer.tilesY=void 0===tilesY?this.tilesY:tilesY,layer.tileWidth=this.tileWidth,layer.tileHeight=this.tileHeight,layer.tileHalfWidth=.5*this.tileWidth,layer.tileHalfHeight=.5*this.tileHeight,layer.properties={},this.attach(layer),layer.data=data,name&&(layer.name=name),layer},finishLoading:function(){for(var num=this.tilesets.length,n=0;n<num;n++)this.tilesets[n];if(this.children)for(num=this.children.length,n=0;n<num;n++){var child=this.children[n];child instanceof Entity.TilemapLayer&&(child.tileOffset(0,0),child.updateFromData())}this.loaded=!0},_parse_json:function(data){var json=JSON.parse(data);this.create(json.width,json.height,json.tilewidth,json.tileheight),this.properties=json.properties||{};for(var tilesetInfo,tilesets=json.tilesets,num=tilesets.length,n=0;n<num;n++)tilesetInfo=tilesets[n],this.createTileset(tilesetInfo.firstgid,tilesetInfo.name,this.folderPath+tilesetInfo.image,tilesetInfo.tilewidth,tilesetInfo.tileheight).properties=tilesetInfo.tileproperties||{};var layer,layerInfo,layers=json.layers;for(num=layers.length,n=0;n<num;n++)layerInfo=layers[n],layer=this.createLayer(layerInfo.data,layerInfo.width,layerInfo.height,layerInfo.name),layerInfo.properties&&(layer.properties=layerInfo.properties||{}),layerInfo.visible&&(layer.visible=layerInfo.visible);0===this.numToLoad&&(this.loaded=!0)},_parse_tmx:function(data){var node=(new DOMParser).parseFromString(data,"text/xml").documentElement;this.create(parseInt(node.getAttribute("width")),parseInt(node.getAttribute("height")),parseInt(node.getAttribute("tilewidth")),parseInt(node.getAttribute("tileheight")),node.getAttribute("orientation"));for(var childNodes=node.childNodes,numNodes=childNodes.length,i=0;i<numNodes;i++)if(1===(node=childNodes[i]).nodeType)switch(node.nodeName){case"tileset":this._parse_tmx_tileset(node);break;case"layer":this._parse_tmx_layer(node);break;case"properties":this.properties=this._parse_tmx_properties(node)}0===this.numToLoad&&(this.loaded=!0)},_parse_tmx_tileset:function(node){for(var tileProperties,childNode,imgPath="",properties={},childNodes=node.childNodes,numNodes=childNodes.length,n=0;n<numNodes;n++)if(1===(childNode=childNodes[n]).nodeType)switch(childNode.nodeName){case"image":imgPath=this.folderPath+childNode.getAttribute("source");break;case"tile":(tileProperties=this._parse_tmx_tile(childNode))&&(properties[childNode.getAttribute("id")]=tileProperties)}var spacingStr=node.getAttribute("spacing"),spacing=spacingStr?parseInt(spacingStr):0,marginStr=node.getAttribute("margin"),margin=marginStr?parseInt(marginStr):0;this.createTileset(parseInt(node.getAttribute("firstgid")),node.getAttribute("name"),imgPath,parseInt(node.getAttribute("tilewidth")),parseInt(node.getAttribute("tileheight")),margin,spacing).properties=properties},_parse_tmx_tile:function(node){for(var childNode,properties=null,childNodes=node.childNodes,numNodes=childNodes.length,n=0;n<numNodes;n++)if(1===(childNode=childNodes[n]).nodeType)switch(childNode.nodeName){case"properties":properties=this._parse_tmx_properties(childNode)}return properties},_parse_tmx_layer:function(node){var name=node.getAttribute("name"),tilesX=parseInt(node.getAttribute("width")),tilesY=parseInt(node.getAttribute("height")),visible=!0;node.getAttribute("visible")&&(visible=parseInt(visible));for(var data,properties=null,childNodes=node.childNodes,numNodes=childNodes.length,i=0;i<numNodes;i++)if(1===(node=childNodes[i]).nodeType)switch(node.nodeName){case"data":data=this._parse_tmx_data(node,tilesX,tilesY);break;case"properties":properties=this._parse_tmx_properties(node)}var layer=this.createLayer(data,tilesX,tilesY,name);properties&&(layer.properties=properties),layer.hidden=!visible},_parse_tmx_data:function(node,tilesX,tilesY){var data,num=tilesX*tilesY,encoding=node.getAttribute("encoding");if(encoding){var strData=null;if("csv"===encoding){if((strData=node.textContent.split(",")).length!==num)return void console.warn("(Entity.Tilemap._parse_tmx): Layer resolution does not match with data size");data=new Uint32Array(num);for(var n=0;n<num;n++)data[n]=parseInt(strData[n])}else{if("base64"!==encoding)return void console.warn("(Entity.Tilemap._parse_tmx): Unsupported layer encoding used: "+encoding);var compression=node.getAttribute("compression");if(compression)return void console.warn("(Entity.Tilemap._parse_tmx): Unsupported compression - "+compression);data=meta.decodeBinaryBase64(node.textContent)}}else{var id=0,dataNodes=node.childNodes;for(num=dataNodes.length,data=new Uint32Array(num),n=0;n<num;n++)1===(node=dataNodes[n]).nodeType&&(data[id++]=parseInt(node.getAttribute("gid")))}return data},_parse_tmx_properties:function(node){for(var childNode,properties={},childNodes=node.childNodes,num=childNodes.length,n=0;n<num;n++)1===(childNode=childNodes[n]).nodeType&&(properties[childNode.getAttribute("name")]=childNode.getAttribute("value"));return properties},getLayer:function(name){if(!name)return null;if(!this.children)return null;for(var num=this.children.length,n=0;n<num;n++)if(this.children[n].name===name)return this.children[n];return null},handleTilesetEvent:function(data,event){event===Resource.Event.LOADED&&0===--this.numToLoad&&this.finishLoading()},Type:{UNKNOWN:"",ORTHOGONAL:"orthogonal",ISOMETRIC:"isometric",HEXAGONAL:"hexagonal"},LayerInfoFlag:{FLIP_HORIZONTALLY:2147483648,FLIP_VERTICALLY:1073741824,FLIP_DIAGONALLY:536870912},tilesets:null,properties:null,path:"",folderPath:"",numToLoad:0,tilesX:0,tilesY:0,tileWidth:0,tileHeight:0,type:"orthogonal"}),meta.Tileset=function(gid,texture,spriteSheet,tileWidth,tileHeight){this.gid=gid,this.texture=texture,this.spriteSheet=spriteSheet,this.properties=null,this.tileWidth=tileWidth,this.tileHeight=tileHeight},meta.Tileset.prototype={getCell:function(gid){return this.spriteSheet?(gid-=this.gid,this.spriteSheet.frames[gid]):this.texture}},meta.class("Entity.TilemapLayer","Entity.Geometry",{renderDebug:function(){if(this._cells)for(var cell,renderer=meta.renderer,n=0;n<this.numTiles;n++)(cell=this._cells[n])&&renderer._renderVolumes(cell)},updateFromData:function(){if(this.resize(this.tilesX*this.tileWidth+this.tileOffsetX,this.tilesY*this.tileHeight+this.tileOffsetY),this._dataInfo?this._dataInfo.length!==this.numTiles&&(this._dataInfo.length=this.numTiles):this._dataInfo=new Array(this.numTiles),this._cells){Entity.TileGeometry;for(var num=this.children.length,n=0;n<num;n++)this.children[n]}this._tilesets=this.parent.tilesets,this._numTilesets=this._tilesets.length;for(n=0;n<this.numTiles;n++)this._updateDataInfoCell(n);this.renderer.needRender=!0},_updateDataInfoCell:function(id){if(this._data){var gid=this._data[id];if(gid){if(536870912&gid||1073741824&gid||2147483648&gid){this._dataFlags||(this._dataFlags=new Uint32Array(this._data.length));var flag=0;flag|=536870912&gid,flag|=1073741824&gid,flag|=2147483648&gid,this._dataFlags[id]=flag,gid&=536870911}for(var tileset=this._tilesets[0],i=1;i<this._numTilesets&&!(gid<this._tilesets[i].gid);i++)tileset=this._tilesets[i];this._dataInfo[id]=tileset.getCell(gid)}else this._dataInfo[id]=null}},_updateEntityCell:function(entity){if(this._cells){var cell,cellId;if(cellId=entity.cellX<0||entity.cellX>=this.tilesX?this.numTiles+1:entity.cellY<0||entity.cellY>=this.tilesY?this.numTiles+1:entity.cellX+entity.cellY*this.tilesX,entity._cellId!==cellId){if(-1!==entity._cellId)if((cell=this._cells[entity._cellId]).length>1){var tmpEntity=cell.pop();tmpEntity._cellIndex=entity._cellIndex,cell[entity._cellIndex]=tmpEntity}else cell.length=0;entity._cellId=cellId,(cell=this._cells[entity._cellId])?(entity._cellIndex=cell.length,cell.push(entity)):(cell=[entity],this._cells[entity._cellId]=cell,entity._cellIndex=0)}}},setGid:function(x,y,gid){var id=x+y*this.tilesX;this._data[id]=gid,this.parent.loaded&&(this._updateDataInfoCell(id),this.renderer.needRender=!0)},getGid:function(x,y){var id=x+y*this.tilesX;if(!(id<0||id>=this.numTiles))return this.data[id]},getInfo:function(x,y){var id=x+y*this.tilesX;return id<0?null:id>=this.numTiles?null:this._dataInfo[id]},getFlags:function(x,y){var id=x+y*this.tilesX;return id<0?null:id>=this.numTiles?null:this._dataFlags[id]},getPropertiesFromPos:function(x,y){return this.getProperties(this.getGid(x,y))},getProperties:function(gid){if(gid<=0)return null;for(var tileset=this._tilesets[0],i=1;i<this._numTilesets&&!(gid<this._tilesets[i].gid);i++)tileset=this._tilesets[i];var props=tileset.properties[gid-tileset.gid];return props||null},saveData:function(){if(this.data){this.savedData?this.savedData.length!==this.numTiles&&(this.savedData.length=this.numTiles):this.savedData=new Uint32Array(this.numTiles);for(var n=0;n<this.numTiles;n++)this.savedData[n]=this.data[n]}else console.warn("(Entity.Tilemap.saveData) No data available for saving")},restoreData:function(){if(this.savedData){if(this.savedData.length!==this.numTiles)return console.warn("(Entity.Tilemap.restoreData): Incompatible data saved"),void(this.savedData=null);for(var n=0;n<this.numTiles;n++)this.data[n]=this.savedData[n];this.updateFromData()}else console.warn("(Entity.Tilemap.restoreData) No saved data available")},convertToEntities:function(zOffsetY){this.layerFlags|=this.LayerFlag.CONVERTED_TO_ENTITIES,this.parent.flags&this.Flag.LOADED&&this._convertToEntities(zOffsetY),this.enabled=!1},_convertToEntities:function(zOffsetY){zOffsetY=zOffsetY||1;for(var texture,entity,id=0,y=0;y<this.tilesY;y++)for(var x=0;x<this.tilesX;x++)(texture=this._dataInfo[id++])&&((entity=new Entity.Geometry(texture)).position(this.getPosX(x,y),this.getPosY(x,y)),entity.pivot(0,1),entity.z=zOffsetY*y,meta.view.attach(entity))},attach:function(entity){entity instanceof Entity.TileGeometry&&(this._cells||(this._cells=new Array(this.numTiles)),entity.parent=this,0!==entity._x||0!==entity._y?this._calcEntityCell(entity):this._calcEntityPos(entity)),this._super(entity),entity._activate(),entity.flags&entity.Flag.PICKING&&this.renderer.entitiesPicking.push(entity)},_attachToCell:function(entity){entity.layerParent=this,entity.flags&entity.Flag.PICKING&&this.renderer.entitiesPicking.push(entity)},detach:function(entity){},tileOffset:function(x,y){this.tileOffsetX=x,this.tileOffsetY=y,this.offset(x,-y)},set data(data){this._data=data||null,this.numTiles=this.tilesX*this.tilesY,this.parent.flags&this.Flag.LOADED&&this.updateFromData()},get data(){return this._data},LayerFlag:{CONVERTED_TO_ENTITIES:2},name:"Undefined",tilesX:0,tilesY:0,numTiles:0,tileWidth:1,tileHeight:1,tileHalfWidth:0,tileHalfHeight:0,tileOffsetX:0,tileOffsetY:0,properties:null,cellPos:null,_data:null,_dataInfo:null,_dataFlags:null,_cells:null,_cellUnresolved:null,_tilesets:null,_numTilesets:0,layerFlags:0}),Entity.TilemapLayer.CellPos=function(cellX,cellY){this.cellX=cellX,this.cellY=cellY,this.x=0,this.y=0},Entity.TilemapLayer.prototype.cellPos=new Entity.TilemapLayer.CellPos(0,0),meta.class("Entity.TilemapOrthoLayer","Entity.TilemapLayer",{gridFromPos:function(worldX,worldY){return[Math.floor((worldX-this.volume.minX)/this.tileWidth),Math.floor((worldY-this.volume.minY)/this.tileHeight)]},draw:function(ctx){if(0!=(this.parent.flags&this.Flag.LOADED)){var cameraVolume=meta.camera.volume,startTileX=Math.floor((cameraVolume.minX-this.volume.minX)/this.tileWidth),startTileY=Math.floor((cameraVolume.minY-this.volume.minY)/this.tileHeight),endTileX=Math.ceil((cameraVolume.maxX-this.volume.minX)/this.tileWidth),endTileY=Math.ceil((cameraVolume.maxY-this.volume.minY)/this.tileHeight);startTileX<0&&(startTileX=0),startTileY<0&&(startTileY=0),endTileX>this.tilesX&&(endTileX=this.tilesX),endTileY>this.tilesY&&(endTileY=this.tilesY);var texture,minX=Math.floor(startTileX*this.tileWidth),id=0,posX=0|minX,posY=0|Math.floor(startTileY*this.tileHeight);if(this._dataFlags)for(var flags=0,y=startTileY;y<endTileY;y++){id=startTileX+y*this.tilesX;for(x=startTileX;x<endTileX;x++){if(info=this._dataInfo[id],info)if(flags=this._dataFlags[id]){var flipX=1,flipY=1,offsetX=0,offsetY=0;ctx.save(),536870912&flags?(ctx.rotate(Math.PI/2),2147483648&flags&&1073741824&flags?(flipX=-1,offsetX=this.tileWidth,offsetY=this.tileHeight):2147483648&flags?offsetY=this.tileWidth:1073741824&flags?(flipX=-1,flipY=-1,offsetX=this.tileWidth):flipY=-1):(2147483648&flags&&(flipX=-1,offsetX=this.tileWidth),1073741824&flags&&(flipY=-1,offsetY=this.tileHeight)),ctx.scale(flipX,flipY),ctx.drawImage(info.canvas,info.posX,info.posY,this.tileWidth,this.tileHeight,posX*flipX-offsetX,posY*flipY-offsetY,this.tileWidth,this.tileHeight),ctx.restore()}else ctx.drawImage(info.canvas,info.posX,info.posY,info.width,info.height,posX,posY,info.width,info.height);id++,posX+=this.tileWidth}posX=0|minX,posY+=this.tileHeight}else for(y=startTileY;y<endTileY;y++){id=startTileX+y*this.tilesX;for(var x=startTileX;x<endTileX;x++){if((texture=this._dataInfo[id])&&ctx.drawImage(texture.canvas,texture.x,texture.y,texture.width,texture.height,posX,posY-texture.height+this.tileHeight,texture.width,texture.height),this._cells){var cell=this._cells[id];if(cell)for(var num=cell.length,n=0;n<num;n++){var entity=cell[n];entity.texture&&entity._texture.draw(ctx,entity.volume.x-entity.volume.pivotPosX,entity.volume.y-entity.volume.pivotPosY)}}id++,posX+=this.tileWidth}posX=minX,posY+=this.tileHeight}}},_calcEntityCell:function(entity){entity.cellX=Math.floor((entity.volume.x-entity.totalOffsetX)/this.tileWidth),entity.cellY=Math.floor((entity.volume.y-entity.totalOffsetY)/this.tileHeight),this._updateEntityCell(entity)},_calcEntityPos:function(entity){var x=entity.cellX*this.tileWidth+this.tileHalfWidth,y=entity.cellY*this.tileHeight+this.tileHalfHeight;entity._x=x,entity._y=y,entity.updatePos()},getPos:function(cellX,cellY){var x=this.tilesX*this.tileHalfWidth-cellY*this.tileHalfWidth-this.tileHalfWidth+cellX*this.tileHalfWidth,y=y=cellY*this.tileHalfHeight+this.tileOffsetY+cellX*this.tileHalfHeight;return[x,y]},getWorldPos:function(cellX,cellY){var x=this.tilesX*this.tileHalfWidth-cellY*this.tileHalfWidth-this.tileHalfWidth+cellX*this.tileHalfWidth+this.volume.minX,y=y=cellY*this.tileHalfHeight+this.tileOffsetY+cellX*this.tileHalfHeight+this.volume.minY;return[x,y]},getPosEx:function(cellPos){cellPos.x=this.tilesX*this.tileHalfWidth-cellPos.cellY*this.tileHalfWidth-this.tileHalfWidth+cellPos.cellX*this.tileHalfWidth,cellPos.y=cellPos.cellY*this.tileHalfHeight+this.tileOffsetY+cellPos.cellX*this.tileHalfHeight},getWorldPosEx:function(cellPos){cellPos.x=this.tilesX*this.tileHalfWidth-cellPos.cellY*this.tileHalfWidth-this.tileHalfWidth+cellPos.cellX*this.tileHalfWidth+this.volume.minX,cellPos.y=cellPos.cellY*this.tileHalfHeight+this.tileOffsetY+cellPos.cellX*this.tileHalfHeight+this.volume.minY},getPosX:function(cellX,cellY){return this.tilesX*this.tileHalfWidth-cellY*this.tileHalfWidth-this.tileHalfWidth+cellX*this.tileHalfWidth},getPosY:function(cellX,cellY){return cellY*this.tileHalfHeight+this.tileOffsetY+cellX*this.tileHalfHeight+20}}),meta.class("Entity.TilemapIsoLayer","Entity.TilemapLayer",{draw:function(ctx,minX,minY){if(0!=(this.parent.flags&this.Flag.LOADED)){meta.camera.volume;var texture,posX,posY,renderer=meta.renderer,endTileX=this.tilesX,id=(this.tilesY,0);if(this._dataFlags)for(y=0;y<this.tilesY;y++){posX=this.tilesX*this.tileHalfWidth-y*this.tileHalfWidth-this.tileHalfWidth+minX,posY=y*this.tileHalfHeight+this.tileOffsetY+minY;for(x=0;x<endTileX;x++)(texture=this._dataInfo[id])&&ctx.drawImage(texture.canvas,texture.x,texture.y,texture.width,texture.height,posX,posY+this.tileHeight-texture.height,texture.width,texture.height),id++,posX+=this.tileHalfWidth,posY+=this.tileHalfHeight}else for(var y=0;y<this.tilesY;y++){posX=this.tilesX*this.tileHalfWidth-y*this.tileHalfWidth-this.tileHalfWidth+minX,posY=y*this.tileHalfHeight+this.tileOffsetY+minY;for(var x=0;x<this.tilesX;x++){if((texture=this._dataInfo[id])&&ctx.drawImage(texture.canvas,texture.x,texture.y,texture.width,texture.height,posX,posY+this.tileHeight-texture.height,texture.width,texture.height),this._cells){var cell=this._cells[id];if(cell)for(var num=cell.length,n=0;n<num;n++){var entity=cell[n];entity.texture&&renderer.drawEntity(entity)}}id++,posX+=this.tileHalfWidth,posY+=this.tileHalfHeight}}}},_calcEntityCell:function(entity){var adjScreenX=entity.x-this.tilesX*this.tileHalfWidth,adjScreenY=entity.y;entity.cellX=Math.floor((adjScreenY/this.tileHalfHeight+adjScreenX/this.tileHalfWidth)/2),entity.cellY=Math.floor((adjScreenY/this.tileHalfHeight-adjScreenX/this.tileHalfWidth)/2),this._updateEntityCell(entity)},_calcEntityPos:function(entity){var x=this.tilesX*this.tileHalfWidth-entity.cellY*this.tileHalfWidth-this.tileHalfWidth+entity.cellX*this.tileHalfWidth,y=entity.cellY*this.tileHalfHeight+this.tileOffsetY+entity.cellX*this.tileHalfHeight;entity._x=x+this.tileHalfWidth,entity._y=y+this.tileHalfHeight,entity.updatePos()},getPos:function(cellX,cellY){return[this.tilesX*this.tileHalfWidth-cellY*this.tileHalfWidth+cellX*this.tileHalfWidth,cellY*this.tileHalfHeight+cellX*this.tileHalfHeight+this.tileHalfHeight+this.tileOffsetY]},getWorldPos:function(cellX,cellY){return[this.tilesX*this.tileHalfWidth-cellY*this.tileHalfWidth+cellX*this.tileHalfWidth+this.volume.minX,cellY*this.tileHalfHeight+cellX*this.tileHalfHeight+this.tileHalfHeight+this.tileOffsetY+this.volume.minY]},getPosEx:function(cellPos){cellPos.x=this.tilesX*this.tileHalfWidth-cellPos.cellY*this.tileHalfWidth+cellPos.cellX*this.tileHalfWidth,cellPos.y=cellPos.cellY*this.tileHalfHeight+cellPos.cellX*this.tileHalfHeight+this.tileHalfHeight+this.tileOffsetY},getWorldPosEx:function(cellPos){cellPos.x=this.tilesX*this.tileHalfWidth-cellPos.cellY*this.tileHalfWidth+cellPos.cellX*this.tileHalfWidth+this.volume.minX,cellPos.y=cellPos.cellY*this.tileHalfHeight+cellPos.cellX*this.tileHalfHeight+this.tileHalfHeight+this.tileOffsetY+this.volume.minY},getPosX:function(cellX,cellY){return this.tilesX*this.tileHalfWidth-cellY*this.tileHalfWidth+cellX*this.tileHalfWidth},getPosY:function(cellX,cellY){return cellY*this.tileHalfHeight+cellX*this.tileHalfHeight+this.tileOffsetY+this.tileOffsetY},getCellFromPos:function(posX,posY){var adjScreenX=posX-this.tilesX*this.tileHalfWidth-this.offsetX,adjScreenY=posY-this.offsetY;return[Math.floor((adjScreenY/this.tileHalfHeight+adjScreenX/this.tileHalfWidth)/2),Math.floor((adjScreenY/this.tileHalfHeight-adjScreenX/this.tileHalfWidth)/2)]},getCellFromWorldPos:function(worldX,worldY){var adjScreenX=worldX-this.tilesX*this.tileHalfWidth-(this.volume.x+this.offsetX),adjScreenY=worldY-(this.volume.y-this.offsetY);return[Math.floor((adjScreenY/this.tileHalfHeight+adjScreenX/this.tileHalfWidth)/2),Math.floor((adjScreenY/this.tileHalfHeight-adjScreenX/this.tileHalfWidth)/2)]},getCellFromPosEx:function(cellPos){var adjScreenX=cellPos.x-this.tilesX*this.tileHalfWidth-this.offsetX,adjScreenY=cellPos.y-this.offsetY;cellPos.cellX=Math.floor((adjScreenY/this.tileHalfHeight+adjScreenX/this.tileHalfWidth)/2),cellPos.cellY=Math.floor((adjScreenY/this.tileHalfHeight-adjScreenX/this.tileHalfWidth)/2)},getCellFromWorldPosEx:function(cellPos){var adjScreenX=cellPos.x-this.tilesX*this.tileHalfWidth-(this.volume.x+this.offsetX),adjScreenY=cellPos.y-(this.volume.y-this.offsetY);cellPos.cellX=Math.floor((adjScreenY/this.tileHalfHeight+adjScreenX/this.tileHalfWidth)/2),cellPos.cellY=Math.floor((adjScreenY/this.tileHalfHeight-adjScreenX/this.tileHalfWidth)/2)}}),meta.class("Entity.TilemapHexLayer","Entity.TilemapLayer",{draw:function(ctx){if(0!=(this.parent.flags&this.Flag.LOADED)&&!(this.layerFlags&this.LayerFlag.CONVERTED_TO_ENTITIES)){meta.camera.volume;var info,endTileX=this.tilesX,minY=(this.tilesY,this.offsetY),id=0,posX=0,posY=0;if(0,0,endTileX=this.tilesX,this.tilesY,this._dataFlags)for(y=0;y<this.tilesY;y++){posX=-y*halfWidth+(this.tilesX-1)*halfWidth+0,posY=y*halfHeight-halfHeight+minY;for(x=0;x<endTileX;x++)(info=this._dataInfo[id++])&&ctx.drawImage(info.canvas,info.posX,info.posY,info.width,info.height,posX,posY,info.width,info.height),posX+=halfWidth,posY+=halfHeight}else for(var texture,posX=0,posY=0,flipX=0,y=0;y<this.tilesY;y++){for(var x=0;x<this.tilesX;x++)(texture=this._dataInfo[id++])&&ctx.drawImage(texture.canvas,texture.x,texture.y,texture.width,texture.height,posX,posY,texture.width,texture.height),posX+=this.tileWidth;flipX^=1,posX=this.tileHalfWidth*flipX,posY+=3}}},calcEntityCell:function(entity){},getPos:function(cellX,cellY){var x=this.tilesX*this.tileHalfWidth-cellY*this.tileHalfWidth-this.tileHalfWidth+cellX*this.tileHalfWidth,y=y=cellY*this.tileHalfHeight+this.tileOffsetY+cellX*this.tileHalfHeight;return[x,y]},getWorldPos:function(cellX,cellY){var x=this.tilesX*this.tileHalfWidth-cellY*this.tileHalfWidth-this.tileHalfWidth+cellX*this.tileHalfWidth+this.volume.minX,y=y=cellY*this.tileHalfHeight+this.tileOffsetY+cellX*this.tileHalfHeight+this.volume.minY;return[x,y]},getPosEx:function(cellPos){cellPos.x=this.tilesX*this.tileHalfWidth-cellPos.cellY*this.tileHalfWidth-this.tileHalfWidth+cellPos.cellX*this.tileHalfWidth,cellPos.y=y=cellPos.cellY*this.tileHalfHeight+this.tileOffsetY+cellPos.cellX*this.tileHalfHeight},getWorldPosEx:function(cellPos){cellPos.x=this.tilesX*this.tileHalfWidth-cellPos.cellY*this.tileHalfWidth-this.tileHalfWidth+cellPos.cellX*this.tileHalfWidth+this.volume.minX,cellPos.y=y=cellPos.cellY*this.tileHalfHeight+this.tileOffsetY+cellPos.cellX*this.tileHalfHeight+this.volume.minY},getPosX:function(cellX,cellY){return this.tilesX*this.tileHalfWidth-cellY*this.tileHalfWidth-this.tileHalfWidth+cellX*this.tileHalfWidth},getPosY:function(cellX,cellY){return cellY*this.tileHalfHeight+this.tileOffsetY+cellX*this.tileHalfHeight},getGridFromWorldPos:function(worldX,worldY){var adjScreenX=worldX-this.tilesX*this.tileHalfWidth-(this.volume.x+this.offsetX),adjScreenY=worldY-(this.volume.y-this.offsetY);return[Math.floor((adjScreenY/this.tileHalfHeight+adjScreenX/this.tileHalfWidth)/2),Math.floor((adjScreenY/this.tileHalfHeight-adjScreenX/this.tileHalfWidth)/2)]}}),meta.class("Component.TileBody","Component.Basic",{update:function(tDelta){if(this.needMoving){var volume=this.owner.volume;if(meta.math.length(volume.x-this.owner.totalOffsetX,volume.y-this.owner.totalOffsetY,this.targetX,this.targetY)<=this.speed*tDelta)this.owner.position(this.targetX,this.targetY),this.targets&&this.targets.length>0?this.moveToCells(this.targets):this.needMoving=!1,this.onMoveDone&&this.onMoveDone.call(this);else{this._tmpVec.x=this.targetX-volume.x+this.owner.totalOffsetX,this._tmpVec.y=this.targetY-volume.y+this.owner.totalOffsetY,this._tmpVec.normalize();var speed=this.speed*tDelta;this.owner.move(this._tmpVec.x*speed,this._tmpVec.y*speed)}}},moveToCell:function(cellX,cellY){var cellPos=this.owner.parent.cellPos;cellPos.cellX=cellX,cellPos.cellY=cellY,this.owner.parent.getPosEx(cellPos),this.targetX=cellPos.x,this.targetY=cellPos.y,this.needMoving=!0,this.updating=!0},moveToCells:function(cells){if(0!==cells.length){this.targets=cells;var target=this.targets.pop();this.moveToCell(target.x,target.y)}},stopMoving:function(){this.needMoving=!1,this.updating=!1,this.target=null},onMoveDone:null,needMoving:!1,target:null,targets:null,targetCellX:0,targetY:0,speed:250,_tmpVec:new meta.math.Vector2(0,0)}),meta.class("Entity.TileGeometry","Entity.Geometry",{updatePos:function(){this._super(),this.parent._calcEntityCell(this)},setCell:function(cellX,cellY){this.cellX=cellX,this.cellY=cellY,this.parent._calcEntityPos(this)},_setView:function(view,parent){},cellX:0,cellY:0,_cellId:-1,_cellIndex:-1}),meta.class("meta.Renderer",{init:function(){var entityProto=Entity.Geometry.prototype,viewProto=meta.View.prototype;this.entityFlag=entityProto.Flag,this.viewFlag=viewProto.Flag;var view=meta.cache.view;this.holder=new Entity.Geometry,this.holder._view=view,this.staticHolder=new Entity.Geometry,this.staticHolder._view=view,this.layerHolder=new Entity.TilemapOrthoLayer,this._view=view;var flags=this.holder.Flag.ENABLED|this.holder.Flag.INSTANCE_ENABLED|this.holder.Flag.LOADED;entityProto.flags=flags,entityProto.renderer=this,entityProto.parent=this.holder,Entity.TileGeometry.prototype.parent=this.layerHolder,this.holder.flags=flags|this.holder.Flag.ROOT_HOLDER,this.staticHolder.flags=flags|this.holder.Flag.ROOT_HOLDER,this.entities=[],this.entitiesRemove=[],this.entitiesStatic=[],this.entitiesStaticRemove=[],this.entitiesDebug=[],this.entitiesDebugRemove=[],viewProto.entityParent=this.holder,viewProto.entityBuffer=this.entities,viewProto.entityBufferRemove=this.entitiesRemove,meta.flags.culling&&(this.culling=new meta.SparseGrid),this.onRenderDebug=meta.createChannel(meta.Event.RENDER_DEBUG)},load:function(){this.engine=meta.engine,this.camera=meta.camera,this.cameraVolume=this.camera.volume,this.chn={onDown:meta.createChannel(Entity.Event.INPUT_DOWN),onUp:meta.createChannel(Entity.Event.INPUT_UP),onClick:meta.createChannel(Entity.Event.CLICK),onDbClick:meta.createChannel(Entity.Event.DBCLICK),onDrag:meta.createChannel(Entity.Event.DRAG),onDragStart:meta.createChannel(Entity.Event.DRAG_START),onDragEnd:meta.createChannel(Entity.Event.DRAG_END),onHover:meta.createChannel(Entity.Event.HOVER),onHoverEnter:meta.createChannel(Entity.Event.HOVER_ENTER),onHoverExit:meta.createChannel(Entity.Event.HOVER_EXIT)},meta.input.onDown.add(this.onInputDown,this,meta.Priority.HIGH),meta.input.onUp.add(this.onInputUp,this,meta.Priority.HIGH),meta.input.onMove.add(this.onInputMove,this,meta.Priority.HIGH),meta.input.onDbClick.add(this.onInputDbClick,this,meta.Priority.HIGH),meta.engine.onAdapt.add(this.onAdapt,this),meta.camera.onResize.add(this.onCameraResize,this),meta.camera.onMove.add(this.onCameraMove,this),meta.engine.updateResolution()},update:function(tDelta){this.entitiesRemove.length>0&&this._removeEntities(this.entities,this.entitiesRemove),this.entitiesStaticRemove.length>0&&this._removeEntities(this.entitiesStatic,this.entitiesStaticRemove),this.entitiesDebugRemove.length>0&&this._removeEntities(this.entitiesDebug,this.entitiesDebugRemove),this._removeFromBuffer(this.entitiesUpdate,this.entitiesUpdateRemove),this._removeFromBuffer(this.entitiesUpdate,this.entitiesUpdateRemove),this._removeFromBuffer(this.entitiesAnim,this.entitiesAnimRemove),this._removeFromBuffer(this.entitiesPicking,this.entitiesPickingRemove),this._removeFromBuffer(this.tweens,this.tweensRemove),this._removeFromBufferEx(this.compsUpdate,this.compsUpdateRemove),this.__updating=!0;for(var num=this.entitiesUpdate.length,i=0;i<num;i++)this.entitiesUpdate[i].update(tDelta);for(num=this.compsUpdate.length,i=0;i<num;i++)this.compsUpdate[i].update(tDelta);for(num=this.tweens.length,i=0;i<num;i++)this.tweens[i].update(tDelta);this.__updating=!1,this.needSort&&(this.sort(this.entities),this.sort(this.entitiesStatic),this.sort(this.entitiesPicking),this.sort(this.entitiesDebug),this.needSort=!1,this.needRender=!0)},render:function(tDelta){for(var numEntities=this.entitiesAnim.length,n=0;n<numEntities;n++)this.entitiesAnim[n].update(tDelta);if(this.needRender){this.renderFrame();var numFuncs=this._renderFuncs.length;for(n=0;n<numFuncs;n++)this._renderFuncs[n].render(tDelta);this.needRender=!1,(this.meta.cache.debug||this.numDebug>0)&&(this.renderDebugVolumes(),this.onRenderDebug.emit(this),this.renderDebugDrame())}},_removeEntities:function(entities,entitiesRemove){var num=entities.length;this._numRemove=0,this._removeStartID=Number.MAX_SAFE_INTEGER,this._removeEntitiesGroup(entities,entitiesRemove,!1);for(var entity,n=this._removeStartID+1;n<num;n++)(entity=entities[n])&&(-1===this._removeStartID&&console.log("ERROR"),entities[this._removeStartID++]=entity);entities[-1]&&console.log("ERROR REMOVE"),entities.length-=this._numRemove,entitiesRemove.length=0,this.needRender=!0},_removeEntitiesGroup:function(entities,entitiesRemove,forceRemove){for(var entity,index,flagRenderRemove=Entity.Geometry.prototype.Flag.RENDER_REMOVE,numRemove=entitiesRemove.length,i=0;i<numRemove;i++)entity=entitiesRemove[i],(forceRemove||entity.flags&flagRenderRemove)&&(this._numRemove++,entities[index=entities.indexOf(entity)]=null,index<this._removeStartID&&(this._removeStartID=index),entity._deactivate(),-1!==entity.__updateIndex&&(this.entitiesUpdateRemove.push(entity),entity.__updateIndex=-1),entity.flags&entity.Flag.PICKING&&this.entitiesPickingRemove.push(entity),entity.flags&entity.Flag.REMOVED&&entity._remove(),entity.children&&this._removeEntitiesGroup(entities,entity.children,!0),entity.flags&=~entity.Flag.RENDER_REMOVE)},_removeFromBuffer:function(buffer,removeBuffer){var numRemove=removeBuffer.length;if(numRemove>0){if(buffer.length-numRemove>0)for(var index,n=0;n<numRemove;n++)index=buffer.indexOf(removeBuffer[n]),buffer.splice(index,1);else buffer.length=0;removeBuffer.length=0}},_removeFromBufferEx:function(buffer,removeBuffer){var num=removeBuffer.length;if(num>0){var n,numItems=buffer.length;if(num===numItems){for(n=0;n<num;n++)buffer[n]._updateIndex=-1;buffer.length=0}else{var item,lastItem;for(n=0;n<num;n++)(item=removeBuffer[n])&&((lastItem=buffer[--numItems])._updateIndex=item._updateIndex,item._updateIndex=-1,buffer[item._updateIndex]=lastItem);buffer.length=numItems}removeBuffer.length=0}},sort:function(buffer){buffer.sort(this.sortFunc)},sortFunc:function(a,b){return a.totalZ-b.totalZ},makeEntityVisible:function(entity){entity.flags&entity.Flag.RENDER||(entity.flags|=entity.Flag.RENDER,entity.flags&entity.Flag.RENDER_REMOVE?entity.flags&=~entity.Flag.RENDER_REMOVE:(entity.flags&entity.Flag.PICKING&&this.entitiesPicking.push(entity),entity._view.entityBuffer.push(entity)),this.needSort=!0,this.needRender=!0)},makeEntityInvisible:function(entity){0!=(entity.flags&entity.Flag.RENDER)&&(entity.flags&=~entity.Flag.RENDER,entity.flags|=entity.Flag.RENDER_REMOVE,entity._view.entityBufferRemove.push(entity))},addEntity:function(entity,reuse){0!=(entity.flags&entity.Flag.INSTANCE_ENABLED)&&(entity._view.entityBuffer!==this.entities?this.makeEntityVisible(entity):this.culling?(entity._view.entityBuffer===this.entities&&(entity.node=new meta.SparseNode(this)),this.culling.add(entity)):this.makeEntityVisible(entity),this._addEntity(entity,reuse))},_addEntity:function(entity,reuse){if(entity._activate(),entity.children)for(var children=entity.children,num=children.length,n=0;n<num;n++)this.addEntity(children[n],reuse)},addEntities:function(entities){for(var numEntities=entities.length,n=0;n<numEntities;n++)this.addEntity(entities[n],!1)},_removeEntity:function(entity){0!=(entity.flags&entity.Flag.ACTIVE)&&(entity.flags&entity.Flag.RENDER_REMOVE||(entity.flags|=entity.Flag.RENDER_REMOVE,entity.flags&=~entity.Flag.RENDER))},removeEntity:function(entity){0!=(entity.flags&entity.Flag.ACTIVE)&&(entity.flags&entity.Flag.RENDER_REMOVE||(entity.flags|=entity.Flag.RENDER_REMOVE,entity.flags&=~entity.Flag.RENDER,entity._view.entityBufferRemove.push(entity)))},removeEntities:function(entities){if(0!==entities.length){var removeBuffer=entities[0]._view.entityBufferRemove;removeBuffer.push.apply(removeBuffer,entities);for(var numRemove=entities.length,i=0;i<numRemove;i++)this._removeEntity(entities[i])}},addAnim:function(anim){-1===anim.__index&&(anim.__index=this.entitiesAnim.push(anim)-1)},removeAnim:function(anim){-1!==anim.__index&&(this.entitiesAnimRemove.push(anim),anim.__index=-1)},onInputDown:function(data,event){this.enablePicking&&(this._checkHover(data),this.hoverEntity&&(data.entity=this.hoverEntity,this.pressedEntity=this.hoverEntity,this.pressedEntity.pressed=!0,this.pressedEntity.onDown&&this.pressedEntity.onDown.call(this.pressedEntity,data),this.chn.onDown.emit(data,Entity.Event.INPUT_DOWN)))},onInputUp:function(data,event){this.enablePicking&&this.pressedEntity&&(this._checkHover(data),data.entity=this.hoverEntity,this.pressedEntity.pressed=!1,this.pressedEntity.onUp&&this.pressedEntity.onUp.call(this.pressedEntity,event),this.chn.onUp.emit(this.pressedEntity,Entity.Event.INPUT_UP),this.pressedEntity===this.hoverEntity&&(this.pressedEntity.onClick&&this.pressedEntity.onClick.call(this.pressedEntity,data),this.chn.onClick.emit(data,Entity.Event.CLICK)),this.pressedEntity.dragged&&(data.entity=this.pressedEntity,this.pressedEntity.dragged=!1,this.pressedEntity.onDragEnd&&this.pressedEntity.onDragEnd.call(this.pressedEntity,data),this.chn.onDragEnd.emit(data,Entity.Event.DRAG_END),data.entity=this.hoverEntity),this.pressedEntity=null)},onInputMove:function(data,event){this.enablePicking&&(this._checkHover(data),this._checkDrag(data),data.entity=this.hoverEntity)},onInputDbClick:function(data,event){this.enablePicking&&(this._checkHover(data),this.hoverEntity?(data.entity=this.hoverEntity,this.hoverEntity.onDbClick&&this.hoverEntity.onDbClick.call(this.hoverEntity,data),this.chn.onDbClick.emit(data,Entity.Event.DBCLICK)):data.entity=null)},_checkHover:function(data){for(var entity,i=this.entitiesPicking.length-1;i>=0;i--)if(!((entity=this.entitiesPicking[i]).flags&entity.Flag.INSTANCE_HIDDEN)){if(this.enablePixelPicking){if(entity._view&&entity._view.flags&entity._view.Flag.STATIC){if(!entity.isPointInsidePx(data.screenX,data.screenY))continue}else if(!entity.isPointInsidePx(data.x,data.y))continue}else if(entity._view&&entity._view.flags&entity._view.Flag.STATIC){if(!entity.isPointInside(data.screenX,data.screenY))continue}else if(!entity.isPointInside(data.x,data.y))continue;return this.hoverEntity!==entity?(this.hoverEntity&&(data.entity=this.hoverEntity,this.hoverEntity.hover=!1,this.hoverEntity.onHoverExit&&this.hoverEntity.onHoverExit.call(this.hoverEntity,data),this.chn.onHoverExit.emit(data,Entity.Event.HOVER_EXIT)),data.entity=entity,entity.hover=!0,entity.onHoverEnter&&entity.onHoverEnter.call(entity,data),this.chn.onHoverEnter.emit(data,Entity.Event.HOVER_ENTER),this.hoverEntity=entity):(data.entity=entity,entity.onHover&&entity.onHover.call(entity,data),this.chn.onHover.emit(data,Entity.Event.HOVER)),void(data.entity=null)}this.hoverEntity&&(data.entity=this.hoverEntity,this.hoverEntity.hover=!1,this.hoverEntity.onHoverExit&&this.hoverEntity.onHoverExit.call(this.hoverEntity,data),this.chn.onHoverExit.emit(data,Entity.Event.HOVER_EXIT)),this.hoverEntity=null},_checkDrag:function(data){return!this.pressedEntity||(data.entity=this.pressedEntity,this.pressedEntity.dragged?(this.pressedEntity.onDrag&&this.pressedEntity.onDrag.call(this.pressedEntity,data),this.chn.onDrag.emit(data,Entity.Event.DRAG)):(this.pressedEntity.dragged=!0,this.pressedEntity.onDragStart&&this.pressedEntity.onDragStart.call(this.pressedEntity,data),this.chn.onDragStart.emit(data,Entity.Event.DRAG_START)),!1)},_updateResize:function(entities){for(var entity,num=entities.length,n=0;n<num;n++)(entity=entities[n]).parent.flags&entity.Flag.ROOT_HOLDER&&entity._updateResize()},onCameraResize:function(data,event){this.holder.resize(data.width,data.height),this.staticHolder.resize(meta.engine.width,meta.engine.height),this._updateResize(this.entities),this._updateResize(this.entitiesStatic),this._updateResize(this.entitiesDebug),this.culling&&this.culling.calc()},onCameraMove:function(data,event){this.culling&&this.culling.calc(),this.needRender=!0},onAdapt:function(data,event){},getUniqueID:function(){return this.__uniqueID++},set bgColor(hex){this._bgColor=hex,this.updateBgColor(),this.needRender=!0},get bgColor(){return this._bgColor},set transparent(value){this._transparent=value,this.updateBgColor(),this.needRender=!0},get transparent(){return this._transparent},addRender:function(owner){this._renderFuncs.push(owner)},removeRender:function(owner){for(var length=this._renderFuncs.length,i=0;i<length;i++)if(this._renderFuncs[i]===owner){this._renderFuncs[i]=this._renderFuncs[length-1],this._renderFuncs.pop();break}},onRenderDebug:null,meta:meta,engine:null,chn:null,culling:null,holder:null,staticHolder:null,layerHolder:null,camera:null,cameraVolume:null,cameraDefault:null,cameraUI:null,_removeStartID:0,_numRemove:0,entities:null,entitiesRemove:null,numEntities:0,entitiesUpdate:[],entitiesUpdateRemove:[],entitiesAnim:[],entitiesAnimRemove:[],entitiesPicking:[],entitiesPickingRemove:[],hoverEntity:null,pressedEntity:null,enablePicking:!0,enablePixelPicking:!1,entitiesStatic:null,entitiesStaticRemove:null,entitiesDebug:null,entitiesDebugRemove:null,compsUpdate:[],compsUpdateRemove:[],tweens:[],tweensRemove:[],needRender:!0,needSort:!1,needSortDebg:!1,useSparseGrid:!1,_renderFuncs:[],currZ:0,numDebug:0,_bgColor:"#ddd",_transparent:!1,__uniqueID:0,__updating:!1}),meta.class("meta.CanvasRenderer","meta.Renderer",{init:function(){this._super(),this.ctx=meta.engine.canvas.getContext("2d"),meta.engine.ctx=this.ctx},clear:function(){this._transparent?this.ctx.clearRect(0,0,this.engine.width,this.engine.height):(this.ctx.fillStyle=this._bgColor,this.ctx.fillRect(0,0,this.engine.width,this.engine.height))},renderFrame:function(){this.clear(),this.ctx.save();this.camera._zoom;this.setProjection(this.perspectiveProjection),this.renderEntities(this.entities),this.entitiesStatic.length>0&&(this.setProjection(this.orthoProjection),this.renderEntities(this.entitiesStatic)),this.ctx.restore()},renderDebugDrame:function(){this.ctx.save(),this.setProjection(this.orthoProjection),this.renderEntities(this.entitiesDebug),this.ctx.restore()},renderEntities:function(entities){for(var entity,num=entities.length,n=0;n<num;n++)(entity=entities[n]).flags&this.entityFlag.INSTANCE_HIDDEN||(entity.draw?this.drawEntityCustom(entity):this.drawEntity(entity))},renderDebugVolumes:function(){meta.engine.flags&meta.engine.Flag.LOADING||(this.ctx.save(),this.setProjection(this.perspectiveProjection),this.culling&&meta.debug&&this.culling.drawDebug(this.ctx),this.ctx.lineWidth=2,this._renderVolumes(this.entities),this.entitiesStatic.length>0&&(this.setProjection(this.orthoProjection),this._renderVolumes(this.entitiesStatic)),this.ctx.restore())},_renderVolumes:function(entities){for(var entity,num=entities.length,n=0;n<num;n++)(entity=entities[n]).flags&this.entityFlag.INSTANCE_HIDDEN||(entity.flags&this.entityFlag.DEBUG||this.meta.cache.debug)&&(entity.flags&this.entityFlag.PICKING?(this.ctx.strokeStyle="green",this.ctx.fillStyle="green"):(this.ctx.strokeStyle="red",this.ctx.fillStyle="red"),this.drawVolume(entity),entity.renderDebug&&entity.renderDebug())},drawEntity:function(entity){var texture=entity._texture;if(texture&&entity._texture._loaded){var volume=entity.volume;0!==volume.width&&0!==volume.height&&(entity.clipVolume&&(this.ctx.save(),this.ctx.beginPath(),entity.flags&entity.Flag.CLIP_BOUNDS?this.ctx.rect(Math.floor(entity.volume.minX),Math.floor(entity.volume.minY),entity.clipVolume.width,entity.clipVolume.height):this.ctx.rect(Math.floor(entity.clipVolume.minX),Math.floor(entity.clipVolume.minY),entity.clipVolume.width,entity.clipVolume.height),this.ctx.closePath(),this.ctx.clip()),entity.flags&entity.Flag.DYNAMIC_CLIP?volume.width>0&&volume.height>0&&this.ctx.drawImage(texture.canvas,0,0,volume.width,volume.height,Math.floor(volume.minX),Math.floor(volume.minY),volume.width,volume.height):(volume.__transformed?(this.ctx.globalAlpha=entity.totalAlpha,this.ctx.transform(volume.m11,volume.m12,volume.m21,volume.m22,Math.floor(volume.x),Math.floor(volume.y)),texture.frames>1?texture.drawFrame(this.ctx,-volume.initPivotPosX,-volume.initPivotPosY,entity.anim._frame):texture.draw(this.ctx,-volume.initPivotPosX,-volume.initPivotPosY),this.ctx.globalAlpha=1,this.resetProjection()):texture.frames>1?texture.drawFrame(this.ctx,Math.floor(volume.minX),Math.floor(volume.minY),entity.anim._frame):texture.draw(this.ctx,Math.floor(volume.minX),Math.floor(volume.minY)),entity.clipVolume&&this.ctx.restore()))}},drawEntityCustom:function(entity){var volume=entity.volume;entity.clipVolume&&(this.ctx.save(),this.ctx.beginPath(),entity.flags&entity.Flag.CLIP_BOUNDS?this.ctx.rect(Math.floor(entity.volume.minX),Math.floor(entity.volume.minY),entity.clipVolume.width,entity.clipVolume.height):this.ctx.rect(Math.floor(entity.clipVolume.minX),Math.floor(entity.clipVolume.minY),entity.clipVolume.width,entity.clipVolume.height),this.ctx.closePath(),this.ctx.clip()),volume.__transformed?(this.ctx.globalAlpha=entity.totalAlpha,this.ctx.transform(volume.m11,volume.m12,volume.m21,volume.m22,Math.floor(volume.x),Math.floor(volume.y)),entity.draw(this.ctx,-volume.initPivotPosX,-volume.initPivotPosY),this.ctx.globalAlpha=1,this.resetProjection()):entity.draw(this.ctx,Math.floor(volume.minX),Math.floor(volume.minY)),entity.clipVolume&&this.ctx.restore()},drawVolume:function(entity){var volume=entity.volume;if(0===volume.__transformed){var minX=Math.floor(volume.minX),minY=Math.floor(volume.minY),maxX=Math.ceil(volume.maxX),maxY=Math.ceil(volume.maxY);this.ctx.beginPath(),this.ctx.moveTo(minX,minY),this.ctx.lineTo(maxX,minY),this.ctx.lineTo(maxX,maxY),this.ctx.lineTo(minX,maxY),this.ctx.lineTo(minX,minY-1),this.ctx.stroke(),this.ctx.fillRect(Math.floor(volume.x)-3,Math.floor(volume.y)-3,6,6)}else{this.ctx.save(),this.ctx.translate(Math.floor(volume.x),Math.floor(volume.y)),this.ctx.rotate(entity.volume.angle),this.ctx.translate(-Math.floor(volume.x),-Math.floor(volume.y));var minX=Math.floor(volume.minX),minY=Math.floor(volume.minY),maxX=Math.ceil(volume.maxX),maxY=Math.ceil(volume.maxY);this.ctx.beginPath(),this.ctx.moveTo(minX,minY),this.ctx.lineTo(maxX,minY),this.ctx.lineTo(maxX,maxY),this.ctx.lineTo(minX,maxY),this.ctx.lineTo(minX,minY-1),this.ctx.stroke(),this.ctx.fillRect(Math.floor(volume.x)-3,Math.floor(volume.y)-3,6,6),this.ctx.restore()}},updateBgColor:function(){},perspectiveProjection:function(){var zoom=this.camera._zoom;this.ctx.setTransform(zoom,0,0,zoom,-Math.floor(this.cameraVolume.x*zoom),-Math.floor(this.cameraVolume.y*zoom))},orthoProjection:function(){this.ctx.setTransform(1,0,0,1,0,0)},resetProjection:null,setProjection:function(projFunc){this.resetProjection=projFunc,projFunc.call(this)},entityFlag:null,viewFlag:null}),meta.SparseGrid=function(){this.cells=[],this.cellWidth=meta.flags.cullingWidth||256,this.cellHeight=meta.flags.cullingHeight||256,this.startX=0,this.startY=0,this.endX=0,this.endY=0,this.newMinX=0,this.newMinY=0,this.newMaxX=0,this.newMaxY=0},meta.SparseGrid.prototype={calc:function(){var cameraVolume=meta.camera.volume,startX=Math.floor(cameraVolume.minX/this.cellWidth),startY=Math.floor(cameraVolume.minY/this.cellHeight),endX=Math.floor(cameraVolume.maxX/this.cellWidth),endY=Math.floor(cameraVolume.maxY/this.cellHeight);if(startX!==this.startX||startY!==this.startY||endX!==this.endX||endY!==this.endY){var uid,cell;if(startX>this.endX||endX<this.startX||startY>this.endY||endY<this.startY){for(y=this.startY;y<=this.endY;y++)for(x=this.startX;x<=this.endX;x++)uid=x<<16|65535&y,(cell=this.cells[uid])&&(cell.visible=0,this.makeInvisible(cell.data));for(y=startY;y<=endY;y++)for(x=startX;x<=endX;x++)uid=x<<16|65535&y,(cell=this.cells[uid])&&(cell.visible=1,this.makeVisible(cell.data))}else for(var minX=startX<this.startX?startX:this.startX,minY=startY<this.startY?startY:this.startY,maxX=endX>this.endX?endX:this.endX,maxY=endY>this.endY?endY:this.endY,y=minY;y<=maxY;y++)for(var x=minX;x<=maxX;x++)if(x>=startX&&x<=endX&&y>=startY&&y<=endY){if(x<this.startX||x>this.endX||y<this.startY||y>this.endY){if(uid=x<<16|65535&y,!(cell=this.cells[uid]))continue;cell.visible=1,this.makeVisible(cell.data)}}else{if(uid=x<<16|65535&y,!(cell=this.cells[uid]))continue;cell.visible&&(cell.visible=0,this.makeInvisible(cell.data))}this.startX=startX,this.startY=startY,this.endX=endX,this.endY=endY}},makeVisible:function(entities){for(var entity,renderer=meta.renderer,num=entities.length,n=0;n<num;n++)0===(entity=entities[n]).node.numVisible&&renderer.makeEntityVisible(entity),entity.node.numVisible++},makeInvisible:function(entities){for(var entity,renderer=meta.renderer,num=entities.length,n=0;n<num;n++)(entity=entities[n]).node.numVisible--,0===entity.node.numVisible&&renderer.makeEntityInvisible(entity)},add:function(entity){var node=entity.node,volume=entity.volume;this.calcBounds(volume);for(var cell,uid,y=this.newMinY;y<=this.newMaxY;y++)for(var x=this.newMinX;x<=this.newMaxX;x++)uid=x<<16|65535&y,(cell=this.cells[uid])?(cell.data.push(entity),cell.visible&&node.numVisible++):((cell=new this.Cell).data.push(entity),this.cells[uid]=cell,x>=this.startX&&x<=this.endX&&y>=this.startY&&y<=this.endY&&(cell.visible=1,node.numVisible++));node.minX=this.newMinX,node.minY=this.newMinY,node.maxX=this.newMaxX,node.maxY=this.newMaxY,node.numVisible>0&&meta.renderer.makeEntityVisible(entity)},remove:function(entity){entity.volume;for(var data,uid,n,num,node=entity.node,y=node.minY;y<node.maxY;y++)for(var x=node.minX;x<node.maxX;x++)for(uid=x<<16|65535&y,num=(data=this.cells[uid].data).length,n=0;n<num;n++)if(data[n]===entity){data[n]=data[num-1],data.pop();break}node.minX=0,node.minY=0,node.maxX=0,node.maxY=0,entity.node.numVisible>0&&(entity.node.numVisible=0,meta.renderer.makeEntityInvisible(entity))},update:function(entity){if(0!=(entity.flags&entity.Flag.ACTIVE)){var node=entity.node,volume=entity.volume;if(this.calcBounds(volume),node.minX!==this.newMinX||node.minY!==this.newMinY||node.maxX!==this.newMaxX||node.maxY!==this.newMaxY){var cell,data,uid,y,x,prevNumVisible=node.numVisible;if(node.minX>this.newMaxX||node.maxX<this.newMinX||node.minY>this.newMaxY||node.maxY<this.newMinY){for(y=node.minY;y<=node.maxY;y++)for(x=node.minX;x<=node.maxX;x++)uid=x<<16|65535&y,(data=this.cells[uid].data)[data.indexOf(entity)]=data[data.length-1],data.pop();for(node.numVisible=0,y=this.newMinY;y<=this.newMaxY;y++)for(x=this.newMinX;x<=this.newMaxX;x++)uid=x<<16|65535&y,(cell=this.cells[uid])?(cell.data.push(entity),cell.visible&&node.numVisible++):((cell=new this.Cell).data.push(entity),this.cells[uid]=cell,x>=this.startX&&x<=this.endX&&y>=this.startY&&y<=this.endY&&(cell.visible=1,node.numVisible++))}else{var minX=this.newMinX<node.minX?this.newMinX:node.minX,minY=this.newMinY<node.minY?this.newMinY:node.minY,maxX=this.newMaxX>node.maxX?this.newMaxX:node.maxX,maxY=this.newMaxY>node.maxY?this.newMaxY:node.maxY;for(y=minY;y<=maxY;y++)for(x=minX;x<=maxX;x++)x>=node.minX&&x<=node.maxX&&y>=node.minY&&y<=node.maxY?(x>this.newMaxX||x<this.newMinX||y>this.newMaxY||y<this.newMinY)&&(uid=x<<16|65535&y,(data=(cell=this.cells[uid]).data)[data.indexOf(entity)]=data[data.length-1],data.pop(),x>=this.startX&&x<=this.endX&&y>=this.startY&&y<=this.endY&&(cell.visible=1,node.numVisible--)):(uid=x<<16|65535&y,(cell=this.cells[uid])?(cell.data.push(entity),cell.visible&&node.numVisible++):((cell=new this.Cell).data.push(entity),this.cells[uid]=cell,x>=this.startX&&x<=this.endX&&y>=this.startY&&y<=this.endY&&(cell.visible=1,node.numVisible++)))}0===node.numVisible?prevNumVisible>0&&meta.renderer.makeEntityInvisible(entity):0===prevNumVisible&&meta.renderer.makeEntityVisible(entity),node.minX=this.newMinX,node.minY=this.newMinY,node.maxX=this.newMaxX,node.maxY=this.newMaxY}}},calcBounds:function(volume){if(0!==volume.angle){var minX,minY,maxX,maxY,sin=volume.sin,cos=volume.cos,px=volume.x+-volume.pivotPosX*cos- -volume.pivotPosY*sin,py=volume.y+-volume.pivotPosX*sin+-volume.pivotPosY*cos,widthCos=volume.width*cos,heightCos=volume.height*cos,widthSin=volume.width*sin,heightSin=volume.height*sin;volume.angle<Math.PI?volume.angle<1.5707963267948966?(minX=px-heightSin,maxX=px+widthCos,minY=py,maxY=py+heightCos+widthSin):(minX=px-heightSin+widthCos,maxX=px,minY=py+heightCos,maxY=py+widthSin):volume.angle<4.71238898038469?(minX=px+widthCos,maxX=px-heightSin,minY=py+widthSin+heightCos,maxY=py):(minX=px,maxX=px+widthCos-heightSin,minY=py+widthSin,maxY=py+heightCos),this.newMinX=Math.floor(minX/this.cellWidth),this.newMinY=Math.floor(minY/this.cellHeight),this.newMaxX=Math.floor(maxX/this.cellWidth),this.newMaxY=Math.floor(maxY/this.cellHeight)}else this.newMinX=Math.floor(volume.minX/this.cellWidth),this.newMinY=Math.floor(volume.minY/this.cellHeight),this.newMaxX=Math.floor(volume.maxX/this.cellWidth),this.newMaxY=Math.floor(volume.maxY/this.cellHeight)},drawDebug:function(ctx){if(this.debug){ctx.save(),ctx.lineWidth=1,ctx.strokeStyle="#43a6e2",ctx.fillStyle="#c9e3f3";for(var posX,posY,y=this.startY;y<=this.endY;y++)for(var x=this.startX;x<=this.endX;x++)posX=x*this.cellWidth+.5,posY=y*this.cellHeight+.5,ctx.beginPath(),ctx.rect(posX,posY,this.cellWidth,this.cellHeight),ctx.stroke();ctx.restore()}},Cell:function(){this.data=[],this.visible=0},debug:!0},meta.SparseNode=function(owner){this.owner=owner,this.numVisible=0,this.minX=0,this.minY=0,this.maxX=0,this.maxY=0},meta.controller("meta.debugger",{onFirstLoad:function(){this.view.debugger=!0,this.view.z=1e6;var texture=new Resource.SVG;texture.fillRect(0,0,200,290),this.holder=new Entity.Geometry(texture),this.holder.anchor(0,1),this.holder.pivot(0,1),this.view.attach(this.holder);var fps=new Entity.Text;fps.position(10,10),fps.text="fps: 60",this.holder.attach(fps);var memory=new Entity.Text;memory.position(10,25),this.holder.attach(memory);var entities=new Entity.Text;entities.position(10,40),entities.text="entities: 0, static: 0",this.holder.attach(entities);var resolution=new Entity.Text;resolution.position(10,65),this.holder.attach(resolution);var worldInfo=new Entity.Text;worldInfo.text="world:",worldInfo.position(10,90),this.holder.attach(worldInfo);var worldBoundsMin=new Entity.Text;worldBoundsMin.position(20,105),this.holder.attach(worldBoundsMin);var worldBoundsMax=new Entity.Text;worldBoundsMax.position(20,120),this.holder.attach(worldBoundsMax);var worldResolution=new Entity.Text;worldResolution.position(20,135),this.holder.attach(worldResolution);var cameraInfo=new Entity.Text;cameraInfo.text="camera:",cameraInfo.position(10,155),this.holder.attach(cameraInfo);var cameraBoundsMin=new Entity.Text;cameraBoundsMin.position(20,170),this.holder.attach(cameraBoundsMin);var cameraBoundsMax=new Entity.Text;cameraBoundsMax.position(20,185),this.holder.attach(cameraBoundsMax);var cameraResolution=new Entity.Text;cameraResolution.position(20,200),this.holder.attach(cameraResolution);var cameraZoom=new Entity.Text;cameraZoom.position(20,215),this.holder.attach(cameraZoom);var cursorInfo=new Entity.Text;cursorInfo.text="cursor:",cursorInfo.position(10,235),this.holder.attach(cursorInfo);var world=new Entity.Text;world.position(20,250),this.holder.attach(world);var screen=new Entity.Text;screen.position(20,265),this.holder.attach(screen),this.txt={fps:fps,memory:memory,entities:entities,resolution:resolution,worldBoundsMin:worldBoundsMin,worldBoundsMax:worldBoundsMax,worldResolution:worldResolution,cameraBoundsMin:cameraBoundsMin,cameraBoundsMax:cameraBoundsMax,cameraResolution:cameraResolution,cameraZoom:cameraZoom,world:world,screen:screen}},onLoad:function(){this.timer=meta.addTimer(this,this.updateStats,1e3),meta.input.onMove.add(this.handleInputMove,this),meta.engine.onResize.add(this.handleResize,this),meta.world.onResize.add(this.handleWorldResize,this),meta.camera.onResize.add(this.handleCameraResize,this),meta.camera.onMove.add(this.handleCameraMove,this),this.handleInputMove(meta.input,0),this.handleResize(meta.engine),this.handleWorldResize(meta.world,0),this.handleCameraResize(meta.camera,0),this.handleCameraMove(meta.camera,0),this.updateStats()},onUnload:function(){meta.input.onMove.remove(this),meta.engine.onResize.remove(this),meta.world.onResize.remove(this),meta.camera.onResize.remove(this),meta.camera.onMove.remove(this),this.timer.stop()},updateStats:function(){var fps=meta.engine.fps;if(fps!==this.fps&&(this.txt.fps.text="fps: "+fps,this.fps=fps),window.performance.memory){var memory=(window.performance.memory.usedJSHeapSize/1048576).toFixed(2);memory!==this.memory&&(this.txt.memory.text="memory: "+memory+"mb",this.memory=memory)}var numEntities=meta.renderer.entities.length,numStaticEntities=meta.renderer.entitiesStatic.length,numTotalEntities=numEntities+numStaticEntities;numTotalEntities!==this.numEntities&&(this.txt.entities.text="entities: "+numEntities+", static: "+numStaticEntities,this.numEntities=numTotalEntities)},handleInputMove:function(data,event){this.txt.world.text="world: "+data.x+", "+data.y,this.txt.screen.text="screen: "+data.screenX+", "+data.screenY},handleCameraMove:function(data,event){var volume=data.volume;this.txt.cameraBoundsMin.text="boundsMin: "+Math.round(volume.minX)+", "+Math.round(volume.minY),this.txt.cameraBoundsMax.text="boundsMax: "+Math.round(volume.maxX)+", "+Math.round(volume.maxY),this.txt.cameraResolution.text="width: "+volume.width+", height: "+volume.height},handleCameraResize:function(data,event){this.txt.cameraZoom.text="zoom: "+data.zoom.toFixed(3)},handleResize:function(data,event){this.txt.resolution.text="width: "+data.width+", height: "+data.height},handleWorldResize:function(data,event){var volume=data.volume;this.txt.worldBoundsMin.text="boundsMin: "+Math.round(volume.minX)+", "+Math.round(volume.minY),this.txt.worldBoundsMax.text="boundsMax: "+Math.round(volume.maxX)+", "+Math.round(volume.maxY),this.txt.worldResolution.text="width: "+volume.width+", height: "+volume.height},txt:null}),meta.class("Entity.SVG","Entity.Geometry",{set lineWidth(hex){this._lineWidth=hex,this.renderer.needRender=!0},get lineWidth(){return this._lineWidth},set strokeStyle(hex){this._strokeStyle=hex,this.renderer.needRender=!0},get strokeStyle(){return this._strokeStyle},set fillStyle(hex){this._fillStyle=hex,this.renderer.needRender=!0},get fillStyle(){return this._fillStyle},_lineWidth:2,_strokeStyle:"",_fillStyle:""}),meta.class("Entity.Line","Entity.SVG",{draw:function(ctx){this.globalAlpha=this._alpha,ctx.lineWidth=this._lineWidth,ctx.strokeStyle=this._strokeStyle,ctx.beginPath(),ctx.moveTo(this.volume.x,this.volume.y),ctx.lineTo(this.toX,this.toY),ctx.stroke(),this.globalAlpha=1},to:function(x,y){this.toX===x&&this.toY===y||(this.toX=x,this.toY=y,this.renderer.needRender=!0)},toX:0,toY:0}),meta.class("Entity.Rect","Entity.SVG",{draw:function(ctx){ctx.beginPath(),ctx.rect(this.volume.minX,this.volume.minY,this.volume.width,this.volume.height),this._fillStyle&&(ctx.fillStyle=this._fillStyle,ctx.fill()),!this._strokeStyle&&this._fillStyle||(ctx.lineWidth=this._lineWidth,ctx.strokeStyle=this._strokeStyle,ctx.stroke())}}),meta.class("Entity.Circle","Entity.SVG",{init:function(){this.pivot(.5),this.volume.resize(2*this.radius,2*this._radius)},draw:function(ctx){ctx.globalAlpha=this._alpha,ctx.beginPath(),ctx.arc(this.volume.x,this.volume.y,this.radius,0,2*Math.PI,!1),this._fillStyle&&(ctx.fillStyle=this._fillStyle,ctx.fill()),!this._strokeStyle&&this._fillStyle||(ctx.lineWidth=this._lineWidth,ctx.strokeStyle=this._strokeStyle,ctx.stroke())},set radius(radius){this._radius=radius,this.volume.resize(2*radius,2*radius),this.updateTotalOffset()},get radius(){return this._radius},_radius:20}),meta.class("Entity.Gradient","Entity.Geometry",{init:function(){this.clear()},draw:function(ctx){ctx.fillStyle=this._gradient,ctx.fillRect(0|this.volume.minX,0|this.volume.minY,0|this.volume.width,0|this.volume.height)},clear:function(){this._gradient=meta.engine.ctx.createLinearGradient(0,0,0,this.volume.height),this._points=[]},colorStops:function(buffer){for(var gradient=meta.engine.ctx.createLinearGradient(0,0,0,this.volume.height),num=buffer.length,i=0;i<num;i+=2)gradient.addColorStop(buffer[i],buffer[i+1]);this._gradient=gradient,this.renderer.needDraw=!0},_updateResize:function(){this._gradient=meta.engine.ctx.createLinearGradient(0,0,0,this.volume.height),this._super()},set gradient(gradient){gradient||(gradient=meta.engine.ctx.createLinearGradient(0,0,0,this.volume.height)),this._gradient=gradient,this.renderer.needDraw=!0},get gradient(){return this._gradient},Point:function(point,hex){this.point=point,this.hex=hex},_gradient:null,_points:null}),meta.class("Physics.Manager",{init:function(){this.bodies=[],this.bodiesRemove=[],this.manifold=new this.Manifold,this.start(),meta.renderer.onRenderDebug.add(this.renderDebug,this)},update:function(tDelta){this.bodiesRemove.length>0&&this.removeBodies();for(var body1=null,body2=null,numBodies=this.bodies.length,i=0;i<numBodies;i++)(body1=this.bodies[i]).step(tDelta),body1.worldBounds&&this.bodyVsWorld(body1);var owner,n=0;for(i=0;i<numBodies;i++){for(body1=this.bodies[i],n=i+1;n<numBodies;n++)body2=this.bodies[n],0===body1._mass&&0===body2._mass||this.bodyVsBody(body1,body2)&&(body1.colliding=!0,body2.colliding=!0,body1.onCollision&&(this.manifold.entity=body2.owner,body1.onCollision(this.manifold)),body2.onCollision&&(this.manifold.entity=body1.owner,body2.onCollision(this.manifold)));(owner=body1.owner).position(body1.volume.x-owner.totalOffsetX,body1.volume.y-owner.totalOffsetY)}},bodyVsWorld:function(body){for(var volume,volumes=meta.world.volumes,num=volumes.length,n=0;n<num;n++)(volume=volumes[n])!==body.volume&&(0===volume.type?this.bodyVsWorldBox(body,volume):this.bodyVsWorldCircle(body,volume))},bodyVsWorldBox:function(body,worldVolume){meta.world;var volume=body.volume,newX=volume.x,newY=volume.y,colliding=!1;volume.minX<worldVolume.minX?(newX=worldVolume.minX+(volume.x-volume.minX),this.manifold.normal.x=1,colliding=!0,body.bouncing?body.velocity.x*=-1:body.velocity.x=0):volume.maxX>worldVolume.maxX?(newX+=worldVolume.maxX-volume.maxX,this.manifold.normal.x=-1,colliding=!0,body.bouncing?body.velocity.x*=-1:body.velocity.x=0):this.manifold.normal.x=0,volume.minY<worldVolume.minY?(newY=worldVolume.minY+(volume.y-volume.minY),this.manifold.normal.y=1,colliding=!0,body.bouncing?body.velocity.y*=-1:body.velocity.y=0):volume.maxY>worldVolume.maxY?(newY+=worldVolume.maxY-volume.maxY,this.manifold.normal.y=-1,colliding=!0,body.bouncing?body.velocity.y*=-1:body.velocity.y=0):this.manifold.normal.y=0,colliding&&(volume.position(newX,newY),body.onCollision&&(this.manifold.entity=null,body.onCollision.call(body,this.manifold)))},bodyVsWorldCircle:function(body){var dx=shape.x-volume.x,dy=shape.y-volume.y,r=shape.radius-volume.radius,lengthSquared=dx*dx+dy*dy;if(lengthSquared>=r*r){var length=Math.sqrt(lengthSquared);0!==length?(this.manifold.penetration=r-length,this.manifold.normal.x=-dx/length,this.manifold.normal.y=-dy/length):(this.manifold.penetration=volume1.radius,this.manifold.normal.x=1,this.manifold.normal.y=0),volume.move(this.manifold.penetration*this.manifold.normal.x,this.manifold.penetration*this.manifold.normal.y);var value=body.velocity.dot(this.manifold.normal);body.velocity.x-=2*value*this.manifold.normal.x,body.velocity.y-=2*value*this.manifold.normal.y}},boxVsCircle_world:function(body){},circleVsCircle_world:function(body){},bodyVsBody:function(body1,body2){var type1=body1.volume.type,type2=body2.volume.type;if(0===type1){if(0===type2)return this.boxVsBox(body1,body2);if(1===type2)return this.boxVsCircle(body1,body2)}else if(1===type1){if(0===type2)return this.boxVsCircle(body2,body1);if(1===type2)return this.circleVsCircle(body1,body2)}return!1},boxVsBox:function(body1,body2){var volume1=body1.volume,volume2=body2.volume,diffX=volume2.minX+volume2.halfWidth-(volume1.minX+volume1.halfWidth),overlapX=volume1.halfWidth+volume2.halfWidth-Math.abs(diffX);if(overlapX<=0)return!1;var diffY=volume2.minY+volume2.halfHeight-(volume1.minY+volume1.halfHeight),overlapY=volume1.halfHeight+volume2.halfHeight-Math.abs(diffY);return!(overlapY<=0)&&(overlapX<overlapY?(diffX<0?this.manifold.normal.set(-1,0):this.manifold.normal.set(1,0),this.manifold.penetration=overlapX):(diffY<0?this.manifold.normal.set(0,-1):this.manifold.normal.set(0,1),this.manifold.penetration=overlapY),0===body2._mass&&volume1.move(-this.manifold.penetration*this.manifold.normal.x,-this.manifold.penetration*this.manifold.normal.y),0===body1._mass&&volume2.move(this.manifold.penetration*this.manifold.normal.x,this.manifold.penetration*this.manifold.normal.y),!0)},circleVsCircle:function(body1,body2){var volume1=body1.volume,volume2=body2.volume,dx=volume2.x-volume1.x,dy=volume2.y-volume1.y,r=volume1.radius+volume2.radius,lengthSquared=dx*dx+dy*dy;if(lengthSquared>r*r)return!1;var length=Math.sqrt(lengthSquared);0!==length?(this.manifold.penetration=r-length,this.manifold.normal.x=-dx/length,this.manifold.normal.y=-dy/length):(this.manifold.penetration=volume1.radius,this.manifold.normal.x=1,this.manifold.normal.y=0);var massUnit=1/(body1._mass+body2._mass),penetration=this.manifold.penetration*(body1._mass*massUnit);return volume1.move(penetration*this.manifold.normal.x,penetration*this.manifold.normal.y),body1.velocity.reflect(this.manifold.normal),this.manifold.normal.x=-this.manifold.normal.x,this.manifold.normal.y=-this.manifold.normal.y,penetration=this.manifold.penetration*(body2._mass*massUnit),volume2.move(penetration*this.manifold.normal.x,penetration*this.manifold.normal.y),body2.velocity.reflect(this.manifold.normal),!0},boxVsCircle:function(body1,body2){var volume1=body1.volume,volume2=body2.volume,diffX=volume2.x-(volume1.minX+volume1.halfWidth),diffY=volume2.y-(volume1.minY+volume1.halfHeight),extentX=.5*(volume1.maxX-volume1.minX),extentY=.5*(volume1.maxY-volume1.minY),closestX=Math.min(Math.max(diffX,-extentX),extentX),closestY=Math.min(Math.max(diffY,-extentY),extentY);if(diffX===closestX&&diffY===closestY)Math.abs(diffX)>Math.abs(diffY)?(this.manifold.normal.y=0,diffX<0?(this.manifold.normal.x=-1,this.manifold.penetration=volume1.halfWidth+diffX+volume2.radius):(this.manifold.normal.x=1,this.manifold.penetration=volume1.halfWidth-diffX+volume2.radius)):(this.manifold.normal.x=0,diffY<0?(this.manifold.normal.y=-1,this.manifold.penetration=volume1.halfHeight+diffY+volume2.radius):(this.manifold.normal.y=1,this.manifold.penetration=volume1.halfHeight-diffY+volume2.radius));else{var normalX=diffX-closestX,normalY=diffY-closestY,length=normalX*normalX+normalY*normalY;if(length>volume2.radius*volume2.radius)return!1;this.manifold.penetration=Math.sqrt(length)-volume2.radius,this.manifold.normal.x=-normalX,this.manifold.normal.y=-normalY,this.manifold.normal.normalize()}var massUnit=1/(body1._mass+body2._mass),penetration=this.manifold.penetration*(body1._mass*massUnit);return volume1.move(penetration*-this.manifold.normal.x,penetration*-this.manifold.normal.y),penetration=this.manifold.penetration*(body2._mass*massUnit),volume2.move(penetration*this.manifold.normal.x,penetration*this.manifold.normal.y),body1.bouncing&&body1.velocity.reflect(this.manifold.normal),body2.bouncing&&body2.velocity.reflect(this.manifold.normal),!0},renderDebug:function(renderer){if(0!==this.bodies.length){var ctx=renderer.ctx,zoom=meta.camera._zoom,cameraVolume=meta.camera.volume;ctx.save(),ctx.setTransform(zoom,0,0,zoom,-Math.floor(cameraVolume.x*zoom),-Math.floor(cameraVolume.y*zoom)),ctx.fillStyle=this.debugColor,ctx.globalAlpha=.8;for(var body,entity,entities=renderer.entities,num=entities.length,n=0;n<num;n++)0!=((entity=entities[n]).flags&entity.Flag.RENDER)&&(body=entities[n].components.Body)&&this.drawVolume(ctx,body.volume);ctx.restore()}},drawVolume:function(ctx,volume){0===volume.type?ctx.fillRect(Math.floor(volume.minX),Math.floor(volume.minY),Math.ceil(volume.width),Math.ceil(volume.height)):1===volume.type&&(ctx.beginPath(),ctx.arc(Math.floor(volume.x),Math.floor(volume.y),volume.radius,0,2*Math.PI,!1),ctx.fill())},add:function(body){body?-1===body.__index?(body.__index=this.bodies.length,this.bodies.push(body)):console.warn("(Physics) Body is already in use"):console.warn("(Physics) Invalid body passed")},remove:function(body){if(body)if(-1!==body.__index)if(this.stopped){var num=this.bodies.length-1,tmpBody=this.bodies[num];body!==tmpBody&&(tmpBody.__index=body.__index,this.bodies[body.__index]=tmpBody),body.__index=-1,this.bodies.length=num}else this.bodiesRemove.push(body);else console.warn("(Physics) Body is not in use");else console.warn("(Physics) Invalid body passed")},removeBodies:function(){for(var body,tmpBody,numRemove=this.bodiesRemove.length,num=this.bodies.length,n=0;n<numRemove;n++)(body=this.bodiesRemove[n])!==(tmpBody=this.bodies[num-1])&&(tmpBody.__index=body.__index,this.bodies[body.__index]=tmpBody),body.__index=-1,num--;this.bodies.length=num,this.bodiesRemove.length=0,console.log(num)},start:function(){this.stopped=!1,meta.engine.onUpdate.add(this.update,this)},stop:function(){this.stopped=!0,this.removeBodies(),meta.engine.onUpdate.remove(this)},Manifold:function(){this.entity=null,this.normal=new meta.math.Vector2(0,0),this.penetration=0},bodies:null,bodiesRemove:null,gravity:new meta.math.Vector2(0,0),wind:new meta.math.Vector2(0,0),friction:25,manifold:null,_relativeVel:new meta.math.Vector2(0,0),_impulseX:0,_impulseY:0,_percent:.8,_slop:.01,debugColor:"#00ff00",stopped:!1}),meta.component("Physics.Body",{onAdd:function(){this.velocity=new meta.math.Vector2(0,0),this.acceleration=new meta.math.Vector2(0,0),this.speed=new meta.math.Vector2(0,0),this._volume=this.owner.volume},onActiveEnter:function(){meta.physics.add(this)},onActiveExit:function(){meta.physics.remove(this)},step:function(tDelta){this.colliding=!1,this.volume.position(this.owner.volume.x,this.owner.volume.y),this.haveTarget&&(meta.math.length(this.volume.x,this.volume.y,this.targetX,this.targetY)<=this.speed*tDelta?(this.volume.position(this.targetX,this.targetY),this.stop()):(this._vec.x=this.targetX-this.volume.x,this._vec.y=this.targetY-this.volume.y,this._vec.normalize(),this.velocity.x=this._vec.x*this.speed,this.velocity.y=this._vec.y*this.speed)),this.velocity.x+=this.acceleration.x*tDelta,this.velocity.y+=this.acceleration.y*tDelta,this.volume.move(this.velocity.x*tDelta,this.velocity.y*tDelta),this.acceleration.x=0,this.acceleration.y=0},applyForce:function(vec){this.acceleration.x+=vec.x/this.invMass,this.acceleration.y+=vec.y/this.invMass},moveTo:function(x,y,speed,moveToCB){this.targetX=x,this.targetY=y,this.haveTarget=!0,this.speed=speed||600,this.moveToCB=moveToCB||null},stop:function(){this.speed=0,this.velocity.x=0,this.velocity.y=0,this.haveTarget&&(this.haveTarget=!1,this.moveToCB&&(this.moveToCB.call(this.owner),this.moveToCB=null)),this.onStop&&this.onStop.call(this.owner)},onStop:null,set volume(volume){volume instanceof meta.math.Circle?this.type=1:this.type=0,this._volume=volume,this._volume.position(this.owner.volume.x,this.owner.volume.y)},get volume(){return this._volume},set mass(value){this._mass=value,this.invMass=0===value?0:1/value},get mass(){return this._mass},type:0,_volume:null,_mass:1,invMass:1,restitution:.6,velocity:null,moveX:0,moveY:0,worldBounds:!1,ghost:!1,bouncing:!1,colliding:!1,targetX:0,targetY:0,haveTarget:!1,moveToCB:null,maxSpeed:Number.MAX_VALUE,acceleration:null,accelerationMod:1,_vec:new meta.math.Vector2(0,0),__index:-1}),meta.class("Steering.Manager",{init:function(){this.agents=[],meta.engine.onUpdate.add(this.update,this)},update:function(tDelta){for(var num=this.agents.length,n=0;n<num;n++)this.agents[n].update(tDelta)},add:function(agent){this.agents.push(agent)},agents:null}),function(){Steering.Component=function(){this.vel=new meta.math.Vector2(0,0),this.accel=new meta.math.Vector2(0,0),this.target=new meta.math.Vector2(0,0),this.f=3,this.maxSpeed=4,this.maxForce=.1},Steering.Component.prototype={onActiveEnter:function(){meta.steering.add(this)},update:function(tDelta){this.arrive(),this.vel.addVec(this.accel),this.vel.limit(this.maxSpeed),this.owner.move(this.vel.x,this.vel.y),this.owner.angleRad=this.vel.heading(),this.accel.mulValue(0)},seek:function(){var volume=this.owner.volume,desired=new meta.math.Vector2(this.target.x-volume.x,this.target.y-volume.y);desired.normalize(),desired.mulValue(this.maxSpeed);var steer=new meta.math.Vector2(desired.x-this.vel.x,desired.y-this.vel.y);steer.limit(this.maxForce),this.accel.addVec(steer)},arrive:function(){var volume=this.owner.volume,desired=new meta.math.Vector2(this.target.x-volume.x,this.target.y-volume.y),d=desired.length();if(desired.normalize(),d<100){var m=map(d,0,100,0,this.maxSpeed);desired.mulValue(m)}else desired.mulValue(this.maxSpeed);var steer=new meta.math.Vector2(desired.x-this.vel.x,desired.y-this.vel.y);steer.limit(this.maxForce),this.accel.addVec(steer)}};var map=function(value,istart,istop,ostart,ostop){return ostart+(value-istart)/(istop-istart)*(ostop-ostart)}}(),meta.class("UI.Controller","meta.Controller",{onFirstReady:function(){var buttonTex=new Resource.Texture;buttonTex.fillRect({color:"#111",width:120,height:30});var buttonOnHoverTex=new Resource.Texture;buttonOnHoverTex.fillRect({color:"#ff0000",width:120,height:30}),this.coreStyle={button:{"*:hover":{cursor:"pointer"},"*:pressed, *:drag":{cursor:"pointer",offsetX:1,offsetY:1}},checkbox:{"*:hover":{cursor:"pointer"},"*:pressed, *:drag":{cursor:"pointer",offsetX:1,offsetY:1}}},this.style={button:{"*":{texture:buttonTex},"*:hover":{texture:buttonOnHoverTex,cursor:"pointer"},"*:pressed":{texture:buttonOnHoverTex,cursor:"pointer",offsetX:1,offsetY:1}},checkbox:{"*":{texture:buttonTex},"*:hover":{texture:buttonOnHoverTex,cursor:"pointer"},"*:pressed":{texture:buttonOnHoverTex,cursor:"pointer",offsetX:1,offsetY:1},"[off]":{texture:buttonTex},"[on]":{texture:buttonOnHoverTex}}}},coreStyle:null,style:null}),function(){function Button(arg){Entity.Geometry.call(this,arg),this._label=null}Button.prototype={onCreate:function(){this.picking=!0},onHoverEnter:function(data){meta.engine.cursor="pointer"},onHoverExit:function(data){meta.engine.cursor="auto"},onDown:function(){this.move(2,2)},onUp:function(){this.move(-2,-2)},_createLabel:function(text){text||(text=""),this._label=new Entity.Text(text),this._label.pivot(.5),this._label.anchor(.5),this._label.pickable=!1,this._label.size=12,this._label.color="#ffffff",this.attach(this._label)},set text(str){this._label?this._label.text=str:this._createLabel(str)},get text(){return this._label?this._label.text:""},get label(){return this._label||this._createLabel(),this._label}},_inherits(Button,Entity.Geometry),modules[63]=Button,window.UI={Button:Button}}(),meta.class("UI.Checkbox","Entity.Geometry",{_initParams:function(params){this.style=params?meta.createStyle(params,UI.ctrl.coreStyle.checkbox):UI.ctrl.style.checkbox;var self=this,entity=new Entity.Geometry;entity.style=this._style.childStyle,entity.anchor(.5),entity.pickable=!1,entity.onChange=function(){self._onChildChange(this)},this.attach(entity),this.state="off",this._onClick=this.toggle},toggle:function(){var child=this.children[0];this.group?child.state="on":"on"===child.state?child.state="off":child.state="on"},_onChange:function(){this.children[0].state=this._state,this.group&&"on"===this._state&&this.group._onStateChange(this)},_onChildChange:function(child){this.state=this.children[0]._state},set checked(value){this.state=value?"on":"off"},get checked(){return"on"===this._state},set text(str){this._text?this._text.setText(str):(this._text=new Entity.Text(str),this._text.size=12,this._text.color="#ffffff",this.attach(this._text),this._text.anchor(.5),this._text.pickable=!1)},get text(){return this._text?this._text._text:""},_text:null,group:null,value:""}),meta.class("UI.ProgressBar","Entity.Geometry",{init:function(texture,fillTexture){this._super(texture);var fill=new Entity.Geometry(fillTexture);this.attach(fill),this.updateUnits()},updateProgress:function(){var units=Math.floor(this._fillWidth/100*this._value);this.children[0].width=units},updateUnits:function(){var texture=this.children[0]._texture;texture._loaded&&(this._fillWidth=texture.fullWidth)},set min(value){this._min!==value&&(this._min=value,this.updateProgress())},set max(value){this._max!==value&&(this._max=value,this.updateProgress())},set value(value){value<this._min?value=this._min:value>this._max&&(value=this._max),this._value!==value&&(this._value=value,this.updateProgress())},set percents(percents){this._max,this._min},get min(){return this._min},get max(){return this._max},get value(){return this._value},get percents(){return this._percents},set fillTexture(fillTexture){this.children[0].texture=fillTexture,this.updateProgress()},get fillTexture(){return this.children[0]._texture},_min:0,_max:100,_value:100,_unit:1,_fillWidth:1}),meta.class("UI.Group","Entity.Geometry",{add:function(entity){entity.group&&entity.detach(),this.children||(entity.state="on",this._value=entity.value),this.attach(entity),entity.group=this},_onStateChange:function(entity){this.prevValue=this._value,this._value=entity.value;for(var numChildren=this.children.length,i=0;i<numChildren;i++)this.children[i]!==entity&&(this.children[i].state="off");this.onChange(this)},set value(_value){if(this.children)for(var numChildren=this.children.length,n=0;n<numChildren;n++)if(this.children[n].value===_value){this.children[n].state="on";break}},get value(){return this._value},prevValue:"",_value:""}),function(){function Tab(arg){Entity.Geometry.call(this,arg),this._textureOn=null,this._textureOff=null,this._checked=!1,this.picking=!0}Tab.prototype={updateState:function(){this.texture=this.checked?this._textureOn:this._textureOff},onClick:function(){this.checked=!0,this.updateState()},set textureOn(texture){this._textureOn!==texture&&(this._textureOn=texture,this.updateState())},get textureOn(){return this._textureOn},set textureOff(texture){this._textureOff!==texture&&(this._textureOff=texture,this.updateState())},get textureOff(){return this._textureOff},set checked(value){this._checked!==value&&(this._checked=value,this.updateState(),this.emit("change",value))},get checked(){return this._checked}},_inherits(Tab,Entity.Geometry),modules[67]=Tab}(),meta.Tween=function(){this.cache=null,this.chain=[]},meta.Tween.prototype={play:function(){if(this.cache){var cache=this.cache;if(!cache.owner)return this;if(cache.owner.removed)return this;cache.paused=!1,cache.numRepeat=this.numRepeat,this.next(),this._play()}else this.autoPlay=!0;return this},_play:function(){-1===this.cache.__index&&(this.cache.__index=meta.renderer.tweens.push(this.cache)-1,this._group&&this._group.activeUsers++)},stop:function(callCB){if(-1!==this.cache.__index)return this.cache.link=null,this.cache.index=0,meta.renderer.tweensRemove.push(this.cache),this.cache.__index=-1,callCB&&callCB(this.cache.owner),this._group&&0===--this._group.activeUsers&&this._group.callback&&this._group.callback(),this},paused:function(value){return void 0===value&&(value=!0),this.cache.paused=value,this},resume:function(){return this.cache.paused=!1,this},clear:function(){return this.stop(null),this.chain.length=0,this._group&&(this._group.users--,this._group=null),this},reset:function(){var cache=this.cache;if(cache.index=0,cache.link=this.chain[0],!cache.link)return this;for(var key in cache.link.startValues)cache.owner[key]=cache.link.startValues[key];return this.stop(!1),this},next:function(){var repeating=!1,cache=this.cache;if(cache.index===this.chain.length){if(0===cache.numRepeat)return this.stop(),this.onDone&&this.onDone.call(this.cache),this;if(cache.index=0,-1!==cache.numRepeat&&(cache.numRepeat--,0===cache.numRepeat))return this.stop(),this.onDone&&this.onDone.call(this.cache),this;repeating=!0}cache._done=!1;var key,link=this.chain[cache.index++],owner=cache.owner;if(repeating)for(key in link.startValues)owner[key]=link.startValues[key];else for(key in link.endValues)link.startValues[key]=owner[key];return link._onStart&&link._onStart.call(this),cache._tStart=meta.time.current,cache._tFrame=0,cache.link=link,this},repeat:function(numRepeat){return void 0===numRepeat&&(numRepeat=-1),this.numRepeat=numRepeat,this},set reverse(value){return void 0===value&&(value=!0),this.cache.reverse=value,this},get reverse(){return this.cache.reverse},update:function(tDelta){var cache=this.cache;if(cache.link){cache._tFrame+=meta.time.delta;var link=cache.link,tElapsed=(meta.time.current-cache._tStart)/link.duration;if(tElapsed>1&&(tElapsed=1),cache._done){if(cache.tFrameDelay<link.tDelay)return}else link.endValues&&(link.update(tElapsed),link._onTick&&link._onTick.call(this.cache));if(1===tElapsed){if(!cache._done)return void(cache._done=!0);link._onDone&&link._onDone.call(this.cache),this.next()}}else this.stop(!1)},to:function(endValues,duration,onDone){var link=new meta.Tween.Link(this,endValues,duration,onDone);return this.chain.push(link),link},wait:function(duration,onDone){var link=new meta.Tween.Link(this,null,duration,onDone);return this.chain.push(link),link},group:function(group){return group?this._group?(console.warn("(meta.Tween.group) Tween already is part of a group."),this):("object"==typeof group&&(this._group=group),this._group.users++,this):(console.warn("(meta.Tween.group) No group name specified."),this)},autoPlay:!1,_group:null,_removeFlag:0,numRepeat:0},meta.Tween.Cache=function(owner){this.owner=owner,this.tween=null,this.link=null,this.index=0,this.numRepeat=0,this._tStart=0,this._tFrame=0,this.onDone=null,this._done=!1,this.__index=-1},meta.Tween.Cache.prototype={update:function(tDelta){this.tween.cache=this,this.tween.update(tDelta),this.tween.cache=null},stop:function(){this.tween.cache=this,this.tween.stop(),this.tween.cache=null},paused:!1,reverse:!1,_flags:0},meta.Tween.Group=function(name,callback){"function"==typeof name&&(callback=name,name=""),this.name=name,this.users=0,this.activeUsers=0,this.callback=callback||null},meta.Tween.Easing={linear:function(k){return k},quadIn:function(k){return k*k},quadOut:function(k){return k*(2-k)},quadInOut:function(k){return(k*=2)<1?.5*k*k:-.5*(--k*(k-2)-1)},cubicIn:function(k){return k*k*k},cubicOut:function(k){return--k*k*k+1},cubicInOut:function(k){return(k*=2)<1?.5*k*k*k:.5*((k-=2)*k*k+2)},quartIn:function(k){return k*k*k*k},quartOut:function(k){return 1- --k*k*k*k},quartInOut:function(k){return(k*=2)<1?.5*k*k*k*k:-.5*((k-=2)*k*k*k-2)},quintIn:function(k){return k*k*k*k*k},quintOut:function(k){return--k*k*k*k*k+1},quintIntOut:function(k){return(k*=2)<1?.5*k*k*k*k*k:.5*((k-=2)*k*k*k*k+2)},sineIn:function(k){return 1-Math.cos(k*Math.PI/2)},sineOut:function(k){return Math.sin(k*Math.PI/2)},sineIntOut:function(k){return.5*(1-Math.cos(Math.PI*k))},expoIn:function(k){if(0!==k)return Math.pow(1024,k-1)},expoOut:function(k){return 1===k?1:1-Math.pow(2,-10*k)},expoInOut:function(k){if(0!==k)return 1===k?1:(k*=2)<1?.5*Math.pow(1024,k-1):.5*(2-Math.pow(2,-10*(k-1)))},circIn:function(k){return 1-Math.sqrt(1-k*k)},circOut:function(k){return Math.sqrt(1- --k*k)},circInOut:function(k){return(k*=2)<1?-.5*(Math.sqrt(1-k*k)-1):.5*(Math.sqrt(1-(k-=2)*k)+1)},elasticIn:function(k){var s,a=.1;if(0!==k)return 1===k?1:(!a||a<1?(a=1,s=.1):s=.4*Math.asin(1/a)/(2*Math.PI),-a*Math.pow(2,10*(k-=1))*Math.sin((k-s)*(2*Math.PI)/.4))},elasticOut:function(k){var s,a=.1;if(0!==k)return 1===k?1:(!a||a<1?(a=1,s=.1):s=.4*Math.asin(1/a)/(2*Math.PI),a*Math.pow(2,-10*k)*Math.sin((k-s)*(2*Math.PI)/.4)+1)},elasticInOut:function(k){var s,a=.1;if(0!==k)return 1===k?1:(!a||a<1?(a=1,s=.1):s=.4*Math.asin(1/a)/(2*Math.PI),(k*=2)<1?a*Math.pow(2,10*(k-=1))*Math.sin((k-s)*(2*Math.PI)/.4)*-.5:a*Math.pow(2,-10*(k-=1))*Math.sin((k-s)*(2*Math.PI)/.4)*.5+1)},backIn:function(k){var s=1.70158;return k*k*((s+1)*k-s)},backOut:function(k){var s=1.70158;return--k*k*((s+1)*k+s)+1},backInOut:function(k){var s=2.5949095;return(k*=2)<1?k*k*((s+1)*k-s)*.5:.5*((k-=2)*k*((s+1)*k+s)+2)},bounceIn:function(k){return 1-meta.Tween.Easing.bounceOut(1-k)},bounceOut:function(k){return k<1/2.75?7.5625*k*k:k<2/2.75?7.5625*(k-=1.5/2.75)*k+.75:k<2.5/2.75?7.5625*(k-=2.25/2.75)*k+.9375:7.5625*(k-=2.625/2.75)*k+.984375},bounceInOut:function(k){return k<.5?.5*meta.Tween.Easing.bounceIn(2*k):.5*meta.Tween.Easing.bounceOut(2*k-1)+.5}},meta.Tween.Link=function(tween,endValues,duration,onDone){this.tween=tween,this.startValues={},this.endValues=endValues,this.duration=duration,this._onDone=onDone||null},meta.Tween.Link.prototype={play:function(){return this.tween.play(),this},stop:function(){return this.tween.stop(),this},paused:function(value){return this.tween.paused(value),this},resume:function(){return this.tween.resume(),this},clear:function(){return this.tween.clear(),this},reset:function(){return this.tween.reset(),this},update:function(tElapsed){var startValue,endValue,result,value=this._easing(tElapsed),owner=this.tween.cache.owner;for(var key in this.endValues)startValue=this.startValues[key],endValue=this.endValues[key],"string"==typeof startValue&&(endValue=startValue+parseFloat(endValue,4)),result=startValue+(endValue-startValue)*value,this.rounding&&(result=Math.round(result)),owner[key]=result},next:function(){return this.tween.next(),this},wait:function(duration,onDone){return this.tween.wait(duration,onDone)},frameDelay:function(tFrameDelay){return this.tFrameDelay=tFrameDelay,this},round:function(value){return void 0===value&&(value=!0),this.isRounding=value,this},repeat:function(numRepeat){return this.tween.repeat(numRepeat),this},reverse:function(value){return this.tween.reverse=value,this},easing:function(func){return this._easing="function"==typeof func?func:meta.Tween.Easing[func],void 0===this._easing&&(this._easing=meta.Tween.Easing.linear),this},onStart:function(func){return this._onStart=func,this},onDone:function(func){return this.tween.onDone=func,this},onTick:function(func){return this._onTick=func,this},to:function(endValues,duration,onDone){return this.tween.to(endValues,duration,onDone)},group:function(name){return this.tween.group(name)},_easing:meta.Tween.Easing.linear,_onStart:null,_onDone:null,_onTick:null,tFrameDelay:0,rounding:!1},meta.controller("meta.Loading",{onInit:function(){meta.preloading=this,meta.loading=this},onFirstLoad:function(){this.view.z=Number.MAX_SAFE_INTEGER-10,this.view.static=!0;var bgTexture=new Resource.SVG;bgTexture.fillStyle="#030303",bgTexture.fillRect(0,0,1,1),this.bg=new Entity.Geometry(bgTexture),this.bg.fitIn(meta.camera.width,meta.camera.height),this.view.attach(this.bg);var progressShadowTexture=new Resource.SVG;progressShadowTexture.fillStyle="#222",progressShadowTexture.fillRect(0,0,100,4);var progressShadow=new Entity.Geometry(progressShadowTexture);progressShadow.pivot(.5),progressShadow.anchor(.5),this.view.attach(progressShadow);var progressTexture=new Resource.SVG;progressTexture.fillStyle="white",progressTexture.fillRect(0,0,100,4),this.progress=new Entity.Geometry(progressTexture),this.progress.clipBounds(0,4),this.progress.pivot(.5),this.progress.anchor(.5),this.view.attach(this.progress)},onLoad:function(){meta.camera.onResize.add(this.onResize,this),meta.resources.onLoadingUpdate.add(this.onResourceLoaded,this)},onUnload:function(){meta.camera.onResize.remove(this),meta.resources.onLoadingUpdate.remove(this)},onResize:function(data){this.bg.fitIn(data.width,data.height)},onResourceLoaded:function(mgr){var percents=Math.min(100/mgr.numTotalToLoad*(mgr.numTotalToLoad-mgr.numToLoad),100);this.progress.clipBounds(percents,4)},bg:null,progress:null}),meta.createEngine=function(){meta.onDomLoad(function(){meta.classLoaded(),meta.engine.autoInit&&meta.engine.create()})},meta.loadScript=function(src,onLoad){meta.engine&&meta.engine.isLoaded?meta._loadScript({s:src,c:onLoad}):(meta.cache.scripts||(meta.cache.scripts=[]),meta.cache.scripts.push({s:src,c:onLoad}))},meta._loadScript=function(obj){var script=document.createElement("script"),firstScript=document.scripts[0];"async"in firstScript?(script.async=!1,script.onload=obj.c,script.src=obj.s,document.head.appendChild(script)):firstScript.readyState?(meta.cache.pendingScripts||(meta.cache.pendingScripts=[]),meta.cache.pendingScripts.push(script),script.onreadystatechange=meta._onReadyStateChange,script.src=obj.s):document.write("<script src='"+src+"' defer><\/script>")},meta._onReadyStateChange=function(){for(var pendingScript,pendingScripts=meta.cache.pendingScripts;pendingScripts[0]&&"loaded"===pendingScripts[0].s.readyState;)(pendingScript=pendingScripts.shift()).s.onreadystatechange=null,document.scripts[0].parentNode.insertBefore(pendingScript.s,firstScript),pendingScript.c&&pendingScript.c()},meta._loadAllScripts=function(){var scripts=meta.cache.scripts;if(!scripts)return!1;var numScripts=scripts.length;if(0===numScripts)return!1;var script,callback=function(){var cache=meta.cache;cache.numScriptsToLoad--;var scripts=meta.cache.scripts,numScripts=scripts.length;if(numScripts>0){cache.numScriptsToLoad+=numScripts,cache.scripts=[];for(var script,n=0;n<numScripts;n++)(script=scripts[n]).c=callback,meta._loadScript(script)}0===cache.numScriptsToLoad&&(cache.scripts=null,meta.engine.onScriptLoadingEnd())},cache=meta.cache;cache.numScriptsToLoad+=scripts.length,cache.scripts=[];for(var i=0;i<numScripts;i++)(script=scripts[i]).c=callback,meta._loadScript(script);return!0},meta.import=function(path){if(path){path.split("/")[0];meta.isUrl(path)||(path=meta.importUrl+path+"/"+path+".js"),meta.loadScript(path,null)}},meta.createEngine(),function(){var Button=modules[63],Tab=modules[67];modules[0]={Tab:Tab,Text:Text,Button:Button}}();